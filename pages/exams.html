<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Exams & Grades</title>
	<link rel="stylesheet" href="../style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		* { box-sizing: border-box; margin: 0; padding: 0; }
		body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }

		.page-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 24px;
			flex-wrap: wrap;
			gap: 16px;
		}
		.page-title-section h1 { font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
		.page-title-section p { font-size: 14px; color: #64748b; }
		.header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
		.btn {
			padding: 12px 20px;
			border-radius: 10px;
			font-weight: 600;
			font-size: 14px;
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			transition: all 0.2s;
			border: none;
		}
		.btn-primary { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
		.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
		.btn-outline { background: white; border: 2px solid #e2e8f0; color: #64748b; }
		.btn-outline:hover { border-color: #f59e0b; color: #f59e0b; }
		.btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
		.btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
		.btn-sm { padding: 8px 14px; font-size: 13px; }

		.stats-row {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 20px;
			margin-bottom: 24px;
		}
		.stat-card {
			background: white;
			border-radius: 16px;
			padding: 20px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			display: flex;
			align-items: center;
			gap: 16px;
		}
		.stat-icon {
			width: 56px;
			height: 56px;
			border-radius: 14px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 24px;
		}
		.stat-icon.orange { background: #fffbeb; color: #f59e0b; }
		.stat-icon.green { background: #f0fdf4; color: #22c55e; }
		.stat-icon.blue { background: #eff6ff; color: #3b82f6; }
		.stat-icon.red { background: #fef2f2; color: #ef4444; }
		.stat-value { font-size: 28px; font-weight: 700; color: #1e293b; }
		.stat-label { font-size: 13px; color: #64748b; margin-top: 2px; }

		.table-card {
			background: white;
			border-radius: 16px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			overflow: hidden;
		}
		.table-toolbar {
			padding: 20px 24px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 1px solid #f1f5f9;
			flex-wrap: wrap;
			gap: 16px;
		}
		.search-box { position: relative; width: 300px; }
		.search-box input {
			width: 100%;
			height: 44px;
			padding: 0 16px 0 44px;
			border: 2px solid #e2e8f0;
			border-radius: 10px;
			font-size: 14px;
		}
		.search-box input:focus { outline: none; border-color: #f59e0b; }
		.search-box i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
		.toolbar-actions { display: flex; gap: 10px; flex-wrap: wrap; }

		.data-table { width: 100%; border-collapse: collapse; }
		.data-table thead { 
			background: linear-gradient(135deg, #f59e0b, #d97706);
			background-color: #f59e0b;
		}
		.data-table th {
			padding: 16px 20px;
			text-align: left;
			font-weight: 600;
			font-size: 13px;
			color: white;
			text-transform: uppercase;
			background: linear-gradient(135deg, #f59e0b, #d97706);
		}
		.data-table th:first-child { padding-left: 24px; }
		.data-table tbody tr { border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
		.data-table tbody tr:hover { background: #f8fafc; }
		.data-table td { padding: 16px 20px; font-size: 14px; color: #334155; vertical-align: middle; }
		.data-table td:first-child { padding-left: 24px; }

		.exam-id { font-weight: 700; color: #d97706; }
		.exam-icon {
			width: 44px;
			height: 44px;
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 18px;
			background: #fffbeb;
			color: #f59e0b;
		}
		.exam-info { display: flex; align-items: center; gap: 14px; }
		.exam-name { font-weight: 600; color: #1e293b; }
		.exam-subject { font-size: 12px; color: #64748b; }

		.status-badge {
			padding: 6px 14px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
		}
		.status-badge.scheduled { background: #dbeafe; color: #2563eb; }
		.status-badge.ongoing { background: #fef3c7; color: #d97706; }
		.status-badge.completed { background: #dcfce7; color: #16a34a; }
		.status-badge.cancelled { background: #fef2f2; color: #dc2626; }

		.checkbox-cell { width: 50px; }
		.custom-checkbox {
			width: 20px;
			height: 20px;
			border: 2px solid #cbd5e1;
			border-radius: 6px;
			cursor: pointer;
			accent-color: #f59e0b;
		}

		.action-btns { display: flex; gap: 8px; }
		.action-btn {
			width: 36px;
			height: 36px;
			border-radius: 8px;
			border: none;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
		}
		.action-btn.view { background: #eff6ff; color: #3b82f6; }
		.action-btn.edit { background: #f0fdf4; color: #22c55e; }
		.action-btn.delete { background: #fef2f2; color: #ef4444; }
		.action-btn:hover { transform: scale(1.1); }

		.table-footer {
			padding: 16px 24px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-top: 1px solid #f1f5f9;
		}
		.pagination-info { font-size: 14px; color: #64748b; }
		.pagination-btns { display: flex; align-items: center; gap: 8px; }
		.page-btn {
			width: 36px;
			height: 36px;
			border-radius: 8px;
			border: 2px solid #e2e8f0;
			background: white;
			color: #64748b;
			font-weight: 600;
			cursor: pointer;
		}
		.page-btn:hover:not(:disabled) { border-color: #f59e0b; color: #f59e0b; }
		.page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
		.page-select { height: 36px; padding: 0 12px; border: 2px solid #e2e8f0; border-radius: 8px; }

		.fab-btn {
			position: fixed;
			bottom: 30px;
			right: 30px;
			width: 60px;
			height: 60px;
			border-radius: 50%;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			border: none;
			box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
			cursor: pointer;
			font-size: 24px;
			z-index: 100;
			transition: all 0.3s;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.fab-btn:hover { transform: scale(1.1) rotate(90deg); }
		.fab-btn[style*="display: none"] { display: none !important; }

		.modal-overlay {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.5);
			backdrop-filter: blur(4px);
			z-index: 1000;
			align-items: center;
			justify-content: center;
			padding: 16px;
		}
		.modal-overlay.active { display: flex; }
		.modal-content {
			background: white;
			border-radius: 20px;
			width: 800px;
			max-width: 100%;
			max-height: 95vh;
			overflow-y: auto;
			animation: modalSlide 0.3s ease;
			display: flex;
			flex-direction: column;
		}
		@media (max-width: 768px) {
			.modal-overlay {
				padding: 8px;
				align-items: flex-start;
				padding-top: 20px;
			}
			.modal-content {
				width: 100%;
				max-width: 100%;
				max-height: calc(100vh - 40px);
				border-radius: 16px;
			}
		}
		@keyframes modalSlide { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
		.modal-header {
			padding: 24px;
			border-bottom: 1px solid #f1f5f9;
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-shrink: 0;
		}
		.modal-title { 
			font-size: 20px; 
			font-weight: 700; 
			color: #1e293b; 
			display: flex; 
			align-items: center; 
			gap: 12px; 
		}
		.modal-close {
			width: 40px;
			height: 40px;
			border-radius: 10px;
			border: none;
			background: #f1f5f9;
			cursor: pointer;
			flex-shrink: 0;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.modal-close:hover { background: #fef2f2; color: #ef4444; }
		.modal-body { 
			padding: 24px; 
			flex: 1;
			overflow-y: auto;
		}
		.modal-footer {
			padding: 20px 24px;
			border-top: 1px solid #f1f5f9;
			display: flex;
			justify-content: flex-end;
			gap: 12px;
			flex-shrink: 0;
		}
		@media (max-width: 768px) {
			.modal-header {
				padding: 18px 16px;
			}
			.modal-title {
				font-size: 18px;
				gap: 8px;
			}
			.modal-close {
				width: 36px;
				height: 36px;
			}
			.modal-body {
				padding: 20px 16px;
			}
			.modal-footer {
				padding: 16px;
				flex-direction: column-reverse;
				gap: 10px;
			}
			.modal-footer .btn {
				width: 100%;
				justify-content: center;
			}
		}

		/* Exam Filter Section in Modal */
		.exam-filter-section {
			background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 24px;
			border: 1px solid #e2e8f0;
		}
		.exam-filter-header {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-bottom: 16px;
		}
		@media (max-width: 768px) {
			.exam-filter-section {
				padding: 16px;
				margin-bottom: 20px;
			}
			.exam-filter-header {
				flex-direction: column;
				align-items: flex-start;
				gap: 12px;
			}
			.exam-filter-header h4 {
				font-size: 15px;
			}
		}
		.exam-filter-header i {
			width: 36px;
			height: 36px;
			border-radius: 8px;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 16px;
		}
		.exam-filter-header h4 {
			font-size: 16px;
			font-weight: 700;
			color: #1e293b;
			margin: 0;
		}
		.exam-filter-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 16px;
			margin-bottom: 16px;
		}
		@media (max-width: 768px) {
			.exam-filter-grid {
				grid-template-columns: 1fr;
				gap: 12px;
			}
		}
		.exam-filter-group {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}
		.exam-filter-label {
			font-size: 12px;
			font-weight: 700;
			color: #475569;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		.exam-filter-label .required {
			color: #ef4444;
		}
		.exam-filter-select {
			width: 100%;
			height: 46px;
			padding: 0 14px;
			border: 2px solid #e2e8f0;
			border-radius: 10px;
			font-size: 14px;
			font-weight: 500;
			color: #1e293b;
			background: white;
			cursor: pointer;
			transition: all 0.2s;
		}
		.exam-filter-select:hover {
			border-color: #cbd5e1;
		}
		.exam-filter-select:focus {
			outline: none;
			border-color: #f59e0b;
			box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
		}
		.load-subjects-btn {
			width: 100%;
			height: 46px;
			padding: 0 20px;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			border: none;
			border-radius: 10px;
			font-size: 14px;
			font-weight: 700;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			transition: all 0.3s;
			box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
		}
		.load-subjects-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
		}
		.load-subjects-btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
		}
		@media (max-width: 768px) {
			.load-subjects-btn {
				height: 44px;
				font-size: 15px;
				padding: 0 16px;
			}
		}
		.exam-filter-divider {
			height: 1px;
			background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
			margin: 20px 0;
		}

		/* Subject Marks Table */
		.subjects-marks-section {
			margin-top: 24px;
		}
		.subjects-marks-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 16px;
			gap: 12px;
		}
		.subjects-marks-title {
			font-size: 16px;
			font-weight: 700;
			color: #1e293b;
			display: flex;
			align-items: center;
			gap: 10px;
			flex: 1;
		}
		.subjects-marks-title i {
			color: #f59e0b;
		}
		.apply-same-marks-btn {
			padding: 8px 16px;
			background: #eff6ff;
			color: #2563eb;
			border: 2px solid #bfdbfe;
			border-radius: 8px;
			font-size: 13px;
			font-weight: 600;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 6px;
			transition: all 0.2s;
			white-space: nowrap;
		}
		.apply-same-marks-btn:hover {
			background: #dbeafe;
			border-color: #93c5fd;
		}
		@media (max-width: 768px) {
			.subjects-marks-header {
				flex-direction: column;
				align-items: stretch;
				gap: 12px;
			}
			.subjects-marks-title {
				font-size: 15px;
			}
			.apply-same-marks-btn {
				width: 100%;
				justify-content: center;
				padding: 10px 16px;
				font-size: 14px;
			}
		}
		.subjects-marks-table-container {
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
			border-radius: 12px;
			border: 1px solid #e2e8f0;
		}
		.subjects-marks-table {
			width: 100%;
			border-collapse: collapse;
			background: white;
			min-width: 500px;
		}
		@media (max-width: 768px) {
			.subjects-marks-table-container {
				margin: 0 -16px;
				border-left: none;
				border-right: none;
				border-radius: 0;
			}
			.subjects-marks-table {
				min-width: 100%;
			}
			.subjects-marks-table th,
			.subjects-marks-table td {
				padding: 12px 10px;
				font-size: 13px;
			}
			.subjects-marks-table th {
				font-size: 11px;
				padding: 10px 8px;
			}
		}
		.subjects-marks-table thead {
			background: linear-gradient(135deg, #f59e0b, #d97706);
		}
		.subjects-marks-table th {
			padding: 14px 16px;
			text-align: left;
			font-weight: 700;
			font-size: 12px;
			color: white;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		.subjects-marks-table tbody tr {
			border-bottom: 1px solid #f1f5f9;
			transition: all 0.2s;
		}
		.subjects-marks-table tbody tr:hover {
			background: #f8fafc;
		}
		.subjects-marks-table td {
			padding: 14px 16px;
			font-size: 14px;
		}
		.subject-name-cell {
			font-weight: 600;
			color: #1e293b;
		}
		.subject-marks-input {
			width: 100%;
			padding: 10px 12px;
			border: 2px solid #e2e8f0;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 600;
			text-align: center;
			transition: all 0.2s;
			-webkit-appearance: none;
			appearance: none;
		}
		.subject-marks-input:focus {
			outline: none;
			border-color: #f59e0b;
			box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
		}
		@media (max-width: 768px) {
			.subject-marks-input {
				padding: 12px 10px;
				font-size: 15px; /* Prevents zoom on iOS */
			}
		}
		.subjects-empty-state {
			text-align: center;
			padding: 40px 20px;
			color: #94a3b8;
		}
		.subjects-empty-state i {
			font-size: 48px;
			margin-bottom: 12px;
			opacity: 0.5;
		}
		.subjects-empty-state p {
			font-size: 14px;
			margin: 0;
		}

		.form-grid { 
			display: grid; 
			grid-template-columns: repeat(2, 1fr); 
			gap: 20px; 
		}
		.form-group { 
			display: flex; 
			flex-direction: column; 
			gap: 8px; 
		}
		.form-group.full { 
			grid-column: span 2; 
		}
		.form-label { 
			font-size: 13px; 
			font-weight: 600; 
			color: #475569; 
			text-transform: uppercase; 
		}
		.form-input, .form-select {
			height: 48px;
			padding: 0 16px;
			border: 2px solid #e2e8f0;
			border-radius: 10px;
			font-size: 15px;
			width: 100%;
			-webkit-appearance: none;
			appearance: none;
		}
		.form-input:focus, .form-select:focus { 
			outline: none; 
			border-color: #f59e0b; 
		}
		@media (max-width: 768px) {
			.form-grid {
				grid-template-columns: 1fr;
				gap: 16px;
			}
			.form-group.full {
				grid-column: span 1;
			}
			.form-input, .form-select {
				height: 44px;
				font-size: 16px; /* Prevents zoom on iOS */
				padding: 0 14px;
			}
			.form-label {
				font-size: 12px;
			}
		}

		.empty-state { text-align: center; padding: 60px 20px; }
		.empty-state i { font-size: 64px; color: #e2e8f0; margin-bottom: 20px; }
		.empty-state h3 { font-size: 20px; color: #475569; margin-bottom: 8px; }
		.empty-state p { color: #94a3b8; }

		/* Professional Tab Styling */
		.tabs-container {
			background: white;
			border-radius: 16px;
			padding: 6px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			display: flex;
			gap: 6px;
			margin-bottom: 24px;
			border: 1px solid #e2e8f0;
		}
		.tab-btn {
			flex: 1;
			padding: 14px 24px;
			border: none;
			background: transparent;
			border-radius: 12px;
			font-weight: 600;
			font-size: 14px;
			color: #64748b;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			position: relative;
		}
		.tab-btn:hover:not(.active) {
			background: #f8fafc;
			color: #475569;
		}
		.tab-btn.active {
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
			transform: translateY(-1px);
		}
		.tab-btn i {
			font-size: 15px;
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
			animation: fadeIn 0.3s ease;
		}
		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(10px); }
			to { opacity: 1; transform: translateY(0); }
		}

		/* Professional Filter Section */
		.marks-filter-section {
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			border-radius: 16px;
			padding: 24px;
			margin-bottom: 24px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			border: 1px solid #e2e8f0;
		}
		.marks-filter-header {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-bottom: 20px;
			padding-bottom: 16px;
			border-bottom: 2px solid #f1f5f9;
		}
		.marks-filter-header i {
			width: 40px;
			height: 40px;
			border-radius: 10px;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 18px;
		}
		.marks-filter-header h3 {
			font-size: 18px;
			font-weight: 700;
			color: #1e293b;
			margin: 0;
		}
		.marks-filter-header p {
			font-size: 13px;
			color: #64748b;
			margin: 0;
		}
		.marks-filter-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 20px;
		}
		.marks-filter-group {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		.marks-filter-label {
			font-size: 12px;
			font-weight: 700;
			color: #475569;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			display: flex;
			align-items: center;
			gap: 6px;
		}
		.marks-filter-label .required {
			color: #ef4444;
		}
		.marks-filter-select {
			width: 100%;
			height: 50px;
			padding: 0 16px;
			border: 2px solid #e2e8f0;
			border-radius: 12px;
			font-size: 15px;
			font-weight: 500;
			color: #1e293b;
			background: white;
			cursor: pointer;
			transition: all 0.2s;
		}
		.marks-filter-select:hover {
			border-color: #cbd5e1;
		}
		.marks-filter-select:focus {
			outline: none;
			border-color: #f59e0b;
			box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
		}
		.marks-info-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 16px 20px;
			background: linear-gradient(135deg, #eff6ff, #dbeafe);
			border-radius: 12px;
			margin-top: 20px;
			border: 1px solid #bfdbfe;
		}
		.marks-info-text {
			display: flex;
			align-items: center;
			gap: 16px;
			font-size: 14px;
			color: #1e40af;
			font-weight: 600;
		}
		.marks-info-item {
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.marks-info-item i {
			font-size: 16px;
		}

		/* Professional Marks Input */
		.marks-input {
			width: 100%;
			padding: 12px 16px;
			border: 2px solid #e2e8f0;
			border-radius: 10px;
			font-size: 15px;
			font-weight: 700;
			text-align: center;
			transition: all 0.2s;
			background: white;
			color: #1e293b;
		}
		.marks-input:hover:not(:disabled) {
			border-color: #cbd5e1;
			background: #f8fafc;
		}
		.marks-input:focus {
			outline: none;
			border-color: #f59e0b;
			box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
			background: white;
		}
		.marks-input.invalid {
			border-color: #ef4444;
			background: #fef2f2;
			color: #dc2626;
		}
		.marks-input:disabled {
			background: #f3f4f6;
			color: #9ca3af;
			cursor: not-allowed;
		}

		/* Professional Attendance Select */
		.attendance-select {
			width: 100%;
			padding: 12px 16px;
			border: 2px solid #e2e8f0;
			border-radius: 10px;
			font-size: 14px;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.2s;
			text-align: center;
		}
		.attendance-select:focus {
			outline: none;
			box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
		}
		.attendance-select.absent {
			background: linear-gradient(135deg, #fee2e2, #fecaca);
			color: #dc2626;
			border-color: #fca5a5;
		}
		.attendance-select.absent:hover {
			background: linear-gradient(135deg, #fecaca, #fca5a5);
		}
		.attendance-select.present {
			background: linear-gradient(135deg, #dcfce7, #bbf7d0);
			color: #16a34a;
			border-color: #86efac;
		}
		.attendance-select.present:hover {
			background: linear-gradient(135deg, #bbf7d0, #86efac);
		}

		/* Professional Table Styling */
		.marks-table-card {
			background: white;
			border-radius: 16px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			overflow: hidden;
			border: 1px solid #e2e8f0;
		}
		.marks-table-header {
			background: linear-gradient(135deg, #f59e0b, #d97706);
		}
		.marks-table-header th {
			padding: 18px 20px;
			text-align: left;
			font-weight: 700;
			font-size: 12px;
			color: white;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		.marks-row {
			transition: all 0.2s;
			border-bottom: 1px solid #f1f5f9;
		}
		.marks-row:hover {
			background: #f8fafc;
			transform: translateX(2px);
		}
		.marks-row.absent-row {
			background: linear-gradient(90deg, #fef2f2, #fee2e2);
			opacity: 0.85;
		}
		.marks-row.absent-row:hover {
			background: linear-gradient(90deg, #fee2e2, #fecaca);
		}
		.marks-row td {
			padding: 16px 20px;
			vertical-align: middle;
		}
		.marks-row td:first-child {
			text-align: center;
			font-weight: 700;
			color: #64748b;
			font-size: 14px;
		}
		.marks-student-id {
			font-weight: 700;
			color: #d97706;
			font-size: 13px;
			letter-spacing: 0.3px;
		}
		.marks-student-name {
			font-weight: 600;
			color: #1e293b;
			font-size: 15px;
		}

		/* Professional Save Button */
		.save-all-marks-btn {
			padding: 14px 28px;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			border: none;
			border-radius: 12px;
			font-weight: 700;
			font-size: 15px;
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			transition: all 0.3s;
			box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
		}
		.save-all-marks-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
		}
		.save-all-marks-btn:active {
			transform: translateY(0);
		}
		.save-all-marks-btn i {
			font-size: 16px;
		}

		@media (max-width: 1200px) { 
			.stats-row { grid-template-columns: repeat(2, 1fr); }
			.table-toolbar > div:first-child { grid-template-columns: 1fr !important; }
			.marks-filter-grid { grid-template-columns: 1fr; }
			.marks-info-bar { flex-direction: column; gap: 16px; align-items: stretch; }
			.marks-info-text { flex-wrap: wrap; }
		}
		@media (max-width: 768px) {
			.stats-row { grid-template-columns: 1fr; }
			.form-grid { grid-template-columns: 1fr; }
			.form-group.full { grid-column: span 1; }
			.search-box { width: 100%; }
			.tabs-container { flex-direction: column; }
			.marks-filter-section { padding: 20px; }
			.marks-filter-header { flex-direction: column; align-items: flex-start; gap: 12px; }
			.marks-info-bar { flex-direction: column; gap: 16px; }
			.save-all-marks-btn { width: 100%; justify-content: center; }
		}
		
		/* Additional mobile optimizations */
		@media (max-width: 480px) {
			.modal-overlay {
				padding: 0;
			}
			.modal-content {
				border-radius: 0;
				max-height: 100vh;
				height: 100vh;
			}
			.exam-filter-select {
				font-size: 16px; /* Prevents zoom on iOS */
			}
		}

		/* ==================== VIEW EXAM MODAL STYLES ==================== */
		.view-exam-modal {
			width: 700px;
			max-width: 95%;
		}
		.view-exam-header {
			background: linear-gradient(135deg, #3b82f6, #2563eb);
			color: white;
			border-bottom: none;
		}
		.view-exam-header .modal-title {
			color: white;
		}
		.view-exam-header .modal-close {
			background: rgba(255, 255, 255, 0.2);
			color: white;
		}
		.view-exam-header .modal-close:hover {
			background: rgba(255, 255, 255, 0.3);
		}
		.view-exam-body {
			padding: 0;
		}
		.view-exam-content {
			padding: 24px;
		}
		.view-exam-footer {
			border-top: 1px solid #f1f5f9;
			justify-content: space-between;
		}

		/* View Exam Header Card */
		.view-exam-header-card {
			background: linear-gradient(135deg, #f8fafc, #f1f5f9);
			border-radius: 16px;
			padding: 24px;
			display: flex;
			align-items: center;
			gap: 20px;
			margin-bottom: 24px;
			border: 1px solid #e2e8f0;
		}
		.view-exam-icon {
			width: 64px;
			height: 64px;
			border-radius: 16px;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 28px;
			flex-shrink: 0;
		}
		.view-exam-title-section {
			flex: 1;
		}
		.view-exam-name {
			font-size: 22px;
			font-weight: 700;
			color: #1e293b;
			margin: 0 0 6px 0;
		}
		.view-exam-id {
			font-size: 13px;
			color: #64748b;
			font-weight: 600;
		}
		.view-exam-status-badge {
			padding: 8px 16px;
			border-radius: 20px;
			font-size: 13px;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		.view-exam-status-badge.scheduled {
			background: #dbeafe;
			color: #2563eb;
		}
		.view-exam-status-badge.ongoing {
			background: #fef3c7;
			color: #d97706;
		}
		.view-exam-status-badge.completed {
			background: #dcfce7;
			color: #16a34a;
		}
		.view-exam-status-badge.cancelled {
			background: #fef2f2;
			color: #dc2626;
		}

		/* View Exam Details Grid */
		.view-exam-details-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 16px;
			margin-bottom: 24px;
		}
		.view-detail-item {
			background: white;
			border: 2px solid #e2e8f0;
			border-radius: 12px;
			padding: 16px;
			display: flex;
			align-items: center;
			gap: 12px;
			transition: all 0.2s;
		}
		.view-detail-item:hover {
			border-color: #cbd5e1;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		}
		.view-detail-item.full-width {
			grid-column: span 3;
		}
		.view-detail-icon {
			width: 40px;
			height: 40px;
			border-radius: 10px;
			background: linear-gradient(135deg, #eff6ff, #dbeafe);
			color: #3b82f6;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 18px;
			flex-shrink: 0;
		}
		.view-detail-content {
			flex: 1;
		}
		.view-detail-label {
			font-size: 11px;
			font-weight: 700;
			color: #64748b;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-bottom: 4px;
		}
		.view-detail-value {
			font-size: 15px;
			font-weight: 600;
			color: #1e293b;
		}
		.view-detail-value.highlight {
			font-size: 18px;
			color: #f59e0b;
			font-weight: 700;
		}

		/* View Subjects Section */
		.view-subjects-section {
			background: white;
			border: 2px solid #e2e8f0;
			border-radius: 16px;
			padding: 20px;
			margin-top: 24px;
		}
		.view-subjects-header {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-bottom: 20px;
			padding-bottom: 16px;
			border-bottom: 2px solid #f1f5f9;
		}
		.view-subjects-header i {
			width: 36px;
			height: 36px;
			border-radius: 10px;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 16px;
		}
		.view-subjects-header h3 {
			font-size: 18px;
			font-weight: 700;
			color: #1e293b;
			margin: 0;
			flex: 1;
		}
		.view-subjects-count {
			background: #eff6ff;
			color: #2563eb;
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 700;
		}
		.view-subjects-list {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}
		.view-subject-item {
			background: linear-gradient(135deg, #f8fafc, #f1f5f9);
			border: 2px solid #e2e8f0;
			border-radius: 12px;
			padding: 16px;
			display: flex;
			align-items: center;
			gap: 16px;
			transition: all 0.2s;
		}
		.view-subject-item:hover {
			border-color: #cbd5e1;
			transform: translateX(4px);
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		}
		.view-subject-number {
			width: 36px;
			height: 36px;
			border-radius: 10px;
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			font-size: 14px;
			flex-shrink: 0;
		}
		.view-subject-details {
			flex: 1;
		}
		.view-subject-name {
			font-size: 16px;
			font-weight: 700;
			color: #1e293b;
			margin-bottom: 8px;
		}
		.view-subject-marks {
			display: flex;
			gap: 12px;
		}
		.view-marks-badge {
			padding: 6px 12px;
			border-radius: 8px;
			font-size: 13px;
			font-weight: 700;
		}
		.view-marks-badge.max {
			background: #dbeafe;
			color: #2563eb;
		}
		.view-marks-badge.pass {
			background: #dcfce7;
			color: #16a34a;
		}
		.view-no-subjects {
			text-align: center;
			padding: 40px 20px;
			color: #94a3b8;
			font-size: 14px;
		}

		@media (max-width: 768px) {
			.view-exam-modal {
				width: 100%;
			}
			.view-exam-header-card {
				flex-direction: column;
				text-align: center;
			}
			.view-exam-details-grid {
				grid-template-columns: 1fr;
			}
			.view-detail-item.full-width {
				grid-column: span 1;
			}
			.view-subjects-header {
				flex-wrap: wrap;
			}
			.view-subject-item {
				flex-direction: column;
				text-align: center;
			}
			.view-subject-marks {
				justify-content: center;
			}
		}

		/* ==================== EXAM MARKS MANAGEMENT STYLES ==================== */
		.marks-actions-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-top: 20px;
			padding: 20px 24px;
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			border-radius: 16px;
			border: 2px solid #e2e8f0;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			flex-wrap: wrap;
			gap: 16px;
		}
		.marks-actions-left, .marks-actions-right {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			align-items: center;
		}
		.excel-actions-group {
			display: flex;
			align-items: center;
			gap: 12px;
			padding-right: 16px;
			border-right: 2px solid #e2e8f0;
		}
		.excel-actions-label {
			font-size: 12px;
			font-weight: 700;
			color: #64748b;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			display: flex;
			align-items: center;
			gap: 6px;
		}
		.excel-actions-label i {
			color: #16a34a;
			font-size: 14px;
		}
		.marks-actions-bar .btn {
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			transition: all 0.3s;
			font-weight: 600;
		}
		.marks-actions-bar .btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		.marks-actions-bar .btn-success {
			background: linear-gradient(135deg, #16a34a, #15803d);
		}
		.marks-actions-bar .btn-primary {
			background: linear-gradient(135deg, #3b82f6, #2563eb);
		}
		@media (max-width: 768px) {
			.excel-actions-group {
				border-right: none;
				border-bottom: 2px solid #e2e8f0;
				padding-right: 0;
				padding-bottom: 12px;
				width: 100%;
				justify-content: space-between;
			}
			.marks-actions-bar {
				flex-direction: column;
				align-items: stretch;
			}
			.marks-actions-left, .marks-actions-right {
				width: 100%;
				justify-content: space-between;
			}
			.marks-actions-right {
				margin-top: 12px;
				padding-top: 12px;
				border-top: 2px solid #e2e8f0;
			}
		}
		.marks-table-filters {
			background: white;
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 20px;
			border: 1px solid #e2e8f0;
			display: flex;
			gap: 20px;
			align-items: center;
			flex-wrap: wrap;
		}
		.filter-group {
			display: flex;
			align-items: center;
			gap: 12px;
		}
		.filter-group label {
			font-size: 13px;
			font-weight: 600;
			color: #475569;
			white-space: nowrap;
		}
		.filter-chip {
			padding: 8px 16px;
			border: 2px solid #e2e8f0;
			background: white;
			border-radius: 20px;
			font-size: 13px;
			font-weight: 600;
			color: #64748b;
			cursor: pointer;
			transition: all 0.2s;
		}
		.filter-chip:hover {
			border-color: #f59e0b;
			color: #f59e0b;
		}
		.filter-chip.active {
			background: linear-gradient(135deg, #f59e0b, #d97706);
			border-color: #f59e0b;
			color: white;
		}
		.filter-select {
			padding: 8px 12px;
			border: 2px solid #e2e8f0;
			border-radius: 8px;
			font-size: 14px;
			min-width: 150px;
		}
		.filter-input {
			padding: 8px 12px;
			border: 2px solid #e2e8f0;
			border-radius: 8px;
			font-size: 14px;
			width: 80px;
		}
		.marks-table-card {
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
		}
		.marks-data-table {
			font-size: 13px;
			min-width: 1000px;
		}
		.marks-data-table th {
			font-size: 11px;
			padding: 12px 8px;
			white-space: nowrap;
		}
		.marks-data-table td {
			padding: 12px 8px;
			font-size: 13px;
			white-space: nowrap;
		}
		.status-badge-pass {
			background: #dcfce7;
			color: #16a34a;
			padding: 4px 10px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: 700;
		}
		.status-badge-fail {
			background: #fef2f2;
			color: #dc2626;
			padding: 4px 10px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: 700;
		}
		.remarks-cell {
			max-width: 150px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}
		@media (max-width: 768px) {
			.marks-actions-bar {
				flex-direction: column;
			}
			.marks-actions-left, .marks-actions-right {
				width: 100%;
				justify-content: stretch;
			}
			.marks-actions-left .btn, .marks-actions-right .btn {
				flex: 1;
			}
			.marks-table-filters {
				flex-direction: column;
				align-items: stretch;
			}
			.filter-group {
				flex-direction: column;
				align-items: stretch;
			}
			.filter-chip {
				width: 100%;
				text-align: center;
			}
			.marks-data-table {
				font-size: 11px;
			}
			.marks-data-table th, .marks-data-table td {
				padding: 8px 4px;
			}
		}

		/* ==================== ANALYTICS DASHBOARD STYLES ==================== */
		.analytics-toggle-bar {
			margin-bottom: 16px;
		}
		.analytics-toggle-btn {
			width: 100%;
			padding: 14px 20px;
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			border: 2px solid #e2e8f0;
			border-radius: 12px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			font-size: 14px;
			font-weight: 600;
			color: #475569;
			transition: all 0.3s;
			box-shadow: 0 2px 8px rgba(0,0,0,0.04);
		}
		.analytics-toggle-btn:hover {
			border-color: #3b82f6;
			background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
			color: #3b82f6;
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
		}
		.analytics-toggle-btn i:first-child {
			color: #3b82f6;
			font-size: 16px;
		}
		.analytics-toggle-btn .toggle-icon {
			transition: transform 0.3s;
			color: #94a3b8;
		}
		.analytics-toggle-btn.expanded .toggle-icon {
			transform: rotate(180deg);
		}
		.analytics-dashboard {
			background: white;
			border-radius: 16px;
			padding: 24px;
			margin-bottom: 20px;
			border: 1px solid #e2e8f0;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			overflow: hidden;
			transition: all 0.3s ease;
			max-height: 2000px;
			opacity: 1;
		}
		.analytics-dashboard.collapsed {
			max-height: 0;
			padding: 0 24px;
			margin-bottom: 0;
			opacity: 0;
			overflow: hidden;
		}
		.analytics-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 24px;
			padding-bottom: 16px;
			border-bottom: 2px solid #f1f5f9;
		}
		.analytics-header h3 {
			font-size: 20px;
			font-weight: 700;
			color: #1e293b;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.analytics-header h3 i {
			color: #3b82f6;
		}
		.analytics-actions {
			display: flex;
			gap: 10px;
		}
		.analytics-stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 16px;
			margin-bottom: 24px;
		}
		.analytics-stat-card {
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			border: 2px solid #e2e8f0;
			border-radius: 12px;
			padding: 20px;
			transition: all 0.3s;
		}
		.analytics-stat-card:hover {
			border-color: #3b82f6;
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
			transform: translateY(-2px);
		}
		.analytics-stat-label {
			font-size: 12px;
			font-weight: 600;
			color: #64748b;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-bottom: 8px;
		}
		.analytics-stat-value {
			font-size: 28px;
			font-weight: 700;
			color: #1e293b;
			margin-bottom: 4px;
		}
		.analytics-stat-change {
			font-size: 12px;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.analytics-stat-change.positive {
			color: #16a34a;
		}
		.analytics-stat-change.negative {
			color: #dc2626;
		}
		.analytics-charts-section {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 20px;
			margin-top: 24px;
		}
		.chart-container {
			background: #f8fafc;
			border-radius: 12px;
			padding: 20px;
			border: 1px solid #e2e8f0;
		}
		.chart-container h4 {
			font-size: 16px;
			font-weight: 700;
			color: #1e293b;
			margin-bottom: 16px;
		}
		.chart-container canvas {
			max-height: 300px;
		}

		/* ==================== BULK OPERATIONS STYLES ==================== */
		.bulk-operations-bar {
			background: #fffbeb;
			border: 2px solid #fcd34d;
			border-radius: 12px;
			padding: 16px 20px;
			margin-bottom: 20px;
			display: none;
			align-items: center;
			justify-content: space-between;
			flex-wrap: wrap;
			gap: 12px;
		}
		.bulk-operations-bar.active {
			display: flex;
		}
		.bulk-selection-info {
			font-weight: 600;
			color: #92400e;
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.bulk-actions-group {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		/* ==================== GRADE SYSTEM STYLES ==================== */
		.grade-badge {
			display: inline-block;
			padding: 4px 10px;
			border-radius: 12px;
			font-size: 12px;
			font-weight: 700;
			text-align: center;
			min-width: 40px;
		}
		.grade-badge.A-plus { background: #dcfce7; color: #16a34a; }
		.grade-badge.A { background: #dbeafe; color: #2563eb; }
		.grade-badge.B-plus { background: #e0e7ff; color: #6366f1; }
		.grade-badge.B { background: #fef3c7; color: #d97706; }
		.grade-badge.C { background: #fed7aa; color: #ea580c; }
		.grade-badge.D { background: #fecdd3; color: #e11d48; }
		.grade-badge.F { background: #fee2e2; color: #dc2626; }

		/* ==================== RANK INDICATOR STYLES ==================== */
		.rank-indicator {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			font-size: 12px;
			font-weight: 600;
			padding: 4px 8px;
			border-radius: 8px;
			background: #f1f5f9;
		}
		.rank-indicator.top {
			background: #dcfce7;
			color: #16a34a;
		}
		.rank-indicator.bottom {
			background: #fee2e2;
			color: #dc2626;
		}
		.trend-arrow {
			font-size: 14px;
		}
		.trend-arrow.up {
			color: #16a34a;
		}
		.trend-arrow.down {
			color: #dc2626;
		}
		.trend-arrow.stable {
			color: #64748b;
		}

		/* ==================== HISTORY/AUDIT TRAIL STYLES ==================== */
		.history-badge {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			padding: 2px 8px;
			border-radius: 8px;
			font-size: 11px;
			font-weight: 600;
			background: #f1f5f9;
			color: #64748b;
			cursor: pointer;
		}
		.history-badge:hover {
			background: #e2e8f0;
		}

		/* ==================== ENHANCED TABLE STYLES ==================== */
		.marks-data-table .checkbox-cell {
			width: 40px;
			text-align: center;
		}
		.marks-data-table .grade-cell {
			text-align: center;
		}
		.marks-data-table .rank-cell {
			text-align: center;
		}
		.marks-data-table .trend-cell {
			text-align: center;
		}
		.color-coded-cell {
			padding: 4px 8px;
			border-radius: 6px;
			font-weight: 600;
		}
		.color-coded-cell.excellent {
			background: #dcfce7;
			color: #16a34a;
		}
		.color-coded-cell.good {
			background: #dbeafe;
			color: #2563eb;
		}
		.color-coded-cell.average {
			background: #fef3c7;
			color: #d97706;
		}
		.color-coded-cell.poor {
			background: #fee2e2;
			color: #dc2626;
		}

		/* ==================== KEYBOARD SHORTCUTS HINT ==================== */
		.shortcuts-hint {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: white;
			border: 2px solid #e2e8f0;
			border-radius: 12px;
			padding: 12px 16px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.1);
			font-size: 12px;
			color: #64748b;
			z-index: 1000;
			display: none;
		}
		.shortcuts-hint.show {
			display: block;
		}
		.shortcuts-hint kbd {
			background: #f1f5f9;
			padding: 2px 6px;
			border-radius: 4px;
			font-family: monospace;
			font-size: 11px;
		}
	</style>
</head>
<body>
	<div class="page exams-page active">
		<div class="page-header">
			<div class="page-title-section">
				<h1><i class="fas fa-file-alt" style="color: #f59e0b; margin-right: 10px;"></i>Exams & Grades</h1>
				<p>Schedule and manage examinations</p>
			</div>
			<div class="header-actions">
				<input type="file" id="importFile" accept=".csv" style="display: none;">
				<button class="btn btn-outline" id="importBtn"><i class="fas fa-file-import"></i> Import</button>
				<button class="btn btn-success" id="exportBtn"><i class="fas fa-file-export"></i> Export</button>
			<button class="btn btn-primary" id="addExamBtn"><i class="fas fa-plus"></i> Add Exam</button>
		</div>
		</div>

		<!-- Tabs -->
		<div class="tabs-container">
			<button class="tab-btn active" data-tab="exams">
				<i class="fas fa-file-alt"></i>Exams
			</button>
			<button class="tab-btn" data-tab="marks">
				<i class="fas fa-edit"></i>Exam Marks
			</button>
		</div>

		<!-- Exams Tab Content -->
		<div class="tab-content active" id="examsTab">
		<div class="stats-row" id="statsRow"></div>

		<!-- Edit Hint Banner -->
		<div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 10px; padding: 12px 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; font-size: 13px; color: #92400e;">
			<i class="fas fa-lightbulb" style="color: #f59e0b; font-size: 16px;"></i>
			<span><strong>Tip:</strong> Click on any cell to edit inline. Changes save automatically. Use action buttons to edit or delete exams.</span>
		</div>

		<div class="table-card">
			<div class="table-toolbar">
				<div class="search-box">
					<i class="fas fa-search"></i>
					<input type="text" id="searchInput" placeholder="Search exams...">
				</div>
				<div class="toolbar-actions">
					<select id="statusFilter" class="page-select" style="min-width: 160px;">
						<option value="">All Status</option>
						<option value="Scheduled">Scheduled</option>
						<option value="Ongoing">Ongoing</option>
						<option value="Completed">Completed</option>
						<option value="Cancelled">Cancelled</option>
					</select>
					<button class="btn btn-danger btn-sm" id="bulkDeleteBtn" disabled>
						<i class="fas fa-trash"></i> Delete Selected
					</button>
				</div>
		</div>

			<table class="data-table">
				<thead>
					<tr>
						<th class="checkbox-cell"><input type="checkbox" class="custom-checkbox" id="selectAll"></th>
						<th>Exam ID</th>
						<th>Exam</th>
						<th>Class</th>
						<th>Date</th>
						<th>Time</th>
						<th>Duration</th>
						<th>Max Marks</th>
						<th>Status</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody id="tableBody"></tbody>
			</table>

			<div class="table-footer">
				<div class="pagination-info" id="pageInfo">Showing 0-0 of 0 exams</div>
				<div class="pagination-btns">
					<button class="page-btn" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
					<span id="pageNum" style="padding: 0 12px; font-weight: 600;">1</span>
					<button class="page-btn" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
					<select class="page-select" id="pageSizeSelect">
						<option value="10">10 / page</option>
						<option value="20">20 / page</option>
						<option value="50">50 / page</option>
					</select>
				</div>
			</div>
		</div>
		</div>

		<!-- Exam Marks Tab Content -->
		<div class="tab-content" id="marksTab" style="display: none;">
			<!-- Filter Section -->
			<div class="marks-filter-section">
				<div class="marks-filter-header">
					<i class="fas fa-filter"></i>
					<div>
						<h3>Filter Selection</h3>
						<p>Select exam, class, and section to load students for mark entry</p>
					</div>
				</div>
				<div class="marks-filter-grid">
					<div class="marks-filter-group">
						<label class="marks-filter-label">
							<i class="fas fa-file-alt"></i>
							Exam <span class="required">*</span>
						</label>
						<select class="marks-filter-select" id="marksExamSelect" required>
							<option value="">Select Exam</option>
						</select>
					</div>
					<div class="marks-filter-group">
						<label class="marks-filter-label">
							<i class="fas fa-graduation-cap"></i>
							Class <span class="required">*</span>
						</label>
						<select class="marks-filter-select" id="marksClassSelect" required>
							<option value="">Select Class</option>
							<option value="1">Class 1</option>
							<option value="2">Class 2</option>
							<option value="3">Class 3</option>
							<option value="4">Class 4</option>
							<option value="5">Class 5</option>
							<option value="6">Class 6</option>
							<option value="7">Class 7</option>
							<option value="8">Class 8</option>
							<option value="9">Class 9</option>
							<option value="10">Class 10</option>
							<option value="11">Class 11</option>
							<option value="12">Class 12</option>
						</select>
					</div>
					<div class="marks-filter-group">
						<label class="marks-filter-label">
							<i class="fas fa-users"></i>
							Section <span class="required">*</span>
						</label>
						<select class="marks-filter-select" id="marksSectionSelect" required>
							<option value="">Select Section</option>
							<!-- Sections loaded dynamically -->
						</select>
					</div>
				</div>
				<div class="marks-actions-bar" id="marksActionsBar" style="display: none;">
					<div class="marks-actions-left">
						<div class="excel-actions-group">
							<span class="excel-actions-label">
								<i class="fas fa-file-excel"></i> Excel Operations
							</span>
							<button class="btn btn-success" id="downloadTemplateBtn">
								<i class="fas fa-download"></i> Download Template
							</button>
							<button class="btn btn-primary" id="uploadMarksBtn">
								<i class="fas fa-upload"></i> Upload Excel
							</button>
						</div>
						<input type="file" id="marksFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
					</div>
					<div class="marks-actions-right">
						<button class="btn btn-outline" id="addSingleMarkBtn">
							<i class="fas fa-plus"></i> Add Single Mark
						</button>
						<button class="save-all-marks-btn" id="saveAllMarksBtn">
							<i class="fas fa-save"></i> Save All Marks
						</button>
					</div>
				</div>
				<div class="marks-info-bar" id="marksInfoBar" style="display: none;">
					<div class="marks-info-text" id="marksInfo"></div>
				</div>
			</div>

			<!-- Analytics Dashboard Toggle -->
			<div class="analytics-toggle-bar" id="analyticsToggleBar" style="display: none;">
				<button class="analytics-toggle-btn" id="toggleAnalyticsBtn">
					<i class="fas fa-chart-line"></i>
					<span>Show Performance Analytics</span>
					<i class="fas fa-chevron-down toggle-icon"></i>
				</button>
			</div>

			<!-- Analytics Dashboard -->
			<div class="analytics-dashboard" id="analyticsDashboard" style="display: none;">
				<div class="analytics-header">
					<h3><i class="fas fa-chart-line"></i> Performance Analytics</h3>
					<div class="analytics-actions">
						<button class="btn btn-outline btn-sm" id="refreshAnalyticsBtn">
							<i class="fas fa-sync-alt"></i> Refresh
						</button>
						<button class="btn btn-outline btn-sm" id="exportAnalyticsBtn">
							<i class="fas fa-download"></i> Export Report
						</button>
						<button class="btn btn-outline btn-sm" id="collapseAnalyticsBtn" title="Collapse">
							<i class="fas fa-chevron-up"></i>
						</button>
					</div>
				</div>
				<div class="analytics-stats-grid" id="analyticsStatsGrid">
					<!-- Stats will be populated dynamically -->
				</div>
				<div class="analytics-charts-section">
					<div class="chart-container">
						<h4>Subject-wise Performance</h4>
						<canvas id="subjectChart"></canvas>
					</div>
					<div class="chart-container">
						<h4>Pass/Fail Distribution</h4>
						<canvas id="passFailChart"></canvas>
					</div>
				</div>
			</div>

			<!-- Filter Options Section -->
			<div class="marks-table-filters" id="marksTableFilters" style="display: none;">
				<div class="filter-group">
					<label>Quick Filters:</label>
					<button class="filter-chip active" data-filter="all">All Students</button>
					<button class="filter-chip" data-filter="low">Low Marks</button>
					<button class="filter-chip" data-filter="failed">Failed</button>
				</div>
				<div class="filter-group">
					<label>Subject:</label>
					<select class="filter-select" id="subjectFilterSelect">
						<option value="">All Subjects</option>
					</select>
				</div>
				<div class="filter-group">
					<label>Marks Range:</label>
					<input type="number" class="filter-input" id="minMarksInput" placeholder="Min" min="0">
					<span>to</span>
					<input type="number" class="filter-input" id="maxMarksInput" placeholder="Max" min="0">
				</div>
			</div>

			<!-- Bulk Operations Bar -->
			<div class="bulk-operations-bar" id="bulkOperationsBar">
				<div class="bulk-selection-info">
					<i class="fas fa-check-square"></i>
					<span id="bulkSelectionCount">0</span> student(s) selected
				</div>
				<div class="bulk-actions-group">
					<button class="btn btn-outline btn-sm" id="bulkUpdateMarksBtn">
						<i class="fas fa-edit"></i> Update Marks
					</button>
					<button class="btn btn-outline btn-sm" id="bulkUpdateStatusBtn">
						<i class="fas fa-toggle-on"></i> Update Status
					</button>
					<button class="btn btn-outline btn-sm" id="bulkAddRemarksBtn">
						<i class="fas fa-comment"></i> Add Remarks
					</button>
					<button class="btn btn-outline btn-sm" id="bulkDeselectBtn">
						<i class="fas fa-times"></i> Deselect All
					</button>
				</div>
			</div>

			<!-- Marks Table -->
			<div class="marks-table-card" id="marksTableContainer" style="display: none;">
				<table class="data-table marks-data-table">
					<thead class="marks-table-header">
						<tr>
							<th class="checkbox-cell"><input type="checkbox" id="selectAllMarks" title="Select All"></th>
							<th style="width: 50px; text-align: center;">S.No</th>
							<th>Student ID</th>
							<th>Student Name</th>
							<th>Subject</th>
							<th style="width: 100px;">Total Marks</th>
							<th style="width: 100px;">Assignment</th>
							<th style="width: 100px;">Internal</th>
							<th style="width: 100px;">Practical</th>
							<th style="width: 100px;">Obtained</th>
							<th style="width: 80px;" class="grade-cell">Grade</th>
							<th style="width: 80px;" class="rank-cell">Rank</th>
							<th style="width: 100px;">Status</th>
							<th style="width: 60px;" class="trend-cell">Trend</th>
							<th style="width: 150px;">Remarks</th>
							<th style="width: 100px;">Actions</th>
						</tr>
					</thead>
					<tbody id="marksTableBody"></tbody>
				</table>
			</div>

			<!-- Empty State -->
			<div class="table-card" id="marksEmptyState" style="text-align: center; padding: 80px 20px; display: block;">
				<i class="fas fa-filter" style="font-size: 72px; color: #e2e8f0; margin-bottom: 24px; opacity: 0.6;"></i>
				<h3 style="font-size: 20px; color: #475569; margin-bottom: 12px; font-weight: 700;">Select Exam, Class & Section</h3>
				<p style="color: #94a3b8; font-size: 15px; max-width: 400px; margin: 0 auto;">Please select all three filters above to load students for mark entry. All fields are required.</p>
				<div style="margin-top: 24px; padding: 20px; background: #f8fafc; border-radius: 12px; max-width: 600px; margin-left: auto; margin-right: auto;">
					<h4 style="font-size: 16px; color: #1e293b; margin-bottom: 12px; font-weight: 700;">Available Features:</h4>
					<ul style="text-align: left; color: #64748b; font-size: 14px; line-height: 1.8; list-style: none; padding: 0;">
						<li style="margin-bottom: 8px;"><i class="fas fa-check-circle" style="color: #16a34a; margin-right: 8px;"></i> Download Excel Template for bulk mark entry</li>
						<li style="margin-bottom: 8px;"><i class="fas fa-check-circle" style="color: #16a34a; margin-right: 8px;"></i> Upload filled Excel sheet with validation</li>
						<li style="margin-bottom: 8px;"><i class="fas fa-check-circle" style="color: #16a34a; margin-right: 8px;"></i> Inline mark entry with keyboard navigation</li>
						<li style="margin-bottom: 8px;"><i class="fas fa-check-circle" style="color: #16a34a; margin-right: 8px;"></i> Filter by All Students, Low Marks, Failed, Subject, and Marks Range</li>
						<li style="margin-bottom: 8px;"><i class="fas fa-check-circle" style="color: #16a34a; margin-right: 8px;"></i> Single student mark entry/edit popup</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<!-- Single Student Mark Entry Modal -->
	<div class="modal-overlay" id="singleMarkModal">
		<div class="modal-content" style="width: 600px; max-width: 95%;">
			<div class="modal-header">
				<div class="modal-title">
					<i class="fas fa-edit" style="color: #f59e0b;"></i>
					<span id="singleMarkModalTitle">Add/Edit Student Marks</span>
				</div>
				<button class="modal-close" id="closeSingleMarkModal"><i class="fas fa-times"></i></button>
			</div>
			<div class="modal-body">
				<div class="form-grid">
					<div class="form-group" id="singleStudentIdGroup">
						<label class="form-label">Student ID</label>
						<input type="text" class="form-input" id="singleStudentId" readonly>
					</div>
					<div class="form-group" id="singleStudentNameGroup">
						<label class="form-label">Student Name</label>
						<input type="text" class="form-input" id="singleStudentName" readonly>
					</div>
					<div class="form-group" id="singleStudentSelectGroup" style="display: none;">
						<label class="form-label">Student <span class="required">*</span></label>
						<select class="form-select" id="singleStudentSelect">
							<option value="">Select Student</option>
						</select>
					</div>
					<div class="form-group">
						<label class="form-label">Exam</label>
						<input type="text" class="form-input" id="singleExamName" readonly>
					</div>
					<div class="form-group">
						<label class="form-label">Subject <span class="required">*</span></label>
						<select class="form-select" id="singleSubjectSelect">
							<option value="">Select Subject</option>
						</select>
					</div>
					<div class="form-group">
						<label class="form-label">Total Marks *</label>
						<input type="number" class="form-input" id="singleTotalMarks" placeholder="100" min="0" required>
					</div>
					<div class="form-group">
						<label class="form-label">Assignment Marks</label>
						<input type="number" class="form-input" id="singleAssignmentMarks" placeholder="0" min="0">
					</div>
					<div class="form-group">
						<label class="form-label">Internal Marks</label>
						<input type="number" class="form-input" id="singleInternalMarks" placeholder="0" min="0">
					</div>
					<div class="form-group">
						<label class="form-label">Practical Marks</label>
						<input type="number" class="form-input" id="singlePracticalMarks" placeholder="0" min="0">
					</div>
					<div class="form-group">
						<label class="form-label">Obtained Marks *</label>
						<input type="number" class="form-input" id="singleObtainedMarks" placeholder="0" min="0" required>
					</div>
					<div class="form-group">
						<label class="form-label">Status</label>
						<select class="form-select" id="singleStatusSelect">
							<option value="Pass">Pass</option>
							<option value="Fail">Fail</option>
						</select>
					</div>
					<div class="form-group full">
						<label class="form-label">Remarks</label>
						<textarea class="form-input" id="singleRemarks" rows="3" placeholder="Enter remarks (optional)" style="resize: vertical;"></textarea>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn btn-outline" id="cancelSingleMarkBtn">Cancel</button>
				<button class="btn btn-primary" id="saveSingleMarkBtn"><i class="fas fa-save"></i> Save Marks</button>
			</div>
		</div>
	</div>

	<button class="fab-btn" id="fabAddBtn" title="Add New Exam"><i class="fas fa-plus"></i></button>

	<!-- View Exam Modal -->
	<div class="modal-overlay" id="viewExamModal">
		<div class="modal-content view-exam-modal" style="width: 700px; max-width: 95%;">
			<div class="modal-header view-exam-header">
				<div class="modal-title">
					<i class="fas fa-eye" style="color: #3b82f6;"></i>
					<span>Exam Details</span>
				</div>
				<button class="modal-close" id="closeViewModal"><i class="fas fa-times"></i></button>
			</div>
			<div class="modal-body view-exam-body" id="viewExamBody">
				<!-- Content will be dynamically loaded -->
			</div>
			<div class="modal-footer view-exam-footer">
				<button class="btn btn-primary" id="editFromViewBtn">
					<i class="fas fa-edit"></i> Edit Exam
				</button>
				<button class="btn btn-outline" id="closeViewModalBtn">Close</button>
			</div>
		</div>
	</div>

	<div class="modal-overlay" id="examModal">
		<div class="modal-content" style="width: 800px; max-width: 95%;">
			<div class="modal-header">
				<div class="modal-title">
					<i class="fas fa-file-alt" style="color: #f59e0b;"></i>
					<span id="modalTitle">Add New Exam</span>
				</div>
				<button class="modal-close" id="closeModal"><i class="fas fa-times"></i></button>
			</div>
			<div class="modal-body">
				<input type="hidden" id="editingId">
				
				<!-- Filter Section -->
				<div class="exam-filter-section">
					<div class="exam-filter-header">
						<i class="fas fa-filter"></i>
						<h4>Filter & Load Subjects</h4>
					</div>
					<div class="exam-filter-grid">
						<div class="exam-filter-group">
							<label class="exam-filter-label">
								Exam Type <span class="required">*</span>
							</label>
							<select class="exam-filter-select" id="examType">
								<option value="">Select Exam Type</option>
								<option value="Quarterly">Quarterly</option>
								<option value="Half Yearly">Half Yearly</option>
								<option value="Annual">Annual</option>
						</select>
				</div>
						<div class="exam-filter-group">
							<label class="exam-filter-label">
								Class <span class="required">*</span>
							</label>
							<select class="exam-filter-select" id="examClass">
							<option value="">Select Class</option>
								<option value="1">Class 1</option>
								<option value="2">Class 2</option>
								<option value="3">Class 3</option>
								<option value="4">Class 4</option>
								<option value="5">Class 5</option>
								<option value="6">Class 6</option>
								<option value="7">Class 7</option>
								<option value="8">Class 8</option>
							<option value="9">Class 9</option>
							<option value="10">Class 10</option>
							<option value="11">Class 11</option>
							<option value="12">Class 12</option>
					</select>
						</div>
						<div class="exam-filter-group">
							<label class="exam-filter-label">
								Section <span class="required">*</span>
							</label>
							<select class="exam-filter-select" id="examSection" required>
								<option value="">Select Section</option>
								<!-- Sections loaded dynamically based on selected class -->
							</select>
						</div>
					</div>
					<button class="load-subjects-btn" id="loadSubjectsBtn">
						<i class="fas fa-sync-alt"></i> Load Subjects
					</button>
				</div>

				<div class="exam-filter-divider"></div>

				<!-- Subject & Marks Section -->
				<div class="subjects-marks-section" id="subjectsMarksSection" style="display: none;">
					<div class="subjects-marks-header">
						<div class="subjects-marks-title">
							<i class="fas fa-book"></i>
							<span>Subject-wise Marks Configuration</span>
						</div>
						<button class="apply-same-marks-btn" id="applySameMarksBtn">
							<i class="fas fa-magic"></i> Apply Same Marks to All
						</button>
					</div>
					<div id="subjectsMarksTableContainer" class="subjects-marks-table-container">
						<table class="subjects-marks-table">
							<thead>
								<tr>
									<th style="width: 40%;">Subject Name</th>
									<th style="width: 30%;">Max Marks</th>
									<th style="width: 30%;">Pass Marks</th>
								</tr>
							</thead>
							<tbody id="subjectsMarksTableBody"></tbody>
						</table>
					</div>
				</div>

				<!-- Basic Exam Details -->
				<div class="form-grid" id="basicExamDetails">
					<div class="form-group full">
						<label class="form-label">Exam Name *</label>
						<input type="text" class="form-input" id="examName" placeholder="e.g., Mid Term Examination">
				</div>
				<div class="form-group">
						<label class="form-label">Date *</label>
						<input type="date" class="form-input" id="examDate">
					</div>
					<div class="form-group">
						<label class="form-label">Time</label>
						<input type="time" class="form-input" id="examTime" value="09:00">
				</div>
				<div class="form-group">
						<label class="form-label">Duration (mins)</label>
						<input type="number" class="form-input" id="examDuration" placeholder="180" value="180">
				</div>
				<div class="form-group">
						<label class="form-label">Status</label>
						<select class="form-select" id="examStatus">
							<option value="Scheduled"> Scheduled</option>
							<option value="Ongoing"> Ongoing</option>
							<option value="Completed"> Completed</option>
							<option value="Cancelled"> Cancelled</option>
					</select>
				</div>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn btn-outline" id="cancelBtn">Cancel</button>
				<button class="btn btn-primary" id="saveBtn"><i class="fas fa-save"></i> Save Exam</button>
			</div>
		</div>

	<script>
		function notify(msg, type = 'success') {
			document.querySelectorAll('.toast').forEach(t => t.remove());
			const toast = document.createElement('div');
			const bg = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#f59e0b';
			toast.style.cssText = `position:fixed;bottom:30px;right:30px;padding:16px 24px;background:${bg};color:white;border-radius:12px;font-weight:600;z-index:10000;display:flex;align-items:center;gap:10px;animation:slideIn 0.4s ease;`;
			toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${msg}`;
			document.body.appendChild(toast);
			if (!document.getElementById('toastStyle')) {
				const s = document.createElement('style');
				s.id = 'toastStyle';
				s.textContent = `@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}`;
				document.head.appendChild(s);
			}
			setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
		}

		// ==================== STORAGE KEYS ====================
		const STORAGE_KEY = 'edu_exams';
		const SUBJECT_MASTER_KEY = 'edu_subject_master';
		const CLASS_SUBJECT_MAPPING_KEY = 'edu_class_subject_mapping';
		const CLASS_SECTION_MAPPING_KEY = 'edu_class_section_mapping';
		
		let exams = [];
		let page = 1, pageSize = 10;
		let selected = new Set();

		function loadExams() {
			try {
				const data = localStorage.getItem(STORAGE_KEY);
				if (data) { exams = JSON.parse(data); }
				else {
					exams = [
						{ id: 'EXM001', name: 'Mid Term Examination', subject: 'Mathematics', class: '10', date: '2025-12-10', time: '09:00', duration: 180, max: 100, status: 'Scheduled' },
						{ id: 'EXM002', name: 'Mid Term Examination', subject: 'Science', class: '10', date: '2025-12-12', time: '09:00', duration: 180, max: 100, status: 'Scheduled' },
						{ id: 'EXM003', name: 'Unit Test 1', subject: 'English', class: '9', date: '2025-11-25', time: '10:00', duration: 90, max: 50, status: 'Completed' },
						{ id: 'EXM004', name: 'Final Examination', subject: 'Physics', class: '12', date: '2026-03-15', time: '09:00', duration: 180, max: 100, status: 'Scheduled' },
						{ id: 'EXM005', name: 'Practical Exam', subject: 'Chemistry', class: '11', date: '2025-12-05', time: '14:00', duration: 120, max: 30, status: 'Ongoing' },
						{ id: 'EXM006', name: 'Quiz', subject: 'Computer Science', class: '10', date: '2025-11-20', time: '11:00', duration: 45, max: 25, status: 'Completed' }
					];
					saveExams();
				}
			} catch (e) { exams = []; }
		}

		function saveExams() { localStorage.setItem(STORAGE_KEY, JSON.stringify(exams)); }

		function renderStats() {
			const total = exams.length;
			const scheduled = exams.filter(e => e.status === 'Scheduled').length;
			const ongoing = exams.filter(e => e.status === 'Ongoing').length;
			const completed = exams.filter(e => e.status === 'Completed').length;

			document.getElementById('statsRow').innerHTML = `
				<div class="stat-card"><div class="stat-icon orange"><i class="fas fa-file-alt"></i></div><div><div class="stat-value">${total}</div><div class="stat-label">Total Exams</div></div></div>
				<div class="stat-card"><div class="stat-icon blue"><i class="fas fa-calendar-alt"></i></div><div><div class="stat-value">${scheduled}</div><div class="stat-label">Scheduled</div></div></div>
				<div class="stat-card"><div class="stat-icon green"><i class="fas fa-spinner"></i></div><div><div class="stat-value">${ongoing}</div><div class="stat-label">Ongoing</div></div></div>
				<div class="stat-card"><div class="stat-icon red"><i class="fas fa-check-circle"></i></div><div><div class="stat-value">${completed}</div><div class="stat-label">Completed</div></div></div>
			`;
		}

		function renderTable() {
			const search = document.getElementById('searchInput').value.toLowerCase();
			const statusFilter = document.getElementById('statusFilter').value;

			let filtered = exams.filter(e => {
				const matchSearch = !search || [e.id, e.name, e.subject, e.class].join(' ').toLowerCase().includes(search);
				const matchStatus = !statusFilter || e.status === statusFilter;
				return matchSearch && matchStatus;
			});

			const total = filtered.length;
			const totalPages = Math.max(1, Math.ceil(total / pageSize));
			if (page > totalPages) page = totalPages;

			const start = (page - 1) * pageSize;
			const pageData = filtered.slice(start, start + pageSize);
			const tbody = document.getElementById('tableBody');

			if (pageData.length === 0) {
				tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><i class="fas fa-file-alt"></i><h3>No Exams Found</h3><p>Add new exams to get started</p></div></td></tr>`;
			} else {
				tbody.innerHTML = pageData.map((e, idx) => {
					const globalIdx = start + idx;
					const statusClass = e.status.toLowerCase();
					const examType = e.examType || '';
					const subjectInfo = e.subjects && e.subjects.length > 0 
						? `${e.subjects.length} Subject${e.subjects.length > 1 ? 's' : ''}` 
						: (e.subject || 'N/A');
					return `
						<tr>
							<td class="checkbox-cell"><input type="checkbox" class="custom-checkbox" data-id="${e.id}" ${selected.has(e.id) ? 'checked' : ''}></td>
							<td><span class="exam-id">${e.id}</span></td>
							<td><div class="exam-info"><div class="exam-icon"><i class="fas fa-file-alt"></i></div><div><div class="exam-name">${e.name}</div><div class="exam-subject">${examType ? examType + ' - ' : ''}${subjectInfo}${e.section ? ' (' + e.section + ')' : ''}</div></div></div></td>
							<td>Class ${e.class}</td>
							<td>${formatDate(e.date)}</td>
							<td>${e.time || '-'}</td>
							<td>${e.duration} mins</td>
							<td>${e.max} marks</td>
							<td><span class="status-badge ${statusClass}">${e.status}</span></td>
							<td><div class="action-btns"><button class="action-btn view" data-action="view" data-idx="${globalIdx}"><i class="fas fa-eye"></i></button><button class="action-btn edit" data-action="edit" data-idx="${globalIdx}"><i class="fas fa-edit"></i></button><button class="action-btn delete" data-action="delete" data-idx="${globalIdx}"><i class="fas fa-trash"></i></button></div></td>
				</tr>
					`;
				}).join('');
			}

			document.getElementById('pageInfo').textContent = `Showing ${start + 1}-${Math.min(start + pageSize, total)} of ${total} exams`;
			document.getElementById('pageNum').textContent = page;
			document.getElementById('prevBtn').disabled = page <= 1;
			document.getElementById('nextBtn').disabled = page >= totalPages;
			document.getElementById('bulkDeleteBtn').disabled = selected.size === 0;
			document.getElementById('selectAll').checked = pageData.length > 0 && pageData.every(e => selected.has(e.id));
		}

		function formatDate(dateStr) {
			if (!dateStr) return '-';
			const d = new Date(dateStr);
			if (isNaN(d)) return dateStr;
			return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
		}

		// ==================== SUBJECT MASTER (GLOBAL) ====================
		// Initialize Subject Master with default subjects
		function initializeSubjectMaster() {
			try {
				const data = localStorage.getItem(SUBJECT_MASTER_KEY);
				if (!data) {
					const defaultSubjects = [
						{ id: 'SUB001', name: 'English', code: 'ENG', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB002', name: 'Mathematics', code: 'MATH', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB003', name: 'Science', code: 'SCI', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB004', name: 'Social Studies', code: 'SST', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB005', name: 'Art', code: 'ART', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB006', name: 'Physical Education', code: 'PE', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB007', name: 'Computer Science', code: 'CS', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB008', name: 'Physics', code: 'PHY', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB009', name: 'Chemistry', code: 'CHEM', isActive: true, createdAt: new Date().toISOString() },
						{ id: 'SUB010', name: 'Biology', code: 'BIO', isActive: true, createdAt: new Date().toISOString() }
					];
					localStorage.setItem(SUBJECT_MASTER_KEY, JSON.stringify(defaultSubjects));
				}
			} catch (e) {
				console.error('Error initializing Subject Master:', e);
			}
		}

		function getSubjectMaster() {
			try {
				const data = localStorage.getItem(SUBJECT_MASTER_KEY);
				return data ? JSON.parse(data) : [];
			} catch (e) {
				return [];
			}
		}

		// ==================== CLASS-SUBJECT MAPPING ====================
		// Initialize Class-Subject Mapping with default mappings
		function initializeClassSubjectMapping() {
			try {
				const data = localStorage.getItem(CLASS_SUBJECT_MAPPING_KEY);
				if (!data) {
					const subjectMaster = getSubjectMaster();
					const subjectMap = {};
					subjectMaster.forEach(s => { subjectMap[s.name] = s.id; });
					
					const defaultMapping = {
						'1': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education']].filter(Boolean),
						'2': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education']].filter(Boolean),
						'3': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education']].filter(Boolean),
						'4': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education']].filter(Boolean),
						'5': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education']].filter(Boolean),
						'6': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education'], subjectMap['Computer Science']].filter(Boolean),
						'7': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education'], subjectMap['Computer Science']].filter(Boolean),
						'8': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education'], subjectMap['Computer Science']].filter(Boolean),
						'9': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education'], subjectMap['Computer Science']].filter(Boolean),
						'10': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Science'], subjectMap['Social Studies'], subjectMap['Art'], subjectMap['Physical Education'], subjectMap['Computer Science']].filter(Boolean),
						'11': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Physics'], subjectMap['Chemistry'], subjectMap['Biology'], subjectMap['Computer Science'], subjectMap['Physical Education']].filter(Boolean),
						'12': [subjectMap['English'], subjectMap['Mathematics'], subjectMap['Physics'], subjectMap['Chemistry'], subjectMap['Biology'], subjectMap['Computer Science'], subjectMap['Physical Education']].filter(Boolean)
					};
					localStorage.setItem(CLASS_SUBJECT_MAPPING_KEY, JSON.stringify(defaultMapping));
				}
			} catch (e) {
				console.error('Error initializing Class-Subject Mapping:', e);
			}
		}

		function getClassSubjectMapping() {
			try {
				const data = localStorage.getItem(CLASS_SUBJECT_MAPPING_KEY);
				return data ? JSON.parse(data) : {};
			} catch (e) {
				return {};
			}
		}

		// Get subjects for a class from Class-Subject Mapping
		function getSubjectsForClass(classId) {
			const mapping = getClassSubjectMapping();
			const subjectIds = mapping[classId] || [];
			const subjectMaster = getSubjectMaster();
			const subjectMap = {};
			subjectMaster.forEach(s => { subjectMap[s.id] = s; });
			
			// Return subject names (read-only) in the order they appear in mapping
			return subjectIds
				.map(id => subjectMap[id])
				.filter(Boolean)
				.filter(s => s.isActive)
				.map(s => s.name);
		}

		// ==================== CLASS-SECTION MAPPING ====================
		// Initialize Class-Section Mapping
		function initializeClassSectionMapping() {
			try {
				const data = localStorage.getItem(CLASS_SECTION_MAPPING_KEY);
				if (!data) {
					const defaultMapping = {
						'1': ['A', 'B', 'C'],
						'2': ['A', 'B', 'C'],
						'3': ['A', 'B', 'C'],
						'4': ['A', 'B', 'C'],
						'5': ['A', 'B', 'C'],
						'6': ['A', 'B', 'C'],
						'7': ['A', 'B', 'C'],
						'8': ['A', 'B', 'C'],
						'9': ['A', 'B', 'C'],
						'10': ['A', 'B', 'C', 'Science', 'Commerce', 'Arts'],
						'11': ['A', 'B', 'C', 'Science', 'Commerce', 'Arts'],
						'12': ['A', 'B', 'C', 'Science', 'Commerce', 'Arts']
					};
					localStorage.setItem(CLASS_SECTION_MAPPING_KEY, JSON.stringify(defaultMapping));
				}
			} catch (e) {
				console.error('Error initializing Class-Section Mapping:', e);
			}
		}

		function getSectionsForClass(classId) {
			try {
				const data = localStorage.getItem(CLASS_SECTION_MAPPING_KEY);
				const mapping = data ? JSON.parse(data) : {};
				return mapping[classId] || [];
			} catch (e) {
				return [];
			}
		}

		// ==================== EXAM SUBJECTS MANAGEMENT ====================
		let loadedSubjects = [];
		let subjectMarksData = {};

		function renderSubjectsTable(subjects) {
			const tbody = document.getElementById('subjectsMarksTableBody');
			if (!subjects || subjects.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="3" class="subjects-empty-state">
							<i class="fas fa-book-open"></i>
							<p>No subjects found for this class. Please configure Class-Subject mapping first.</p>
						</td>
					</tr>
				`;
				return;
			}

			// Subjects are read-only (from Class-Subject mapping)
			tbody.innerHTML = subjects.map((subject, idx) => {
				const key = subject;
				const existing = subjectMarksData[key] || {};
				return `
					<tr data-subject="${subject}">
						<td class="subject-name-cell" style="font-weight: 600; color: #1e293b;">${subject}</td>
						<td>
							<input type="number" 
								class="subject-marks-input" 
								data-subject="${subject}"
								data-type="max"
								value="${existing.maxMarks || ''}"
								placeholder="100"
								min="0"
								step="1"
								required>
						</td>
						<td>
							<input type="number" 
								class="subject-marks-input" 
								data-subject="${subject}"
								data-type="pass"
								value="${existing.passMarks || ''}"
								placeholder="33"
								min="0"
								step="1">
						</td>
					</tr>
				`;
			}).join('');

			// Attach event listeners
			document.querySelectorAll('.subject-marks-input').forEach(input => {
				input.addEventListener('input', function() {
					const subject = this.dataset.subject;
					const type = this.dataset.type;
					const value = this.value ? parseInt(this.value) : '';
					
					if (!subjectMarksData[subject]) {
						subjectMarksData[subject] = {};
					}
					
					if (type === 'max') {
						subjectMarksData[subject].maxMarks = value;
						// Auto-calculate pass marks if not set (33% of max)
						if (!subjectMarksData[subject].passMarks && value) {
							const passMarks = Math.round(value * 0.33);
							const passInput = document.querySelector(`input[data-subject="${subject}"][data-type="pass"]`);
							if (passInput) {
								passInput.value = passMarks;
								subjectMarksData[subject].passMarks = passMarks;
							}
						}
					} else {
						subjectMarksData[subject].passMarks = value;
					}
				});
			});
		}

		function applySameMarksToAll() {
			const maxMarks = prompt('Enter Max Marks to apply to all subjects:', '100');
			if (!maxMarks || isNaN(maxMarks)) return;
			
			const max = parseInt(maxMarks);
			const pass = Math.round(max * 0.33);
			
			document.querySelectorAll('.subject-marks-input[data-type="max"]').forEach(input => {
				input.value = max;
				const subject = input.dataset.subject;
				if (!subjectMarksData[subject]) subjectMarksData[subject] = {};
				subjectMarksData[subject].maxMarks = max;
			});
			
			document.querySelectorAll('.subject-marks-input[data-type="pass"]').forEach(input => {
				input.value = pass;
				const subject = input.dataset.subject;
				if (!subjectMarksData[subject]) subjectMarksData[subject] = {};
				subjectMarksData[subject].passMarks = pass;
			});
			
			notify(`Applied ${max} marks (Pass: ${pass}) to all subjects!`);
		}

		// Load sections dynamically based on class
		function loadSectionsForClass(classId) {
			const sectionSelect = document.getElementById('examSection');
			sectionSelect.innerHTML = '<option value="">Select Section</option>';
			
			if (!classId) {
				return;
			}
			
			const sections = getSectionsForClass(classId);
			sections.forEach(section => {
				const option = document.createElement('option');
				option.value = section;
				option.textContent = section.length === 1 ? `Section ${section}` : section;
				sectionSelect.appendChild(option);
			});
		}

		function openModal(isEdit = false, idx = -1) {
			document.getElementById('modalTitle').textContent = isEdit ? 'Edit Exam' : 'Add New Exam';
			document.getElementById('editingId').value = isEdit ? idx : -1;
			
			// Reset form
			document.getElementById('examType').value = '';
			document.getElementById('examClass').value = '';
			document.getElementById('examSection').value = '';
			document.getElementById('examSection').innerHTML = '<option value="">Select Section</option>';
			document.getElementById('examName').value = '';
			document.getElementById('examDate').value = '';
			document.getElementById('examTime').value = '09:00';
			document.getElementById('examDuration').value = 180;
			document.getElementById('examStatus').value = 'Scheduled';
			
			// Reset subjects section
			document.getElementById('subjectsMarksSection').style.display = 'none';
			loadedSubjects = [];
			subjectMarksData = {};
			
			if (isEdit && exams[idx]) {
				const e = exams[idx];
				document.getElementById('examName').value = e.name || '';
				document.getElementById('examClass').value = e.class || '';
				document.getElementById('examDate').value = e.date || '';
				document.getElementById('examTime').value = e.time || '09:00';
				document.getElementById('examDuration').value = e.duration || 180;
				document.getElementById('examStatus').value = e.status || 'Scheduled';
				
				// Load sections for the class
				if (e.class) {
					loadSectionsForClass(e.class);
					document.getElementById('examSection').value = e.section || '';
				}
				
				// Load existing subject marks if available
				if (e.examType) document.getElementById('examType').value = e.examType;
				if (e.subjects && Array.isArray(e.subjects)) {
					loadedSubjects = e.subjects.map(s => s.name);
					subjectMarksData = {};
					e.subjects.forEach(s => {
						subjectMarksData[s.name] = {
							maxMarks: s.maxMarks || '',
							passMarks: s.passMarks || ''
						};
					});
					renderSubjectsTable(loadedSubjects);
					document.getElementById('subjectsMarksSection').style.display = 'block';
				}
			}
			
			document.getElementById('examModal').classList.add('active');
		}

		function closeModal() { document.getElementById('examModal').classList.remove('active'); }

		// ==================== VIEW EXAM MODAL ====================
		function viewExam(idx) {
			const exam = exams[idx];
			if (!exam) {
				notify('Exam not found', 'error');
				return;
			}

			const body = document.getElementById('viewExamBody');
			const examType = exam.examType || 'N/A';
			const section = exam.section || 'N/A';
			const date = exam.date ? formatDate(exam.date) : 'N/A';
			const time = exam.time || 'N/A';
			const duration = exam.duration || 0;
			const maxMarks = exam.max || 0;
			const status = exam.status || 'N/A';
			const statusClass = (exam.status || '').toLowerCase();

			// Get subject details
			let subjectsHtml = '';
			if (exam.subjects && exam.subjects.length > 0) {
				subjectsHtml = exam.subjects.map((s, i) => `
					<div class="view-subject-item">
						<div class="view-subject-number">${i + 1}</div>
						<div class="view-subject-details">
							<div class="view-subject-name">${s.name}</div>
							<div class="view-subject-marks">
								<span class="view-marks-badge max">Max: ${s.maxMarks}</span>
								<span class="view-marks-badge pass">Pass: ${s.passMarks}</span>
							</div>
						</div>
					</div>
				`).join('');
			} else {
				subjectsHtml = '<div class="view-no-subjects">No subjects configured</div>';
			}

			body.innerHTML = `
				<div class="view-exam-content">
					<!-- Exam Header Card -->
					<div class="view-exam-header-card">
						<div class="view-exam-icon">
							<i class="fas fa-file-alt"></i>
						</div>
						<div class="view-exam-title-section">
							<h2 class="view-exam-name">${exam.name}</h2>
							<div class="view-exam-id">${exam.id}</div>
						</div>
						<div class="view-exam-status-badge ${statusClass}">
							${status}
						</div>
					</div>

					<!-- Exam Details Grid -->
					<div class="view-exam-details-grid">
						<div class="view-detail-item">
							<div class="view-detail-icon">
								<i class="fas fa-calendar-alt"></i>
							</div>
							<div class="view-detail-content">
								<div class="view-detail-label">Exam Type</div>
								<div class="view-detail-value">${examType}</div>
							</div>
						</div>
						<div class="view-detail-item">
							<div class="view-detail-icon">
								<i class="fas fa-graduation-cap"></i>
							</div>
							<div class="view-detail-content">
								<div class="view-detail-label">Class</div>
								<div class="view-detail-value">Class ${exam.class}</div>
							</div>
						</div>
						<div class="view-detail-item">
							<div class="view-detail-icon">
								<i class="fas fa-users"></i>
							</div>
							<div class="view-detail-content">
								<div class="view-detail-label">Section</div>
								<div class="view-detail-value">${section}</div>
							</div>
						</div>
						<div class="view-detail-item">
							<div class="view-detail-icon">
								<i class="fas fa-calendar"></i>
							</div>
							<div class="view-detail-content">
								<div class="view-detail-label">Date</div>
								<div class="view-detail-value">${date}</div>
							</div>
						</div>
						<div class="view-detail-item">
							<div class="view-detail-icon">
								<i class="fas fa-clock"></i>
							</div>
							<div class="view-detail-content">
								<div class="view-detail-label">Time</div>
								<div class="view-detail-value">${time}</div>
							</div>
						</div>
						<div class="view-detail-item">
							<div class="view-detail-icon">
								<i class="fas fa-hourglass-half"></i>
							</div>
							<div class="view-detail-content">
								<div class="view-detail-label">Duration</div>
								<div class="view-detail-value">${duration} mins</div>
							</div>
						</div>
						<div class="view-detail-item full-width">
							<div class="view-detail-icon">
								<i class="fas fa-trophy"></i>
							</div>
							<div class="view-detail-content">
								<div class="view-detail-label">Total Max Marks</div>
								<div class="view-detail-value highlight">${maxMarks} marks</div>
							</div>
						</div>
					</div>

					<!-- Subjects Section -->
					<div class="view-subjects-section">
						<div class="view-subjects-header">
							<i class="fas fa-book"></i>
							<h3>Subject-wise Marks Configuration</h3>
							<span class="view-subjects-count">${exam.subjects ? exam.subjects.length : 0} Subject${exam.subjects && exam.subjects.length !== 1 ? 's' : ''}</span>
						</div>
						<div class="view-subjects-list">
							${subjectsHtml}
						</div>
					</div>
				</div>
			`;

			// Store the exam index for edit button
			document.getElementById('editFromViewBtn').dataset.examIdx = idx;

			// Show modal
			document.getElementById('viewExamModal').classList.add('active');
		}

		function closeViewModal() {
			document.getElementById('viewExamModal').classList.remove('active');
		}

		function saveExam() {
			const name = document.getElementById('examName').value.trim();
			const examType = document.getElementById('examType').value;
			const klass = document.getElementById('examClass').value;
			const section = document.getElementById('examSection').value;
			const date = document.getElementById('examDate').value;
			const time = document.getElementById('examTime').value;
			const duration = parseInt(document.getElementById('examDuration').value) || 180;
			const status = document.getElementById('examStatus').value;

			// Validation
			if (!name) { notify('Please enter exam name', 'error'); return; }
			if (!examType) { notify('Please select exam type', 'error'); return; }
			if (!klass) { notify('Please select class', 'error'); return; }
			if (!section) { notify('Please select section', 'error'); return; }
			if (!date) { notify('Please select date', 'error'); return; }

			// Validate that subjects are loaded
			if (loadedSubjects.length === 0) {
				notify('Please load subjects for this class first', 'error');
				return;
			}

			// Validate subject marks - all subjects must have max marks
			let hasErrors = false;
			loadedSubjects.forEach(subject => {
				const data = subjectMarksData[subject];
				if (!data || !data.maxMarks || data.maxMarks <= 0) {
					hasErrors = true;
				}
			});
			if (hasErrors) {
				notify('Please enter max marks for all subjects', 'error');
				return;
			}

			// Get subject IDs from Subject Master
			const subjectMaster = getSubjectMaster();
			const subjectIdMap = {};
			subjectMaster.forEach(s => { subjectIdMap[s.name] = s.id; });

			// Prepare subjects array with subject IDs
			const subjects = loadedSubjects.map(subject => {
				const data = subjectMarksData[subject] || {};
				const subjectId = subjectIdMap[subject] || subject; // Fallback to name if ID not found
				return {
					subjectId: subjectId,
					name: subject,
					maxMarks: parseInt(data.maxMarks) || 100,
					passMarks: parseInt(data.passMarks) || Math.round((parseInt(data.maxMarks) || 100) * 0.33)
				};
			});

			// Calculate overall max marks (sum of all subject max marks)
			const totalMaxMarks = subjects.reduce((sum, s) => sum + (s.maxMarks || 0), 0);

			// Prepare exam header
			const examHeader = {
				name,
				examType,
				class: klass,
				section: section,
				date,
				time,
				duration,
				max: totalMaxMarks,
				status,
				subjects: subjects,
				createdAt: new Date().toISOString(),
				updatedAt: new Date().toISOString()
			};

			const editIdx = parseInt(document.getElementById('editingId').value);
			if (editIdx >= 0) {
				// Update existing exam
				exams[editIdx] = { 
					...exams[editIdx], 
					...examHeader,
					updatedAt: new Date().toISOString()
				};
				notify('Exam updated successfully!');
			} else {
				// Create new exam
				const newId = 'EXM' + String(exams.length + 1).padStart(3, '0');
				exams.unshift({ 
					id: newId,
					...examHeader
				});
				notify('Exam added successfully!');
			}
			
			saveExams();
			closeModal();
			renderStats();
			renderTable();
		}

		// Load Subjects Button Handler - Fetches from Class-Subject Mapping
		document.getElementById('loadSubjectsBtn').addEventListener('click', function() {
			const examType = document.getElementById('examType').value;
			const klass = document.getElementById('examClass').value;

			if (!examType) {
				notify('Please select exam type', 'error');
				return;
			}
			if (!klass) {
				notify('Please select class', 'error');
				return;
			}

			// Load subjects from Class-Subject Mapping (NOT from timetable)
			loadedSubjects = getSubjectsForClass(klass);
			
			if (loadedSubjects.length === 0) {
				notify('No subjects found for this class. Please configure Class-Subject mapping in Settings.', 'error');
				document.getElementById('subjectsMarksSection').style.display = 'none';
				return;
			}

			// Reset subject marks data
			subjectMarksData = {};
			
			// Render subjects table (subjects are read-only)
			renderSubjectsTable(loadedSubjects);
			
			// Show subjects section
			document.getElementById('subjectsMarksSection').style.display = 'block';
			
			notify(`Loaded ${loadedSubjects.length} subject(s) for Class ${klass} from Class-Subject mapping`, 'success');
		});

		// Load sections when class changes
		document.getElementById('examClass').addEventListener('change', function() {
			const classId = this.value;
			loadSectionsForClass(classId);
			// Reset section selection
			document.getElementById('examSection').value = '';
			// Hide subjects section when class changes
			document.getElementById('subjectsMarksSection').style.display = 'none';
			loadedSubjects = [];
			subjectMarksData = {};
		});

		// Apply Same Marks Button
		document.getElementById('applySameMarksBtn').addEventListener('click', applySameMarksToAll);

		function deleteExam(idx) {
			const e = exams[idx];
			if (!e) return;
			if (!confirm(`Delete "${e.name}"?`)) return;
			exams.splice(idx, 1);
			saveExams();
			notify('Exam deleted!');
			renderStats();
			renderTable();
		}

		function exportCSV() {
			if (!exams.length) { notify('No exams to export', 'error'); return; }
			const headers = ['S.No', 'Exam ID', 'Name', 'Subject', 'Class', 'Date', 'Time', 'Duration', 'Max Marks', 'Status'];
			let csv = '\uFEFF' + headers.join(',') + '\n';
			exams.forEach((e, i) => {
				csv += [i + 1, e.id, e.name, e.subject, 'Class ' + e.class, e.date, e.time || '-', e.duration, e.max, e.status].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',') + '\n';
			});
			const blob = new Blob([csv], { type: 'application/vnd.ms-excel;charset=utf-8' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = `Exams_${new Date().toISOString().slice(0, 10)}.csv`;
			link.click();
			notify('Exported to Excel!');
		}

		// Event Listeners
		document.getElementById('addExamBtn').addEventListener('click', () => openModal(false));
		document.getElementById('fabAddBtn').addEventListener('click', () => openModal(false));
		document.getElementById('closeModal').addEventListener('click', closeModal);
		document.getElementById('cancelBtn').addEventListener('click', closeModal);
		document.getElementById('saveBtn').addEventListener('click', saveExam);
		document.getElementById('exportBtn').addEventListener('click', exportCSV);
		document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
		document.getElementById('searchInput').addEventListener('input', () => { page = 1; renderTable(); });
		document.getElementById('statusFilter').addEventListener('change', () => { page = 1; renderTable(); });
		document.getElementById('prevBtn').addEventListener('click', () => { if (page > 1) { page--; renderTable(); } });
		document.getElementById('nextBtn').addEventListener('click', () => { page++; renderTable(); });
		document.getElementById('pageSizeSelect').addEventListener('change', e => { pageSize = parseInt(e.target.value); page = 1; renderTable(); });

		document.getElementById('selectAll').addEventListener('change', e => {
			const search = document.getElementById('searchInput').value.toLowerCase();
			const statusFilter = document.getElementById('statusFilter').value;
			let filtered = exams.filter(ex => (!search || [ex.id, ex.name, ex.subject, ex.class].join(' ').toLowerCase().includes(search)) && (!statusFilter || ex.status === statusFilter));
			const start = (page - 1) * pageSize;
			filtered.slice(start, start + pageSize).forEach(ex => { if (e.target.checked) selected.add(ex.id); else selected.delete(ex.id); });
			renderTable();
		});

		document.getElementById('tableBody').addEventListener('change', e => {
			if (e.target.classList.contains('custom-checkbox')) {
				const id = e.target.dataset.id;
				if (e.target.checked) selected.add(id); else selected.delete(id);
				document.getElementById('bulkDeleteBtn').disabled = selected.size === 0;
			}
		});

		document.getElementById('tableBody').addEventListener('click', e => {
			const btn = e.target.closest('[data-action]');
			const cell = e.target.closest('td');
			const row = e.target.closest('tr');
			
			// Handle buttons
			if (btn) {
				const idx = parseInt(btn.dataset.idx);
				if (btn.dataset.action === 'view') viewExam(idx);
				if (btn.dataset.action === 'edit') openModal(true, idx);
				if (btn.dataset.action === 'delete') deleteExam(idx);
				return;
			}
			
			// Inline editing for cells (skip checkbox and action columns)
			if (cell && row && !cell.querySelector('input') && !cell.querySelector('select')) {
				const cellIdx = cell.cellIndex;
				// Editable columns: 2 (Name), 3 (Subject), 4 (Class), 5 (Date), 6 (Time), 7 (Duration), 8 (Marks)
				if (cellIdx >= 2 && cellIdx <= 8) {
					const originalHTML = cell.innerHTML;
					const originalText = cell.textContent.trim();
					const examIdx = parseInt(row.dataset.idx);
					
					let input;
					if (cellIdx === 5) { // Date
						input = document.createElement('input');
						input.type = 'date';
						input.value = exams[examIdx]?.date || '';
					} else if (cellIdx === 6) { // Time
						input = document.createElement('input');
						input.type = 'time';
						input.value = exams[examIdx]?.time || '09:00';
					} else {
						input = document.createElement('input');
						input.type = 'text';
						input.value = originalText;
					}
					
					input.style.cssText = 'width: 100%; padding: 8px; border: 2px solid #f59e0b; border-radius: 6px; font-size: 13px;';
					cell.innerHTML = '';
					cell.appendChild(input);
					input.focus();
					if (input.select) input.select();
					
					const saveEdit = () => {
						let newValue = input.value.trim() || originalText;
						
						// Update actual data
						if (examIdx >= 0 && exams[examIdx]) {
							if (cellIdx === 2) exams[examIdx].name = newValue;
							if (cellIdx === 3) exams[examIdx].subject = newValue;
							if (cellIdx === 4) exams[examIdx].class = newValue.replace('Class ', '');
							if (cellIdx === 5) { exams[examIdx].date = input.value; newValue = formatDate(input.value); }
							if (cellIdx === 6) exams[examIdx].time = input.value;
							if (cellIdx === 7) exams[examIdx].duration = parseInt(newValue) || 180;
							if (cellIdx === 8) exams[examIdx].max = parseInt(newValue) || 100;
							saveExams();
						}
						
						renderTable();
						notify('Updated!', 'success');
					};
					
					input.addEventListener('blur', saveEdit);
					input.addEventListener('keydown', (ev) => {
						if (ev.key === 'Enter') input.blur();
						if (ev.key === 'Escape') { renderTable(); }
					});
				}
			}
		});

		document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
			if (selected.size === 0) return;
			if (!confirm(`Delete ${selected.size} exams?`)) return;
			exams = exams.filter(e => !selected.has(e.id));
			selected.clear();
			saveExams();
			notify('Deleted selected exams!');
			renderStats();
			renderTable();
		});

		document.getElementById('examModal').addEventListener('click', e => { if (e.target.id === 'examModal') closeModal(); });
		document.getElementById('viewExamModal').addEventListener('click', e => { if (e.target.id === 'viewExamModal') closeViewModal(); });
		document.getElementById('closeViewModal').addEventListener('click', closeViewModal);
		document.getElementById('closeViewModalBtn').addEventListener('click', closeViewModal);
		document.getElementById('editFromViewBtn').addEventListener('click', function() {
			const idx = parseInt(this.dataset.examIdx);
			closeViewModal();
			setTimeout(() => openModal(true, idx), 300);
		});
		document.addEventListener('keydown', e => { 
			if (e.key === 'Escape') {
				closeModal();
				closeViewModal();
			}
		});

		// ==================== EXAM MARKS TAB ====================
		const MARKS_STORAGE_KEY = 'edu_student_exam_marks';
		let currentMarksData = {};
		let currentExam = null;
		let currentClass = '';
		let currentSection = '';

		function loadExamMarks() {
			try {
				const data = localStorage.getItem(MARKS_STORAGE_KEY);
				if (data) {
					currentMarksData = JSON.parse(data);
				} else {
					currentMarksData = {};
				}
			} catch (e) {
				currentMarksData = {};
			}
		}

		function saveExamMarks() {
			localStorage.setItem(MARKS_STORAGE_KEY, JSON.stringify(currentMarksData));
		}

		function loadStudents() {
			try {
				const data = localStorage.getItem('edu_students');
				if (data) {
					return JSON.parse(data);
				}
			} catch (e) {}
			return [];
		}

		function populateExamSelect() {
			const select = document.getElementById('marksExamSelect');
			select.innerHTML = '<option value="">Select Exam</option>';
			exams.forEach(exam => {
				const option = document.createElement('option');
				const subjectInfo = exam.subjects && exam.subjects.length > 0 
					? `${exam.subjects.length} Subject${exam.subjects.length > 1 ? 's' : ''}` 
					: (exam.subject || 'N/A');
				option.value = exam.id;
				option.textContent = `${exam.name} - ${exam.examType || ''} (Class ${exam.class}${exam.section ? ' - ' + exam.section : ''})`;
				option.dataset.exam = JSON.stringify(exam);
				select.appendChild(option);
			});
		}

		// Store all marks data for filtering
		let allMarksData = [];
		let filteredMarksData = [];

		function loadMarksTable() {
			const examId = document.getElementById('marksExamSelect').value;
			const klass = document.getElementById('marksClassSelect').value;
			const section = document.getElementById('marksSectionSelect').value;

			if (!examId || !klass || !section) {
				document.getElementById('marksTableContainer').style.display = 'none';
				document.getElementById('marksTableFilters').style.display = 'none';
				document.getElementById('marksActionsBar').style.display = 'none';
				document.getElementById('marksEmptyState').style.display = 'block';
				document.getElementById('marksInfoBar').style.display = 'none';
				return;
			}

			// Get selected exam
			const examOption = document.getElementById('marksExamSelect').selectedOptions[0];
			if (!examOption) return;
			currentExam = JSON.parse(examOption.dataset.exam);
			currentClass = klass;
			currentSection = section;

			// Load students for this class and section
			const allStudents = loadStudents();
			const filteredStudents = allStudents.filter(s => 
				s.class === klass && s.section === section && s.status === 'Active'
			);

			if (filteredStudents.length === 0) {
				document.getElementById('marksTableContainer').style.display = 'none';
				document.getElementById('marksTableFilters').style.display = 'none';
				document.getElementById('marksActionsBar').style.display = 'none';
				document.getElementById('marksEmptyState').innerHTML = `
					<i class="fas fa-users" style="font-size: 72px; color: #e2e8f0; margin-bottom: 24px; opacity: 0.6;"></i>
					<h3 style="font-size: 20px; color: #475569; margin-bottom: 12px; font-weight: 700;">No Students Found</h3>
					<p style="color: #94a3b8; font-size: 15px;">No active students found for Class ${klass}, Section ${section}</p>
				`;
				document.getElementById('marksEmptyState').style.display = 'block';
				document.getElementById('marksInfoBar').style.display = 'none';
				return;
			}

			// Load existing marks
			loadExamMarks();

			// Get subjects from exam
			const subjects = currentExam.subjects || [];
			if (subjects.length === 0) {
				notify('No subjects configured for this exam', 'error');
				return;
			}

			// Build all marks data array (student x subject)
			allMarksData = [];
			filteredStudents.forEach(student => {
				subjects.forEach(subject => {
					const key = `${student.id}_${examId}_${subject.name || subject.subjectId}`;
					const existingMark = currentMarksData[key] || {};
					
					const totalMarks = existingMark.totalMarks || subject.maxMarks || 100;
					const passMarks = subject.passMarks || Math.round(totalMarks * 0.33);
					const obtainedMarks = existingMark.obtainedMarks || existingMark.marks || 0;
					const calculatedStatus = obtainedMarks >= passMarks ? 'Pass' : 'Fail';
					
					const markData = {
						studentId: student.id,
						studentName: student.name,
						class: klass,
						section: section,
						examId: examId,
						examName: currentExam.name,
						subjectId: subject.subjectId || subject.name,
						subjectName: subject.name,
						totalMarks: totalMarks,
						assignmentMarks: existingMark.assignmentMarks || 0,
						internalMarks: existingMark.internalMarks || 0,
						practicalMarks: existingMark.practicalMarks || 0,
						obtainedMarks: obtainedMarks,
						passMarks: passMarks,
						status: existingMark.status || calculatedStatus,
						remarks: existingMark.remarks || '',
						key: key
					};
					
					allMarksData.push(markData);
				});
			});

			// Populate subject filter
			const subjectSelect = document.getElementById('subjectFilterSelect');
			if (subjectSelect) {
				subjectSelect.innerHTML = '<option value="">All Subjects</option>';
				subjects.forEach(subject => {
					const option = document.createElement('option');
					option.value = subject.name || subject;
					option.textContent = subject.name || subject;
					subjectSelect.appendChild(option);
				});
				
				// Re-attach event listener after populating
				subjectSelect.removeEventListener('change', applyMarksFilters);
				subjectSelect.addEventListener('change', applyMarksFilters);
			}

			// Reset marks range inputs
			const minInput = document.getElementById('minMarksInput');
			const maxInput = document.getElementById('maxMarksInput');
			if (minInput) minInput.value = '';
			if (maxInput) maxInput.value = '';

			// Reset filter chips to 'all'
			document.querySelectorAll('.filter-chip').forEach(chip => {
				chip.classList.remove('active');
				if (chip.dataset.filter === 'all') {
					chip.classList.add('active');
				}
			});

			// Apply filters
			applyMarksFilters();

			// Show UI elements
			document.getElementById('marksActionsBar').style.display = 'flex';
			document.getElementById('marksTableFilters').style.display = 'flex';
			document.getElementById('marksInfoBar').style.display = 'flex';
			
			// Show analytics toggle (dashboard hidden by default)
			setTimeout(() => {
				renderAnalyticsDashboard();
			}, 300);
		}

		function applyMarksFilters() {
			if (!allMarksData || allMarksData.length === 0) {
				filteredMarksData = [];
				renderMarksTable();
				return;
			}

			const activeFilter = document.querySelector('.filter-chip.active')?.dataset.filter || 'all';
			const subjectFilter = document.getElementById('subjectFilterSelect')?.value || '';
			const minMarksInput = document.getElementById('minMarksInput');
			const maxMarksInput = document.getElementById('maxMarksInput');
			const minMarks = minMarksInput && minMarksInput.value ? parseFloat(minMarksInput.value) : 0;
			const maxMarks = maxMarksInput && maxMarksInput.value ? parseFloat(maxMarksInput.value) : 999999;

			filteredMarksData = allMarksData.filter(mark => {
				// Subject filter
				if (subjectFilter && mark.subjectName !== subjectFilter) return false;
				
				// Marks range filter
				const obtainedMarks = parseFloat(mark.obtainedMarks) || 0;
				const totalMarks = parseFloat(mark.totalMarks) || 100;
				
				if (minMarksInput && minMarksInput.value && obtainedMarks < minMarks) return false;
				if (maxMarksInput && maxMarksInput.value && obtainedMarks > maxMarks) return false;
				
				// Quick filters
				if (activeFilter === 'low') {
					const percentage = totalMarks > 0 ? (obtainedMarks / totalMarks) * 100 : 0;
					if (percentage >= 50) return false; // Low marks = below 50%
				} else if (activeFilter === 'failed') {
					if (mark.status !== 'Fail') return false;
				}
				// 'all' filter - no additional filtering needed
				
				return true;
			});

			renderMarksTable();
		}

		function renderMarksTable() {
			const tbody = document.getElementById('marksTableBody');
			
			if (filteredMarksData.length === 0) {
				const hasFilters = document.getElementById('subjectFilterSelect').value || 
					document.getElementById('minMarksInput').value || 
					document.getElementById('maxMarksInput').value ||
					document.querySelector('.filter-chip.active')?.dataset.filter !== 'all';
				
				tbody.innerHTML = `
					<tr>
						<td colspan="16" style="text-align: center; padding: 40px;">
							<i class="fas fa-${hasFilters ? 'search' : 'database'}" style="font-size: 48px; color: #e2e8f0; margin-bottom: 16px;"></i>
							<p style="color: #94a3b8; font-size: 14px; margin-bottom: 8px;">
								${hasFilters ? 'No marks found matching the selected filters' : 'No marks data available'}
							</p>
							${!hasFilters ? '<p style="color: #94a3b8; font-size: 12px;">Upload Excel file or add marks manually to get started</p>' : ''}
						</td>
					</tr>
				`;
				document.getElementById('marksTableContainer').style.display = 'block';
				document.getElementById('marksEmptyState').style.display = 'none';
				return;
			}

			// Calculate ranks before rendering
			const ranks = calculateRanks();
			
			tbody.innerHTML = filteredMarksData.map((mark, idx) => {
				const statusClass = mark.status === 'Pass' ? 'status-badge-pass' : 'status-badge-fail';
				const grade = calculateGrade(mark.obtainedMarks, mark.totalMarks);
				const gradeClass = grade ? grade.replace('+', '-plus') : '';
				const rank = ranks[mark.studentId] || '-';
				const rankClass = rank <= 3 ? 'top' : (rank >= Object.keys(ranks).length - 2 && rank !== '-') ? 'bottom' : '';
				const percentage = mark.totalMarks > 0 ? ((mark.obtainedMarks || 0) / mark.totalMarks * 100).toFixed(1) : 0;
				const cellClass = percentage >= 80 ? 'excellent' : percentage >= 60 ? 'good' : percentage >= 40 ? 'average' : 'poor';
				
				return `
					<tr class="marks-row" data-key="${mark.key}" data-student-id="${mark.studentId}" data-subject="${mark.subjectName}">
						<td class="checkbox-cell">
							<input type="checkbox" class="marks-checkbox" data-key="${mark.key}" 
								${selectedMarks.has(mark.key) ? 'checked' : ''}>
						</td>
						<td style="text-align: center;">${idx + 1}</td>
						<td><span class="marks-student-id">${mark.studentId}</span></td>
						<td><span class="marks-student-name">${mark.studentName}</span></td>
						<td>${mark.subjectName}</td>
						<td style="text-align: center; font-weight: 700;">${mark.totalMarks}</td>
						<td style="text-align: center;">
							<input type="number" class="marks-input" data-field="assignmentMarks" data-key="${mark.key}" 
								value="${mark.assignmentMarks}" min="0" max="${mark.totalMarks}" style="width: 80px;">
						</td>
						<td style="text-align: center;">
							<input type="number" class="marks-input" data-field="internalMarks" data-key="${mark.key}" 
								value="${mark.internalMarks}" min="0" max="${mark.totalMarks}" style="width: 80px;">
						</td>
						<td style="text-align: center;">
							<input type="number" class="marks-input" data-field="practicalMarks" data-key="${mark.key}" 
								value="${mark.practicalMarks}" min="0" max="${mark.totalMarks}" style="width: 80px;">
						</td>
						<td style="text-align: center;">
							<input type="number" class="marks-input color-coded-cell ${cellClass}" data-field="obtainedMarks" data-key="${mark.key}" 
								value="${mark.obtainedMarks}" min="0" max="${mark.totalMarks}" style="width: 80px; font-weight: 700;">
						</td>
						<td class="grade-cell" style="text-align: center;">
							${grade ? `<span class="grade-badge ${gradeClass}">${grade}</span>` : '-'}
						</td>
						<td class="rank-cell" style="text-align: center;">
							${rank !== '-' ? `<span class="rank-indicator ${rankClass}">#${rank}</span>` : '-'}
						</td>
						<td style="text-align: center;" class="status-cell">
							<span class="${statusClass}">${mark.status}</span>
						</td>
						<td class="trend-cell" style="text-align: center;">
							<i class="fas fa-minus trend-arrow stable"></i>
						</td>
						<td class="remarks-cell" title="${mark.remarks}">${mark.remarks || '-'}</td>
						<td style="text-align: center;">
							<button class="action-btn edit" data-action="edit-mark" data-key="${mark.key}" title="Edit">
								<i class="fas fa-edit"></i>
							</button>
						</td>
					</tr>
				`;
			}).join('');

			// Update info bar
			const totalStudents = new Set(filteredMarksData.map(m => m.studentId)).size;
			document.getElementById('marksInfo').innerHTML = `
				<div class="marks-info-item">
					<i class="fas fa-users"></i>
					<span>${totalStudents} Student${totalStudents !== 1 ? 's' : ''}</span>
				</div>
				<div class="marks-info-item">
					<i class="fas fa-book"></i>
					<span>${filteredMarksData.length} Record${filteredMarksData.length !== 1 ? 's' : ''}</span>
				</div>
				<div class="marks-info-item">
					<i class="fas fa-chart-line"></i>
					<span>Pass: ${filteredMarksData.filter(m => m.status === 'Pass').length} | Fail: ${filteredMarksData.filter(m => m.status === 'Fail').length}</span>
				</div>
			`;

			document.getElementById('marksTableContainer').style.display = 'block';
			document.getElementById('marksEmptyState').style.display = 'none';

			// Attach event listeners
			attachMarksEventListeners();
		}

		function attachMarksEventListeners() {
			// Checkbox handlers for bulk selection
			document.querySelectorAll('.marks-checkbox').forEach(checkbox => {
				checkbox.addEventListener('change', function() {
					if (this.checked) {
						selectedMarks.add(this.dataset.key);
					} else {
						selectedMarks.delete(this.dataset.key);
					}
					updateBulkOperationsBar();
				});
			});

			// Marks input change handlers
			document.querySelectorAll('.marks-input').forEach(input => {
				input.addEventListener('input', function() {
					const key = this.dataset.key;
					const field = this.dataset.field;
					const value = parseFloat(this.value) || 0;
					
					// Update local data
					const markData = allMarksData.find(m => m.key === key);
					if (markData) {
						markData[field] = value;
						
						// Auto-calculate status if obtained marks changed
						if (field === 'obtainedMarks') {
							markData.status = value >= markData.passMarks ? 'Pass' : 'Fail';
							// Update status badge in table
							const row = this.closest('tr');
							const statusCell = row.querySelector('td:nth-child(10)');
							if (statusCell) {
								const statusClass = markData.status === 'Pass' ? 'status-badge-pass' : 'status-badge-fail';
								statusCell.innerHTML = `<span class="${statusClass}">${markData.status}</span>`;
							}
						}
					}
				});

				input.addEventListener('blur', function() {
					// Auto-save on blur
					saveSingleMarkFromTable(this.dataset.key);
				});
			});

			// Edit button handlers
			document.querySelectorAll('[data-action="edit-mark"]').forEach(btn => {
				btn.addEventListener('click', function() {
					const key = this.dataset.key;
					openSingleMarkModal(key);
				});
			});
		}

		function saveSingleMarkFromTable(key) {
			const markData = allMarksData.find(m => m.key === key);
			if (!markData) return;

			loadExamMarks();
			currentMarksData[key] = {
				studentId: markData.studentId,
				examId: markData.examId,
				subjectId: markData.subjectId,
				class: markData.class,
				section: markData.section,
				examName: markData.examName,
				subjectName: markData.subjectName,
				totalMarks: markData.totalMarks,
				assignmentMarks: markData.assignmentMarks,
				internalMarks: markData.internalMarks,
				practicalMarks: markData.practicalMarks,
				obtainedMarks: markData.obtainedMarks,
				status: markData.status,
				remarks: markData.remarks,
				updatedAt: new Date().toISOString()
			};
			saveExamMarks();
		}

		function saveAllMarks() {
			if (!currentExam || allMarksData.length === 0) {
				notify('No marks data to save', 'error');
				return;
			}

			loadExamMarks();
			let savedCount = 0;

			allMarksData.forEach(markData => {
				const key = markData.key;
				currentMarksData[key] = {
					studentId: markData.studentId,
					examId: markData.examId,
					subjectId: markData.subjectId,
					class: markData.class,
					section: markData.section,
					examName: markData.examName,
					subjectName: markData.subjectName,
					totalMarks: markData.totalMarks,
					assignmentMarks: markData.assignmentMarks,
					internalMarks: markData.internalMarks,
					practicalMarks: markData.practicalMarks,
					obtainedMarks: markData.obtainedMarks,
					status: markData.status,
					remarks: markData.remarks,
					updatedAt: new Date().toISOString()
				};
				savedCount++;
			});

			saveExamMarks();
			notify(`Marks saved successfully for ${savedCount} record(s)!`, 'success');
		}

		// ==================== EXCEL TEMPLATE DOWNLOAD ====================
		function downloadExcelTemplate() {
			const examId = document.getElementById('marksExamSelect').value;
			const klass = document.getElementById('marksClassSelect').value;
			const section = document.getElementById('marksSectionSelect').value;

			if (!examId || !klass || !section) {
				notify('Please select Exam, Class, and Section first', 'error');
				return;
			}

			const examOption = document.getElementById('marksExamSelect').selectedOptions[0];
			if (!examOption) return;
			const exam = JSON.parse(examOption.dataset.exam);
			const students = loadStudents().filter(s => 
				s.class === klass && s.section === section && s.status === 'Active'
			);

			if (students.length === 0) {
				notify('No students found for the selected filters', 'error');
				return;
			}

			const subjects = exam.subjects || [];
			if (subjects.length === 0) {
				notify('No subjects configured for this exam', 'error');
				return;
			}

			// Build CSV content
			const headers = ['Student ID', 'Student Name', 'Class', 'Section', 'Exam Name', 'Subject Name', 
				'Total Marks', 'Assignment Marks', 'Internal Marks', 'Practical Marks', 
				'Obtained Marks', 'Pass/Fail Status', 'Remarks'];
			
			let csv = '\uFEFF' + headers.join(',') + '\n';

			// Generate rows for each student x subject combination
			students.forEach(student => {
				subjects.forEach(subject => {
					const row = [
						student.id,
						`"${student.name}"`,
						klass,
						section,
						`"${exam.name}"`,
						`"${subject.name}"`,
						subject.maxMarks || 100,
						0,
						0,
						0,
						0,
						'',
						''
					];
					csv += row.join(',') + '\n';
				});
			});

			// Download
			const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = `Exam_Marks_Template_${exam.name}_Class${klass}_${section}_${new Date().toISOString().slice(0, 10)}.csv`;
			link.click();
			notify('Excel template downloaded successfully!', 'success');
		}

		// ==================== EXCEL UPLOAD ====================
		function handleExcelUpload(file) {
			// Check file type
			if (file.name.match(/\.(xlsx|xls)$/i)) {
				notify('Please convert Excel file to CSV format first, or use CSV file', 'error');
				return;
			}

			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					const text = e.target.result;
					// Remove BOM if present
					const cleanText = text.replace(/^\uFEFF/, '');
					const lines = cleanText.split(/\r?\n/).filter(line => line.trim());
					
					if (lines.length < 2) {
						notify('File is empty or invalid. Please ensure file has header row and at least one data row.', 'error');
						return;
					}

					// Parse CSV headers
					const headerLine = parseCSVLine(lines[0]);
					const headers = headerLine.map(h => h.trim().replace(/"/g, '').replace(/\uFEFF/g, ''));
					
					// Validate required headers
					const requiredHeaders = ['Student ID', 'Student Name', 'Subject Name', 'Total Marks', 'Obtained Marks'];
					const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
					if (missingHeaders.length > 0) {
						notify(`Missing required columns: ${missingHeaders.join(', ')}`, 'error');
						return;
					}

					const data = [];
					const errors = [];
					const duplicates = new Set();
					const examId = document.getElementById('marksExamSelect').value;

					for (let i = 1; i < lines.length; i++) {
						if (!lines[i].trim()) continue; // Skip empty lines
						
						const values = parseCSVLine(lines[i]);
						if (values.length < headers.length) {
							errors.push(`Row ${i + 1}: Insufficient columns (expected ${headers.length}, got ${values.length})`);
							continue;
						}

						const row = {};
						headers.forEach((header, idx) => {
							row[header] = (values[idx] || '').trim().replace(/^"|"$/g, '');
						});

						// Validate required fields
						const studentId = row['Student ID'];
						const subjectName = row['Subject Name'];
						
						if (!studentId) {
							errors.push(`Row ${i + 1}: Missing Student ID`);
							continue;
						}
						if (!subjectName) {
							errors.push(`Row ${i + 1}: Missing Subject Name`);
							continue;
						}

						const key = `${studentId}_${examId}_${subjectName}`;
						if (duplicates.has(key)) {
							errors.push(`Row ${i + 1}: Duplicate entry for Student ${studentId} - Subject ${subjectName}`);
							continue;
						}
						duplicates.add(key);

						// Validate and parse marks
						const totalMarks = parseFloat(row['Total Marks']);
						if (isNaN(totalMarks) || totalMarks <= 0) {
							errors.push(`Row ${i + 1}: Invalid Total Marks for ${studentId} - ${subjectName}`);
							continue;
						}

						const assignmentMarks = parseFloat(row['Assignment Marks']) || 0;
						const internalMarks = parseFloat(row['Internal Marks']) || 0;
						const practicalMarks = parseFloat(row['Practical Marks']) || 0;
						const obtainedMarks = parseFloat(row['Obtained Marks']);

						if (isNaN(obtainedMarks) || obtainedMarks < 0) {
							errors.push(`Row ${i + 1}: Invalid Obtained Marks for ${studentId} - ${subjectName}`);
							continue;
						}

						if (obtainedMarks > totalMarks) {
							errors.push(`Row ${i + 1}: Obtained Marks (${obtainedMarks}) exceeds Total Marks (${totalMarks}) for ${studentId} - ${subjectName}`);
							continue;
						}

						// Validate component marks don't exceed total
						const componentTotal = assignmentMarks + internalMarks + practicalMarks;
						if (componentTotal > totalMarks) {
							errors.push(`Row ${i + 1}: Sum of component marks (${componentTotal}) exceeds Total Marks (${totalMarks}) for ${studentId} - ${subjectName}`);
							continue;
						}

						// Calculate status
						const passMarks = Math.round(totalMarks * 0.33);
						let status = row['Pass/Fail Status']?.trim();
						if (!status || (status !== 'Pass' && status !== 'Fail')) {
							status = obtainedMarks >= passMarks ? 'Pass' : 'Fail';
						}

						data.push({
							key: key,
							studentId: studentId,
							examId: examId,
							subjectId: subjectName,
							class: row['Class'] || currentClass,
							section: row['Section'] || currentSection,
							examName: row['Exam Name'] || currentExam.name,
							subjectName: subjectName,
							totalMarks: totalMarks,
							assignmentMarks: assignmentMarks,
							internalMarks: internalMarks,
							practicalMarks: practicalMarks,
							obtainedMarks: obtainedMarks,
							status: status,
							remarks: row['Remarks'] || ''
						});
					}

					if (data.length === 0 && errors.length > 0) {
						notify(`Upload failed: ${errors.length} error(s) found. Please fix and try again.`, 'error');
						if (errors.length <= 10) {
							console.error('Upload errors:', errors);
						}
						return;
					}

					// Save to storage
					loadExamMarks();
					data.forEach(item => {
						currentMarksData[item.key] = {
							...item,
							updatedAt: new Date().toISOString()
						};
					});
					saveExamMarks();

					// Show summary
					const successMsg = `Successfully imported ${data.length} record(s)`;
					if (errors.length > 0) {
						notify(`${successMsg}. ${errors.length} row(s) had errors and were skipped.`, 'warning');
						if (errors.length <= 10) {
							console.warn('Upload errors:', errors);
						}
					} else {
						notify(successMsg, 'success');
					}

					// Reload table
					loadMarksTable();
				} catch (error) {
					notify('Error parsing file: ' + error.message, 'error');
					console.error('Upload error:', error);
				}
			};
			reader.onerror = function() {
				notify('Error reading file', 'error');
			};
			reader.readAsText(file, 'UTF-8');
		}

		function parseCSVLine(line) {
			const result = [];
			let current = '';
			let inQuotes = false;

			for (let i = 0; i < line.length; i++) {
				const char = line[i];
				if (char === '"') {
					inQuotes = !inQuotes;
				} else if (char === ',' && !inQuotes) {
					result.push(current);
					current = '';
				} else {
					current += char;
				}
			}
			result.push(current);
			return result;
		}

		// ==================== SINGLE STUDENT MARK ENTRY ====================
		function openSingleMarkModal(key = null) {
			const modal = document.getElementById('singleMarkModal');
			const title = document.getElementById('singleMarkModalTitle');
			
			if (key) {
				// Edit mode
				title.textContent = 'Edit Student Marks';
				const markData = allMarksData.find(m => m.key === key);
				if (!markData) {
					notify('Mark data not found', 'error');
					return;
				}

				// Show/hide appropriate fields
				document.getElementById('singleStudentIdGroup').style.display = 'block';
				document.getElementById('singleStudentNameGroup').style.display = 'block';
				document.getElementById('singleStudentSelectGroup').style.display = 'none';

				// Populate subject dropdown
				const subjectSelect = document.getElementById('singleSubjectSelect');
				subjectSelect.innerHTML = '<option value="">Select Subject</option>';
				if (currentExam && currentExam.subjects) {
					currentExam.subjects.forEach(subject => {
						const option = document.createElement('option');
						option.value = subject.name;
						option.textContent = subject.name;
						option.dataset.maxMarks = subject.maxMarks || 100;
						option.dataset.passMarks = subject.passMarks || Math.round((subject.maxMarks || 100) * 0.33);
						subjectSelect.appendChild(option);
					});
				}

				document.getElementById('singleStudentId').value = markData.studentId;
				document.getElementById('singleStudentName').value = markData.studentName;
				document.getElementById('singleExamName').value = markData.examName;
				document.getElementById('singleSubjectSelect').value = markData.subjectName;
				document.getElementById('singleTotalMarks').value = markData.totalMarks;
				document.getElementById('singleAssignmentMarks').value = markData.assignmentMarks;
				document.getElementById('singleInternalMarks').value = markData.internalMarks;
				document.getElementById('singlePracticalMarks').value = markData.practicalMarks;
				document.getElementById('singleObtainedMarks').value = markData.obtainedMarks;
				document.getElementById('singleStatusSelect').value = markData.status;
				document.getElementById('singleRemarks').value = markData.remarks;
				document.getElementById('saveSingleMarkBtn').dataset.key = key;
			} else {
				// Add mode
				title.textContent = 'Add Student Marks';
				if (!currentExam || !currentClass || !currentSection) {
					notify('Please select Exam, Class, and Section first', 'error');
					return;
				}

				// Populate subject dropdown
				const subjectSelect = document.getElementById('singleSubjectSelect');
				subjectSelect.innerHTML = '<option value="">Select Subject</option>';
				if (currentExam.subjects) {
					currentExam.subjects.forEach(subject => {
						const option = document.createElement('option');
						option.value = subject.name;
						option.textContent = subject.name;
						option.dataset.maxMarks = subject.maxMarks || 100;
						option.dataset.passMarks = subject.passMarks || Math.round((subject.maxMarks || 100) * 0.33);
						subjectSelect.appendChild(option);
					});
				}

				// Load students
				const students = loadStudents().filter(s => 
					s.class === currentClass && s.section === currentSection && s.status === 'Active'
				);
				
				// Populate student select
				const studentSelect = document.getElementById('singleStudentSelect');
				studentSelect.innerHTML = '<option value="">Select Student</option>';
				students.forEach(s => {
					const option = document.createElement('option');
					option.value = s.id;
					option.textContent = `${s.id} - ${s.name}`;
					studentSelect.appendChild(option);
				});

				// Show/hide appropriate fields
				document.getElementById('singleStudentIdGroup').style.display = 'none';
				document.getElementById('singleStudentNameGroup').style.display = 'none';
				document.getElementById('singleStudentSelectGroup').style.display = 'block';

				document.getElementById('singleExamName').value = currentExam.name;
				document.getElementById('singleTotalMarks').value = '';
				document.getElementById('singleAssignmentMarks').value = '';
				document.getElementById('singleInternalMarks').value = '';
				document.getElementById('singlePracticalMarks').value = '';
				document.getElementById('singleObtainedMarks').value = '';
				document.getElementById('singleStatusSelect').value = 'Pass';
				document.getElementById('singleRemarks').value = '';
				document.getElementById('saveSingleMarkBtn').dataset.key = '';
			}

			modal.classList.add('active');
		}

		function closeSingleMarkModal() {
			document.getElementById('singleMarkModal').classList.remove('active');
		}

		function saveSingleMark() {
			const key = document.getElementById('saveSingleMarkBtn').dataset.key;
			const studentId = document.getElementById('singleStudentId').value || 
				document.getElementById('singleStudentSelect')?.value;
			const subjectName = document.getElementById('singleSubjectSelect').value;
			const totalMarks = parseFloat(document.getElementById('singleTotalMarks').value);
			const assignmentMarks = parseFloat(document.getElementById('singleAssignmentMarks').value) || 0;
			const internalMarks = parseFloat(document.getElementById('singleInternalMarks').value) || 0;
			const practicalMarks = parseFloat(document.getElementById('singlePracticalMarks').value) || 0;
			const obtainedMarks = parseFloat(document.getElementById('singleObtainedMarks').value);
			const status = document.getElementById('singleStatusSelect').value;
			const remarks = document.getElementById('singleRemarks').value;

			if (!studentId) {
				notify('Please select a student', 'error');
				return;
			}
			if (!subjectName) {
				notify('Please select a subject', 'error');
				return;
			}
			if (!totalMarks || totalMarks <= 0) {
				notify('Please enter valid total marks', 'error');
				return;
			}
			if (isNaN(obtainedMarks) || obtainedMarks < 0 || obtainedMarks > totalMarks) {
				notify('Please enter valid obtained marks', 'error');
				return;
			}

			const examId = document.getElementById('marksExamSelect').value;
			const finalKey = key || `${studentId}_${examId}_${subjectName}`;
			const student = loadStudents().find(s => s.id === studentId);

			loadExamMarks();
			currentMarksData[finalKey] = {
				studentId: studentId,
				examId: examId,
				subjectId: subjectName,
				class: currentClass,
				section: currentSection,
				examName: currentExam.name,
				subjectName: subjectName,
				totalMarks: totalMarks,
				assignmentMarks: assignmentMarks,
				internalMarks: internalMarks,
				practicalMarks: practicalMarks,
				obtainedMarks: obtainedMarks,
				status: status,
				remarks: remarks,
				updatedAt: new Date().toISOString()
			};
			saveExamMarks();

			notify('Marks saved successfully!', 'success');
			closeSingleMarkModal();
			loadMarksTable();
		}

		// Tab switching
		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.addEventListener('click', function() {
				const tabName = this.dataset.tab;
				
				// Update tab buttons
				document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
				this.classList.add('active');
				
				// Update tab content
				document.querySelectorAll('.tab-content').forEach(c => {
					c.classList.remove('active');
					c.style.display = 'none';
				});
				
				if (tabName === 'exams') {
					document.getElementById('examsTab').classList.add('active');
					document.getElementById('examsTab').style.display = 'block';
					document.getElementById('fabAddBtn').style.display = 'flex';
				} else if (tabName === 'marks') {
					document.getElementById('marksTab').classList.add('active');
					document.getElementById('marksTab').style.display = 'block';
					document.getElementById('fabAddBtn').style.display = 'none';
					populateExamSelect();
				}
			});
		});

		// Filter change listeners
		document.getElementById('marksExamSelect').addEventListener('change', loadMarksTable);
		document.getElementById('marksClassSelect').addEventListener('change', function() {
			const classId = this.value;
			loadSectionsForMarks(classId);
			document.getElementById('marksSectionSelect').value = '';
			loadMarksTable();
		});
		document.getElementById('marksSectionSelect').addEventListener('change', loadMarksTable);

		// Load sections for marks tab
		function loadSectionsForMarks(classId) {
			const sectionSelect = document.getElementById('marksSectionSelect');
			sectionSelect.innerHTML = '<option value="">Select Section</option>';
			
			if (!classId) return;
			
			const sections = getSectionsForClass(classId);
			sections.forEach(section => {
				const option = document.createElement('option');
				option.value = section;
				option.textContent = section.length === 1 ? `Section ${section}` : section;
				sectionSelect.appendChild(option);
			});
		}

		// Excel Template Download
		document.getElementById('downloadTemplateBtn').addEventListener('click', downloadExcelTemplate);

		// Excel Upload
		document.getElementById('uploadMarksBtn').addEventListener('click', () => {
			document.getElementById('marksFileInput').click();
		});
		document.getElementById('marksFileInput').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (file) {
				if (!file.name.match(/\.(csv|xlsx|xls)$/i)) {
					notify('Please upload a valid CSV or Excel file', 'error');
					return;
				}
				handleExcelUpload(file);
				this.value = ''; // Reset input
			}
		});

		// Single Student Mark Entry
		document.getElementById('addSingleMarkBtn').addEventListener('click', () => openSingleMarkModal());
		document.getElementById('saveSingleMarkBtn').addEventListener('click', saveSingleMark);
		document.getElementById('cancelSingleMarkBtn').addEventListener('click', closeSingleMarkModal);
		document.getElementById('closeSingleMarkModal').addEventListener('click', closeSingleMarkModal);
		document.getElementById('singleMarkModal').addEventListener('click', e => {
			if (e.target.id === 'singleMarkModal') closeSingleMarkModal();
		});

		// Subject select change - auto-update total marks
		document.getElementById('singleSubjectSelect').addEventListener('change', function() {
			const option = this.selectedOptions[0];
			if (option && option.dataset.maxMarks) {
				document.getElementById('singleTotalMarks').value = option.dataset.maxMarks;
			}
		});

		// Auto-calculate status based on obtained marks
		document.getElementById('singleObtainedMarks').addEventListener('input', function() {
			const obtained = parseFloat(this.value) || 0;
			const total = parseFloat(document.getElementById('singleTotalMarks').value) || 100;
			const passMarks = Math.round(total * 0.33);
			const status = obtained >= passMarks ? 'Pass' : 'Fail';
			document.getElementById('singleStatusSelect').value = status;
		});

		// Filter event listeners - Use event delegation for dynamically created elements
		document.addEventListener('click', function(e) {
			if (e.target.closest('.filter-chip')) {
				const chip = e.target.closest('.filter-chip');
				document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
				chip.classList.add('active');
				applyMarksFilters();
			}
		});

		// Subject filter - attach when element exists
		const subjectFilterSelect = document.getElementById('subjectFilterSelect');
		if (subjectFilterSelect) {
			subjectFilterSelect.addEventListener('change', applyMarksFilters);
		}

		// Marks range filters - attach when elements exist
		const minMarksInput = document.getElementById('minMarksInput');
		const maxMarksInput = document.getElementById('maxMarksInput');
		if (minMarksInput) {
			minMarksInput.addEventListener('input', applyMarksFilters);
			minMarksInput.addEventListener('change', applyMarksFilters);
		}
		if (maxMarksInput) {
			maxMarksInput.addEventListener('input', applyMarksFilters);
			maxMarksInput.addEventListener('change', applyMarksFilters);
		}

		// Save All Marks
		document.getElementById('saveAllMarksBtn').addEventListener('click', saveAllMarks);

		// Initialize data structures on page load
		initializeSubjectMaster();
		initializeClassSubjectMapping();
		initializeClassSectionMapping();

		loadExams();
		renderStats();
		renderTable();
		loadExamMarks();

		// ==================== ADVANCED FEATURES IMPLEMENTATION ====================

		// Grade Calculation System
		const GRADE_SCHEME = {
			'A+': { min: 90, max: 100, color: '#16a34a' },
			'A': { min: 80, max: 89, color: '#2563eb' },
			'B+': { min: 70, max: 79, color: '#6366f1' },
			'B': { min: 60, max: 69, color: '#d97706' },
			'C': { min: 50, max: 59, color: '#ea580c' },
			'D': { min: 33, max: 49, color: '#e11d48' },
			'F': { min: 0, max: 32, color: '#dc2626' }
		};

		function calculateGrade(obtainedMarks, totalMarks) {
			if (!obtainedMarks || !totalMarks) return null;
			const percentage = (obtainedMarks / totalMarks) * 100;
			for (const [grade, range] of Object.entries(GRADE_SCHEME)) {
				if (percentage >= range.min && percentage <= range.max) {
					return grade;
				}
			}
			return 'F';
		}

		function calculateCGPA(marksArray) {
			if (!marksArray || marksArray.length === 0) return '0.00';
			
			const gradePoints = { 'A+': 10, 'A': 9, 'B+': 8, 'B': 7, 'C': 6, 'D': 5, 'F': 0 };
			let totalPoints = 0;
			let count = 0;
			
			marksArray.forEach(mark => {
				const obtainedMarks = parseFloat(mark.obtainedMarks) || 0;
				const totalMarks = parseFloat(mark.totalMarks) || 100;
				
				// Only calculate if marks are valid
				if (obtainedMarks >= 0 && totalMarks > 0) {
					const grade = calculateGrade(obtainedMarks, totalMarks);
					if (grade && gradePoints[grade] !== undefined) {
						totalPoints += gradePoints[grade];
						count++;
					}
				}
			});
			
			return count > 0 ? (totalPoints / count).toFixed(2) : '0.00';
		}

		// Analytics Dashboard
		let analyticsExpanded = false;

		function renderAnalyticsDashboard() {
			if (!allMarksData || allMarksData.length === 0) {
				document.getElementById('analyticsDashboard').style.display = 'none';
				document.getElementById('analyticsToggleBar').style.display = 'none';
				return;
			}

			// Show toggle bar
			document.getElementById('analyticsToggleBar').style.display = 'block';
			
			// Only show dashboard if expanded
			if (analyticsExpanded) {
				document.getElementById('analyticsDashboard').style.display = 'block';
				document.getElementById('analyticsDashboard').classList.remove('collapsed');
			} else {
				document.getElementById('analyticsDashboard').style.display = 'none';
			}

			// Calculate statistics
			const stats = calculateStatistics();
			const statsGrid = document.getElementById('analyticsStatsGrid');
			
			statsGrid.innerHTML = `
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Total Students</div>
					<div class="analytics-stat-value">${stats.totalStudents}</div>
					<div class="analytics-stat-change">
						<i class="fas fa-users"></i> ${stats.totalRecords} records
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Average Marks</div>
					<div class="analytics-stat-value">${stats.averageMarks.toFixed(1)}</div>
					<div class="analytics-stat-change ${stats.averageChange >= 0 ? 'positive' : 'negative'}">
						<i class="fas fa-${stats.averageChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
						${Math.abs(stats.averageChange).toFixed(1)}% from class avg
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Pass Percentage</div>
					<div class="analytics-stat-value">${stats.passPercentage.toFixed(1)}%</div>
					<div class="analytics-stat-change">
						<i class="fas fa-check-circle"></i> ${stats.passed} passed, ${stats.failed} failed
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Class CGPA</div>
					<div class="analytics-stat-value">${stats.cgpa}</div>
					<div class="analytics-stat-change">
						<i class="fas fa-star"></i> Average grade point
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Top Performer</div>
					<div class="analytics-stat-value" style="font-size: 18px;">${stats.topPerformer.name || 'N/A'}</div>
					<div class="analytics-stat-change positive">
						<i class="fas fa-trophy"></i> ${stats.topPerformer.marks || 0} marks
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Needs Attention</div>
					<div class="analytics-stat-value" style="font-size: 18px;">${stats.needsAttention}</div>
					<div class="analytics-stat-change negative">
						<i class="fas fa-exclamation-triangle"></i> Below 50%
					</div>
				</div>
			`;

			// Render charts (simplified - would use Chart.js in production)
			renderCharts(stats);
		}

		function calculateStatistics() {
			if (!allMarksData || allMarksData.length === 0) {
				return {
					totalStudents: 0,
					totalRecords: 0,
					averageMarks: 0,
					averageChange: 0,
					passed: 0,
					failed: 0,
					passPercentage: 0,
					cgpa: '0.00',
					needsAttention: 0,
					topPerformer: { name: 'N/A', marks: 0 },
					subjectStats: {}
				};
			}

			const students = new Set();
			let totalMarks = 0;
			let totalRecordsWithMarks = 0;
			let passed = 0;
			let failed = 0;
			let needsAttention = 0;
			let topMarks = -1;
			let topPerformer = { name: 'N/A', marks: 0 };
			const subjectStats = {};

			allMarksData.forEach(mark => {
				// Track unique students
				students.add(mark.studentId);
				
				// Parse marks safely
				const obtainedMarks = parseFloat(mark.obtainedMarks) || 0;
				const totalMarksValue = parseFloat(mark.totalMarks) || 100;
				
				// Calculate total marks for average (only count records with valid marks)
				if (obtainedMarks >= 0 && totalMarksValue > 0) {
					totalMarks += obtainedMarks;
					totalRecordsWithMarks++;
				}
				
				// Count pass/fail based on status or calculate if status is missing
				if (mark.status === 'Pass') {
					passed++;
				} else if (mark.status === 'Fail') {
					failed++;
				} else {
					// Auto-calculate status if not set
					if (totalMarksValue > 0) {
						const passMarks = parseFloat(mark.passMarks) || Math.round(totalMarksValue * 0.33);
						if (obtainedMarks >= passMarks) {
							passed++;
						} else {
							failed++;
						}
					} else {
						failed++;
					}
				}

				// Calculate percentage for needs attention
				if (totalMarksValue > 0) {
					const percentage = (obtainedMarks / totalMarksValue) * 100;
					if (percentage < 50 && obtainedMarks > 0) {
						needsAttention++;
					}
				}

				// Find top performer (only if marks > 0)
				if (obtainedMarks > topMarks && obtainedMarks > 0) {
					topMarks = obtainedMarks;
					topPerformer = { 
						name: mark.studentName || 'N/A', 
						marks: obtainedMarks 
					};
				}

				// Subject-wise statistics
				const subjectName = mark.subjectName || 'Unknown';
				if (!subjectStats[subjectName]) {
					subjectStats[subjectName] = { total: 0, count: 0 };
				}
				if (obtainedMarks >= 0) {
					subjectStats[subjectName].total += obtainedMarks;
					subjectStats[subjectName].count++;
				}
			});

			const totalRecords = allMarksData.length;
			const averageMarks = totalRecordsWithMarks > 0 ? totalMarks / totalRecordsWithMarks : 0;
			const passPercentage = totalRecords > 0 ? (passed / totalRecords) * 100 : 0;
			const cgpa = calculateCGPA(allMarksData);

			// If no top performer found (all marks are 0), show N/A
			if (topMarks < 0) {
				topPerformer = { name: 'N/A', marks: 0 };
			}

			return {
				totalStudents: students.size,
				totalRecords,
				averageMarks: Math.round(averageMarks * 10) / 10, // Round to 1 decimal
				averageChange: 0, // Would calculate from previous exam
				passed,
				failed,
				passPercentage: Math.round(passPercentage * 10) / 10, // Round to 1 decimal
				cgpa,
				needsAttention,
				topPerformer,
				subjectStats
			};
		}

		function renderCharts(stats) {
			// Simplified chart rendering - in production, use Chart.js or similar
			const subjectChart = document.getElementById('subjectChart');
			const passFailChart = document.getElementById('passFailChart');
			
			// Placeholder for charts - would implement with Chart.js
			if (subjectChart) {
				subjectChart.style.display = 'block';
				// Chart.js implementation would go here
			}
			if (passFailChart) {
				passFailChart.style.display = 'block';
				// Chart.js implementation would go here
			}
		}

		// Bulk Operations
		let selectedMarks = new Set();

		document.getElementById('selectAllMarks')?.addEventListener('change', function(e) {
			const checkboxes = document.querySelectorAll('#marksTableBody input[type="checkbox"]');
			checkboxes.forEach(cb => {
				cb.checked = e.target.checked;
				if (e.target.checked) {
					selectedMarks.add(cb.dataset.key);
				} else {
					selectedMarks.delete(cb.dataset.key);
				}
			});
			updateBulkOperationsBar();
		});

		function updateBulkOperationsBar() {
			const count = selectedMarks.size;
			document.getElementById('bulkSelectionCount').textContent = count;
			const bar = document.getElementById('bulkOperationsBar');
			if (count > 0) {
				bar.classList.add('active');
			} else {
				bar.classList.remove('active');
			}
		}

		// Bulk Operations
		document.getElementById('bulkUpdateMarksBtn')?.addEventListener('click', function() {
			if (selectedMarks.size === 0) {
				notify('Please select at least one student', 'error');
				return;
			}
			const marks = prompt('Enter marks to apply to all selected students:');
			if (marks && !isNaN(marks)) {
				let count = 0;
				selectedMarks.forEach(key => {
					const markData = allMarksData.find(m => m.key === key);
					if (markData) {
						const oldValue = markData.obtainedMarks;
						markData.obtainedMarks = parseFloat(marks);
						const percentage = (markData.obtainedMarks / markData.totalMarks) * 100;
						markData.status = percentage >= (markData.passMarks / markData.totalMarks * 100) ? 'Pass' : 'Fail';
						saveMarksHistory('Bulk Update Marks', oldValue, markData.obtainedMarks, key);
						count++;
					}
				});
				loadMarksTable();
				selectedMarks.clear();
				updateBulkOperationsBar();
				notify(`Updated marks for ${count} student(s)`, 'success');
			}
		});

		document.getElementById('bulkUpdateStatusBtn')?.addEventListener('click', function() {
			if (selectedMarks.size === 0) {
				notify('Please select at least one student', 'error');
				return;
			}
			const status = confirm('Mark all selected as Pass? (Cancel for Fail)') ? 'Pass' : 'Fail';
			let count = 0;
			selectedMarks.forEach(key => {
				const markData = allMarksData.find(m => m.key === key);
				if (markData) {
					const oldValue = markData.status;
					markData.status = status;
					saveMarksHistory('Bulk Update Status', oldValue, status, key);
					count++;
				}
			});
			loadMarksTable();
			selectedMarks.clear();
			updateBulkOperationsBar();
			notify(`Updated status for ${count} student(s)`, 'success');
		});

		document.getElementById('bulkAddRemarksBtn')?.addEventListener('click', function() {
			if (selectedMarks.size === 0) {
				notify('Please select at least one student', 'error');
				return;
			}
			const remarks = prompt('Enter remarks to add to all selected students:');
			if (remarks) {
				let count = 0;
				selectedMarks.forEach(key => {
					const markData = allMarksData.find(m => m.key === key);
					if (markData) {
						markData.remarks = remarks;
						count++;
					}
				});
				loadMarksTable();
				selectedMarks.clear();
				updateBulkOperationsBar();
				notify(`Added remarks for ${count} student(s)`, 'success');
			}
		});

		document.getElementById('bulkDeselectBtn')?.addEventListener('click', function() {
			selectedMarks.clear();
			document.querySelectorAll('.marks-checkbox').forEach(cb => cb.checked = false);
			document.getElementById('selectAllMarks').checked = false;
			updateBulkOperationsBar();
		});

		// Rank Calculation
		function calculateRanks() {
			if (!allMarksData || allMarksData.length === 0) return {};
			
			const studentMarks = {};
			allMarksData.forEach(mark => {
				if (!studentMarks[mark.studentId]) {
					studentMarks[mark.studentId] = { total: 0, count: 0, name: mark.studentName };
				}
				studentMarks[mark.studentId].total += mark.obtainedMarks || 0;
				studentMarks[mark.studentId].count++;
			});

			const students = Object.keys(studentMarks).map(studentId => ({
				studentId: studentId,
				average: studentMarks[studentId].total / studentMarks[studentId].count,
				name: studentMarks[studentId].name
			})).sort((a, b) => b.average - a.average);

			const ranks = {};
			students.forEach((student, index) => {
				ranks[student.studentId] = index + 1;
			});

			return ranks;
		}

		// History/Audit Trail
		const MARKS_HISTORY_KEY = 'edu_marks_history';
		let marksHistory = [];

		function saveMarksHistory(action, oldValue, newValue, key) {
			const historyEntry = {
				timestamp: new Date().toISOString(),
				action,
				oldValue,
				newValue,
				key,
				user: 'Admin' // Would get from session
			};
			try {
				const existing = localStorage.getItem(MARKS_HISTORY_KEY);
				marksHistory = existing ? JSON.parse(existing) : [];
				marksHistory.unshift(historyEntry);
				if (marksHistory.length > 1000) marksHistory = marksHistory.slice(0, 1000);
				localStorage.setItem(MARKS_HISTORY_KEY, JSON.stringify(marksHistory));
			} catch (e) {
				console.error('Error saving history:', e);
			}
		}

		// Enhanced loadMarksTable with grades and ranks
		const originalLoadMarksTable = loadMarksTable;
		loadMarksTable = function() {
			originalLoadMarksTable();
			
			// Add grades and ranks after table is rendered
			setTimeout(() => {
				const ranks = calculateRanks();
				const tbody = document.getElementById('marksTableBody');
				if (tbody) {
					const rows = tbody.querySelectorAll('tr');
					rows.forEach((row, idx) => {
						const markData = filteredMarksData[idx];
						if (markData) {
							// Add grade cell if not exists
							let gradeCell = row.querySelector('.grade-cell-data');
							if (!gradeCell) {
								const gradeTd = document.createElement('td');
								gradeTd.className = 'grade-cell';
								gradeCell = document.createElement('span');
								gradeCell.className = 'grade-cell-data';
								gradeTd.appendChild(gradeCell);
								row.insertBefore(gradeTd, row.querySelector('.status-cell') || row.lastElementChild);
							}
							
							const grade = calculateGrade(markData.obtainedMarks, markData.totalMarks);
							if (grade) {
								gradeCell.innerHTML = `<span class="grade-badge ${grade.replace('+', '-plus')}">${grade}</span>`;
							}

							// Add rank cell if not exists
							let rankCell = row.querySelector('.rank-cell-data');
							if (!rankCell) {
								const rankTd = document.createElement('td');
								rankTd.className = 'rank-cell';
								rankCell = document.createElement('span');
								rankCell.className = 'rank-cell-data';
								rankTd.appendChild(rankCell);
								row.insertBefore(rankTd, row.querySelector('.trend-cell') || row.lastElementChild);
							}
							
							const rank = ranks[markData.studentId] || '-';
							rankCell.innerHTML = `<span class="rank-indicator ${rank <= 3 ? 'top' : rank >= students.length - 2 ? 'bottom' : ''}">#${rank}</span>`;

							// Add trend indicator
							let trendCell = row.querySelector('.trend-cell-data');
							if (!trendCell) {
								const trendTd = document.createElement('td');
								trendTd.className = 'trend-cell';
								trendCell = document.createElement('span');
								trendCell.className = 'trend-cell-data';
								trendTd.appendChild(trendCell);
								row.appendChild(trendTd);
							}
							trendCell.innerHTML = '<i class="fas fa-minus trend-arrow stable"></i>';
						}
					});
				}
			}, 100);
		};

		// Export to PDF (simplified - would use jsPDF in production)
		document.getElementById('exportAnalyticsBtn')?.addEventListener('click', function() {
			const stats = calculateStatistics();
			const report = `
EXAM MARKS ANALYTICS REPORT
============================
Exam: ${currentExam?.name || 'N/A'}
Class: ${currentClass} | Section: ${currentSection}
Date: ${new Date().toLocaleDateString()}

STATISTICS:
- Total Students: ${stats.totalStudents}
- Total Records: ${stats.totalRecords}
- Average Marks: ${stats.averageMarks.toFixed(2)}
- Pass Percentage: ${stats.passPercentage.toFixed(2)}%
- Class CGPA: ${stats.cgpa}
- Passed: ${stats.passed} | Failed: ${stats.failed}
- Needs Attention: ${stats.needsAttention}

TOP PERFORMER: ${stats.topPerformer.name} (${stats.topPerformer.marks} marks)
			`;
			
			const blob = new Blob([report], { type: 'text/plain' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `Exam_Analytics_${currentExam?.name || 'Report'}_${new Date().toISOString().slice(0,10)}.txt`;
			a.click();
			notify('Analytics report downloaded', 'success');
		});

		// Keyboard Shortcuts
		document.addEventListener('keydown', function(e) {
			if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
			
			// Ctrl+S to save
			if (e.ctrlKey && e.key === 's') {
				e.preventDefault();
				saveAllMarks();
			}
			
			// Ctrl+F to focus search
			if (e.ctrlKey && e.key === 'f') {
				e.preventDefault();
				document.getElementById('searchInput')?.focus();
			}
			
			// Escape to close modals
			if (e.key === 'Escape') {
				document.querySelectorAll('.modal-overlay').forEach(modal => {
					if (modal.style.display !== 'none') {
						modal.style.display = 'none';
					}
				});
			}
		});

		// Auto-save functionality
		let autoSaveTimer = null;
		function enableAutoSave() {
			if (autoSaveTimer) clearInterval(autoSaveTimer);
			autoSaveTimer = setInterval(() => {
				if (allMarksData.length > 0 && currentExam) {
					saveAllMarks();
					// Show subtle notification
					const indicator = document.createElement('div');
					indicator.style.cssText = 'position:fixed;bottom:20px;left:20px;background:#16a34a;color:white;padding:8px 12px;border-radius:8px;font-size:12px;z-index:10000;';
					indicator.innerHTML = '<i class="fas fa-check"></i> Auto-saved';
					document.body.appendChild(indicator);
					setTimeout(() => indicator.remove(), 2000);
				}
			}, 30000); // Auto-save every 30 seconds
		}

		// Toggle Analytics Dashboard
		document.getElementById('toggleAnalyticsBtn')?.addEventListener('click', function() {
			analyticsExpanded = !analyticsExpanded;
			const dashboard = document.getElementById('analyticsDashboard');
			const toggleBtn = document.getElementById('toggleAnalyticsBtn');
			
			if (analyticsExpanded) {
				dashboard.style.display = 'block';
				dashboard.classList.remove('collapsed');
				toggleBtn.querySelector('span').textContent = 'Hide Performance Analytics';
				toggleBtn.classList.add('expanded');
				// Re-render stats if needed
				setTimeout(() => {
					const stats = calculateStatistics();
					updateAnalyticsStats(stats);
				}, 100);
			} else {
				dashboard.classList.add('collapsed');
				toggleBtn.querySelector('span').textContent = 'Show Performance Analytics';
				toggleBtn.classList.remove('expanded');
				setTimeout(() => {
					dashboard.style.display = 'none';
				}, 300);
			}
		});

		// Collapse Analytics from header button
		document.getElementById('collapseAnalyticsBtn')?.addEventListener('click', function() {
			analyticsExpanded = false;
			const dashboard = document.getElementById('analyticsDashboard');
			const toggleBtn = document.getElementById('toggleAnalyticsBtn');
			
			dashboard.classList.add('collapsed');
			toggleBtn.querySelector('span').textContent = 'Show Performance Analytics';
			toggleBtn.classList.remove('expanded');
			setTimeout(() => {
				dashboard.style.display = 'none';
			}, 300);
		});

		// Update analytics stats (separate function for re-rendering)
		function updateAnalyticsStats(stats) {
			const statsGrid = document.getElementById('analyticsStatsGrid');
			if (!statsGrid) return;
			
			// Format values for display
			const avgMarksDisplay = stats.averageMarks > 0 ? stats.averageMarks.toFixed(1) : '0.0';
			const passPctDisplay = stats.passPercentage > 0 ? stats.passPercentage.toFixed(1) : '0.0';
			const topPerformerName = stats.topPerformer.marks > 0 ? stats.topPerformer.name : 'N/A';
			const topPerformerMarks = stats.topPerformer.marks > 0 ? stats.topPerformer.marks : 0;
			
			statsGrid.innerHTML = `
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Total Students</div>
					<div class="analytics-stat-value">${stats.totalStudents}</div>
					<div class="analytics-stat-change">
						<i class="fas fa-users"></i> ${stats.totalRecords} record${stats.totalRecords !== 1 ? 's' : ''}
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Average Marks</div>
					<div class="analytics-stat-value">${avgMarksDisplay}</div>
					<div class="analytics-stat-change ${stats.averageChange >= 0 ? 'positive' : 'negative'}">
						<i class="fas fa-${stats.averageChange >= 0 ? 'arrow-up' : stats.averageChange < 0 ? 'arrow-down' : 'minus'}"></i>
						${stats.averageChange !== 0 ? Math.abs(stats.averageChange).toFixed(1) + '%' : '0.0%'} from class avg
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Pass Percentage</div>
					<div class="analytics-stat-value">${passPctDisplay}%</div>
					<div class="analytics-stat-change">
						<i class="fas fa-check-circle"></i> ${stats.passed} passed, ${stats.failed} failed
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Class CGPA</div>
					<div class="analytics-stat-value">${stats.cgpa}</div>
					<div class="analytics-stat-change">
						<i class="fas fa-star"></i> Average grade point
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Top Performer</div>
					<div class="analytics-stat-value" style="font-size: 18px;">
						${topPerformerName.length > 15 ? topPerformerName.substring(0, 15) + '...' : topPerformerName}
					</div>
					<div class="analytics-stat-change ${topPerformerMarks > 0 ? 'positive' : ''}">
						<i class="fas fa-trophy"></i> ${topPerformerMarks} marks
					</div>
				</div>
				<div class="analytics-stat-card">
					<div class="analytics-stat-label">Needs Attention</div>
					<div class="analytics-stat-value" style="font-size: 18px;">${stats.needsAttention}</div>
					<div class="analytics-stat-change negative">
						<i class="fas fa-exclamation-triangle"></i> Below 50%
					</div>
				</div>
			`;

			renderCharts(stats);
		}

		// Initialize advanced features
		document.getElementById('refreshAnalyticsBtn')?.addEventListener('click', function() {
			const stats = calculateStatistics();
			updateAnalyticsStats(stats);
			notify('Analytics refreshed', 'success');
		});
		
		// Update loadMarksTable to show analytics
		const originalLoadMarksTableFunc = window.loadMarksTable;
		if (originalLoadMarksTableFunc) {
			window.loadMarksTable = function() {
				originalLoadMarksTableFunc();
				setTimeout(() => {
					renderAnalyticsDashboard();
					enableAutoSave();
				}, 500);
			};
		}
	</script>
</body>
</html>
