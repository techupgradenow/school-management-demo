<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fee Management</title>
	<link rel="stylesheet" href="../style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		/* Fee Management Styles */
		.fee-stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
			gap: 20px;
			margin-bottom: 24px;
		}
		.stat-card {
			background: #fff;
			border-radius: 16px;
			padding: 24px;
			box-shadow: 0 4px 15px rgba(0,0,0,0.06);
			position: relative;
			overflow: hidden;
			transition: all 0.3s ease;
		}
		.stat-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 8px 25px rgba(0,0,0,0.1);
		}
		.stat-card::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 4px;
		}
		.stat-card.total::before { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
		.stat-card.collected::before { background: linear-gradient(90deg, #22c55e, #16a34a); }
		.stat-card.pending::before { background: linear-gradient(90deg, #f59e0b, #d97706); }
		.stat-card.overdue::before { background: linear-gradient(90deg, #ef4444, #dc2626); }
		
		.stat-icon {
			width: 56px;
			height: 56px;
			border-radius: 14px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 24px;
			color: #fff;
			margin-bottom: 16px;
		}
		.stat-card.total .stat-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
		.stat-card.collected .stat-icon { background: linear-gradient(135deg, #22c55e, #16a34a); }
		.stat-card.pending .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
		.stat-card.overdue .stat-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
		
		.stat-label {
			font-size: 13px;
			color: #64748b;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			font-weight: 600;
			margin-bottom: 8px;
		}
		.stat-value {
			font-size: 28px;
			font-weight: 800;
			color: #1e293b;
		}
		.stat-change {
			font-size: 12px;
			margin-top: 8px;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.stat-change.up { color: #22c55e; }
		.stat-change.down { color: #ef4444; }

		/* Filter Bar */
		.filter-bar {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
			align-items: center;
			margin-bottom: 20px;
			padding: 16px 20px;
			background: #fff;
			border-radius: 12px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
		}
		.filter-bar input,
		.filter-bar select {
			height: 42px;
			padding: 0 14px;
			border: 2px solid #e2e8f0;
			border-radius: 10px;
			font-size: 14px;
			background: #fff;
			transition: all 0.2s;
		}
		.filter-bar input:focus,
		.filter-bar select:focus {
			outline: none;
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
		}
		.filter-bar input { min-width: 280px; }

		/* Fee Table */
		.fee-table-wrapper {
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.06);
			overflow: hidden;
		}
		.fee-table-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 20px 24px;
			background: linear-gradient(180deg, #f8fafc, #fff);
			border-bottom: 1px solid #e2e8f0;
		}
		.fee-table-title {
			font-size: 18px;
			font-weight: 700;
			color: #1e293b;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.fee-table-title i { color: #3b82f6; }
		
		.fee-table {
			width: 100%;
			border-collapse: collapse;
		}
		.fee-table th {
			background: #f8fafc;
			padding: 14px 16px;
			text-align: left;
			font-size: 12px;
			font-weight: 700;
			color: #64748b;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			border-bottom: 2px solid #e2e8f0;
		}
		.fee-table td {
			padding: 16px;
			border-bottom: 1px solid #f1f5f9;
			font-size: 14px;
			color: #334155;
		}
		.fee-table tr:hover {
			background: #f8fafc;
		}
		
		/* Editable Cells */
		.editable-cell, .editable-name {
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 6px;
			transition: all 0.2s;
			display: inline-block;
		}
		.editable-cell:hover, .editable-name:hover {
			background: #eff6ff;
			outline: 2px dashed #3b82f6;
		}
		.editable-cell::after {
			content: ' ‚úèÔ∏è';
			font-size: 10px;
			opacity: 0;
			transition: opacity 0.2s;
		}
		.editable-cell:hover::after {
			opacity: 1;
		}
		.editable-name:hover {
			color: #3b82f6;
		}
		.fee-table tr:last-child td {
			border-bottom: none;
		}

		/* Student Info Cell */
		.student-info {
			display: flex;
			align-items: center;
			gap: 12px;
		}
		.student-avatar {
			width: 42px;
			height: 42px;
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			font-size: 14px;
			color: #fff;
		}
		.student-name {
			font-weight: 600;
			color: #1e293b;
		}
		.student-id {
			font-size: 12px;
			color: #94a3b8;
		}

		/* Status Badge */
		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
		}
		.status-badge.paid {
			background: #dcfce7;
			color: #16a34a;
		}
		.status-badge.partial {
			background: #fef3c7;
			color: #d97706;
		}
		.status-badge.unpaid {
			background: #fee2e2;
			color: #dc2626;
		}
		.status-badge.overdue {
			background: #fecaca;
			color: #b91c1c;
		}

		/* Amount Display */
		.amount {
			font-weight: 700;
			font-family: 'Segoe UI', monospace;
		}
		.amount.total { color: #1e293b; }
		.amount.paid { color: #16a34a; }
		.amount.balance { color: #dc2626; }

		/* Progress Bar */
		.payment-progress {
			width: 100%;
			height: 8px;
			background: #e2e8f0;
			border-radius: 10px;
			overflow: hidden;
			margin-top: 4px;
		}
		.payment-progress-bar {
			height: 100%;
			border-radius: 10px;
			transition: width 0.3s ease;
		}
		.payment-progress-bar.full { background: linear-gradient(90deg, #22c55e, #16a34a); }
		.payment-progress-bar.partial { background: linear-gradient(90deg, #f59e0b, #d97706); }
		.payment-progress-bar.low { background: linear-gradient(90deg, #ef4444, #dc2626); }

		/* Action Buttons */
		.action-btn {
			width: 34px;
			height: 34px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
			font-size: 14px;
		}
		.action-btn.view { background: #eff6ff; color: #3b82f6; }
		.action-btn.view:hover { background: #dbeafe; }
		.action-btn.pay { background: #dcfce7; color: #16a34a; }
		.action-btn.pay:hover { background: #bbf7d0; }
		.action-btn.receipt { background: #f3e8ff; color: #9333ea; }
		.action-btn.receipt:hover { background: #e9d5ff; }
		.action-btn.remind { background: #fef3c7; color: #d97706; }
		.action-btn.remind:hover { background: #fde68a; }

		/* Modal Styles */
		.modal {
			position: fixed;
			inset: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			background: rgba(15, 23, 42, 0.6);
			backdrop-filter: blur(4px);
			z-index: 9999;
			opacity: 0;
			visibility: hidden;
			transition: all 0.2s;
		}
		.modal.show {
			opacity: 1;
			visibility: visible;
		}

		/* Pagination */
		.pagination {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 16px 24px;
			border-top: 1px solid #e2e8f0;
		}
		.pagination-info {
			font-size: 14px;
			color: #64748b;
		}
		.pagination-btns {
			display: flex;
			gap: 8px;
		}
		.pagination-btns button {
			padding: 8px 14px;
			border: 1px solid #e2e8f0;
			background: #fff;
			border-radius: 8px;
			font-size: 13px;
			cursor: pointer;
			transition: all 0.2s;
		}
		.pagination-btns button:hover:not(:disabled) {
			background: #f8fafc;
			border-color: #cbd5e1;
		}
		.pagination-btns button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		/* Responsive */
		@media (max-width: 1024px) {
			.fee-table { display: block; overflow-x: auto; }
		}
		@media (max-width: 768px) {
			.filter-bar { flex-direction: column; align-items: stretch; }
			.filter-bar input { min-width: 100%; }
		}
	</style>
</head>
<body>
	<div class="page fees-page active">
		<div class="page-title">
			<h1><i class="fas fa-money-check-alt" style="color: #3b82f6; margin-right: 10px;"></i>Fee Management</h1>
			<button class="btn btn-primary" id="collectFeeBtn" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none;">
				<i class="fas fa-plus"></i> Collect Fee
			</button>
		</div>

		<!-- Stats Cards -->
		<div class="fee-stats">
			<div class="stat-card total">
				<div class="stat-icon"><i class="fas fa-wallet"></i></div>
				<div class="stat-label">Total Fees</div>
				<div class="stat-value" id="totalFees">‚Çπ12,45,000</div>
				<div class="stat-change up"><i class="fas fa-arrow-up"></i> This Academic Year</div>
			</div>
			<div class="stat-card collected">
				<div class="stat-icon"><i class="fas fa-check-circle"></i></div>
				<div class="stat-label">Collected</div>
				<div class="stat-value" id="collectedFees">‚Çπ9,85,400</div>
				<div class="stat-change up"><i class="fas fa-arrow-up"></i> 79% collected</div>
			</div>
			<div class="stat-card pending">
				<div class="stat-icon"><i class="fas fa-clock"></i></div>
				<div class="stat-label">Pending</div>
				<div class="stat-value" id="pendingFees">‚Çπ1,89,600</div>
				<div class="stat-change"><i class="fas fa-hourglass-half"></i> 45 students</div>
			</div>
			<div class="stat-card overdue">
				<div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
				<div class="stat-label">Overdue</div>
				<div class="stat-value" id="overdueFees">‚Çπ70,000</div>
				<div class="stat-change down"><i class="fas fa-arrow-down"></i> 12 students</div>
			</div>
		</div>

		<!-- Edit Hint Banner -->
		<div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 10px; padding: 12px 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; font-size: 13px; color: #166534;">
			<i class="fas fa-lightbulb" style="color: #22c55e; font-size: 16px;"></i>
			<span><strong>Tip:</strong> Click on any cell to edit inline. Use action buttons to collect payments, send reminders, and print receipts.</span>
		</div>

		<!-- Filter Bar -->
		<div class="filter-bar">
			<input type="text" id="searchFee" placeholder="üîç Search by name, ID, or class...">
			<select id="filterClass">
				<option value="">All Classes</option>
				<option value="8">Class 8</option>
				<option value="9">Class 9</option>
				<option value="10">Class 10</option>
				<option value="11">Class 11</option>
				<option value="12">Class 12</option>
			</select>
			<select id="filterStatus">
				<option value="">All Status</option>
				<option value="paid">‚úÖ Paid</option>
				<option value="partial">‚è≥ Partial</option>
				<option value="unpaid">‚ùå Unpaid</option>
				<option value="overdue">‚ö†Ô∏è Overdue</option>
			</select>
			<select id="filterMonth">
				<option value="">All Months</option>
				<option value="nov">November 2024</option>
				<option value="oct">October 2024</option>
				<option value="sep">September 2024</option>
			</select>
			<div style="margin-left: auto; display: flex; gap: 10px;">
				<button class="btn btn-outline btn-sm" id="syncStudentsBtn" style="border-color: #8b5cf6; color: #8b5cf6;" title="Sync fee records with all students">
					<i class="fas fa-sync-alt"></i> Sync Students
				</button>
				<button class="btn btn-outline btn-sm" id="exportBtn">
					<i class="fas fa-download"></i> Export
				</button>
				<button class="btn btn-outline btn-sm" id="printBtn">
					<i class="fas fa-print"></i> Print
				</button>
			</div>
		</div>

		<!-- Fee Table -->
		<div class="fee-table-wrapper">
			<div class="fee-table-header">
				<div class="fee-table-title">
					<i class="fas fa-list-alt"></i>
					<span>Fee Records</span>
					<span style="font-size: 13px; font-weight: 500; color: #64748b; margin-left: 8px;" id="recordCount">(50 records)</span>
				</div>
				<div style="display: flex; gap: 10px;">
					<button class="btn btn-outline btn-sm" id="sendReminders">
						<i class="fas fa-bell"></i> Send Reminders
					</button>
				</div>
			</div>
			<table class="fee-table">
				<thead>
					<tr>
						<th>Student</th>
						<th>Class</th>
						<th>Total Fee</th>
						<th>Paid</th>
						<th>Balance</th>
						<th>Progress</th>
						<th>Due Date</th>
						<th>Status</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody id="feeTableBody">
					<!-- Generated by JS -->
				</tbody>
			</table>
			<div class="pagination">
				<div class="pagination-info">Showing <span id="showingFrom">1</span>-<span id="showingTo">10</span> of <span id="totalRecords">50</span> records</div>
				<div class="pagination-btns">
					<button id="prevPage"><i class="fas fa-chevron-left"></i> Previous</button>
					<button id="nextPage">Next <i class="fas fa-chevron-right"></i></button>
				</div>
			</div>
		</div>
	</div>

	<!-- Collect Fee Modal -->
	<div class="modal" id="feeModal">
		<div class="modal-content" style="background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); padding: 0;">
			
			<!-- Header -->
			<div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid #e2e8f0; background: linear-gradient(180deg, #f8fafc, #fff); border-radius: 16px 16px 0 0;">
				<div style="font-weight: 700; font-size: 18px; color: #1e293b; display: flex; align-items: center; gap: 10px;">
					<span style="width: 4px; height: 20px; background: linear-gradient(180deg, #3b82f6, #1d4ed8); border-radius: 2px; display: inline-block;"></span>
					<span id="feeModalTitle">Collect Fee</span>
				</div>
				<div id="closeFeeModal" style="cursor: pointer; color: #94a3b8; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">
					<i class="fas fa-times"></i>
				</div>
			</div>
			
			<!-- Form Body -->
			<div style="padding: 24px; display: grid; gap: 20px;">
				<input type="hidden" id="editFeeId">
				
				<!-- Student Selection -->
				<div>
					<label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Select Student</label>
					<select id="feeStudent" style="width: 100%; height: 48px; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0 16px; font-size: 15px; background: #fff; box-sizing: border-box;">
						<option value="">Choose a student...</option>
					</select>
				</div>
				
				<!-- Fee Type -->
				<div>
					<label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Fee Type</label>
					<select id="feeType" style="width: 100%; height: 48px; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0 16px; font-size: 15px; background: #fff; box-sizing: border-box;">
						<option value="tuition">üìö Tuition Fee</option>
						<option value="exam">üìù Exam Fee</option>
						<option value="transport">üöå Transport Fee</option>
						<option value="library">üìñ Library Fee</option>
						<option value="lab">üî¨ Lab Fee</option>
						<option value="sports">‚öΩ Sports Fee</option>
						<option value="other">üì¶ Other</option>
					</select>
				</div>
				
				<!-- Amount Grid -->
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
					<div>
						<label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Total Amount</label>
						<input type="number" id="feeTotalAmount" placeholder="‚Çπ0" style="width: 100%; height: 48px; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0 16px; font-size: 15px; background: #fff; box-sizing: border-box;">
					</div>
					<div>
						<label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Paying Now</label>
						<input type="number" id="feePayingAmount" placeholder="‚Çπ0" style="width: 100%; height: 48px; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0 16px; font-size: 15px; background: #fff; box-sizing: border-box;">
					</div>
				</div>
				
				<!-- Payment Method -->
				<div>
					<label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Payment Method</label>
					<select id="paymentMethod" style="width: 100%; height: 48px; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0 16px; font-size: 15px; background: #fff; box-sizing: border-box;">
						<option value="cash">üíµ Cash</option>
						<option value="card">üí≥ Card</option>
						<option value="upi">üì± UPI</option>
						<option value="netbanking">üè¶ Net Banking</option>
						<option value="cheque">üìÑ Cheque</option>
					</select>
				</div>
				
				<!-- Remarks -->
				<div>
					<label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Remarks (Optional)</label>
					<input type="text" id="feeRemarks" placeholder="Any additional notes..." style="width: 100%; height: 48px; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0 16px; font-size: 15px; background: #fff; box-sizing: border-box;">
				</div>
			</div>
			
			<!-- Footer -->
			<div style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; border-radius: 0 0 16px 16px;">
				<button id="cancelFeeBtn" style="min-width: 120px; height: 46px; padding: 0 20px; background: #fff; border: 2px solid #e2e8f0; border-radius: 10px; color: #64748b; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
					<i class="fas fa-times"></i> Cancel
				</button>
				<button id="saveFeeBtn" style="min-width: 160px; height: 46px; padding: 0 24px; background: linear-gradient(180deg, #22c55e, #16a34a); border: none; border-radius: 10px; color: #fff; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 14px rgba(34,197,94,0.4);">
					<i class="fas fa-check"></i> Collect Payment
				</button>
			</div>
		</div>
	</div>

	<script>
		const FEES_KEY = 'edu_fees';
		const STUDENTS_KEY = 'edu_students';

		// Demo fee data
		const DEMO_FEES = [
			{ id: 'FEE001', studentId: 'STU-2023-001', name: 'Rahul Sharma', class: '10', section: 'A', total: 45000, paid: 45000, dueDate: '2024-11-15', status: 'paid', lastPayment: '2024-11-10' },
			{ id: 'FEE002', studentId: 'STU-2023-002', name: 'Priya Patel', class: '9', section: 'B', total: 42000, paid: 30000, dueDate: '2024-11-20', status: 'partial', lastPayment: '2024-10-25' },
			{ id: 'FEE003', studentId: 'STU-2023-003', name: 'Amit Kumar', class: '11', section: 'A', total: 48000, paid: 0, dueDate: '2024-11-10', status: 'overdue', lastPayment: null },
			{ id: 'FEE004', studentId: 'STU-2023-004', name: 'Neha Gupta', class: '8', section: 'C', total: 40000, paid: 40000, dueDate: '2024-11-25', status: 'paid', lastPayment: '2024-11-05' },
			{ id: 'FEE005', studentId: 'STU-2023-005', name: 'Vikram Singh', class: '10', section: 'B', total: 45000, paid: 20000, dueDate: '2024-11-18', status: 'partial', lastPayment: '2024-10-15' },
			{ id: 'FEE006', studentId: 'STU-2023-006', name: 'Ananya Reddy', class: '12', section: 'A', total: 52000, paid: 52000, dueDate: '2024-11-12', status: 'paid', lastPayment: '2024-11-01' },
			{ id: 'FEE007', studentId: 'STU-2023-007', name: 'Karan Malhotra', class: '9', section: 'A', total: 42000, paid: 0, dueDate: '2024-11-05', status: 'overdue', lastPayment: null },
			{ id: 'FEE008', studentId: 'STU-2023-008', name: 'Sneha Iyer', class: '10', section: 'C', total: 45000, paid: 35000, dueDate: '2024-11-22', status: 'partial', lastPayment: '2024-10-20' },
			{ id: 'FEE009', studentId: 'STU-2023-009', name: 'Arjun Nair', class: '11', section: 'B', total: 48000, paid: 48000, dueDate: '2024-11-14', status: 'paid', lastPayment: '2024-11-08' },
			{ id: 'FEE010', studentId: 'STU-2023-010', name: 'Pooja Verma', class: '8', section: 'A', total: 40000, paid: 0, dueDate: '2024-11-30', status: 'unpaid', lastPayment: null },
			{ id: 'FEE011', studentId: 'STU-2023-011', name: 'Rohan Das', class: '12', section: 'B', total: 52000, paid: 26000, dueDate: '2024-11-16', status: 'partial', lastPayment: '2024-10-28' },
			{ id: 'FEE012', studentId: 'STU-2023-012', name: 'Kavya Sharma', class: '9', section: 'C', total: 42000, paid: 42000, dueDate: '2024-11-19', status: 'paid', lastPayment: '2024-11-12' },
			{ id: 'FEE013', studentId: 'STU-2023-013', name: 'Aditya Joshi', class: '10', section: 'A', total: 45000, paid: 15000, dueDate: '2024-11-08', status: 'overdue', lastPayment: '2024-09-15' },
			{ id: 'FEE014', studentId: 'STU-2023-014', name: 'Ishita Kapoor', class: '11', section: 'C', total: 48000, paid: 48000, dueDate: '2024-11-21', status: 'paid', lastPayment: '2024-11-15' },
			{ id: 'FEE015', studentId: 'STU-2023-015', name: 'Manish Tiwari', class: '8', section: 'B', total: 40000, paid: 10000, dueDate: '2024-11-28', status: 'partial', lastPayment: '2024-10-10' }
		];

		// Avatar colors
		const AVATAR_COLORS = [
			'#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', 
			'#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
		];

		function getAvatarColor(name) {
			let hash = 0;
			for (let i = 0; i < name.length; i++) {
				hash = name.charCodeAt(i) + ((hash << 5) - hash);
			}
			return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
		}

		function getInitials(name) {
			return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
		}

		function formatCurrency(amount) {
			return '‚Çπ' + amount.toLocaleString('en-IN');
		}

		function loadFees() {
			try {
				// Get all students from the Students module
				const studentsData = localStorage.getItem(STUDENTS_KEY);
				const allStudents = studentsData ? JSON.parse(studentsData) : [];
				
				// Get existing fees
				const feesData = localStorage.getItem(FEES_KEY);
				let existingFees = feesData ? JSON.parse(feesData) : [];
				
				// If no fees exist, start with demo fees
				if (existingFees.length === 0) {
					existingFees = [...DEMO_FEES];
				}
				
				// Generate fees for students that don't have fee records yet
				const existingStudentIds = new Set(existingFees.map(f => f.studentId));
				
				allStudents.forEach((student, idx) => {
					if (!existingStudentIds.has(student.id)) {
						// Create fee record for this student
						const classNum = parseInt(student.class) || 10;
						const baseAmount = 35000 + (classNum * 1000); // Higher classes = higher fees
						const statuses = ['paid', 'partial', 'unpaid', 'overdue'];
						const randomStatus = statuses[Math.floor(Math.random() * 4)];
						const paidAmount = randomStatus === 'paid' ? baseAmount : 
										   randomStatus === 'partial' ? Math.floor(baseAmount * (0.3 + Math.random() * 0.5)) :
										   0;
						
						const dueDate = new Date();
						dueDate.setDate(dueDate.getDate() + Math.floor(Math.random() * 60) - 30);
						
						existingFees.push({
							id: 'FEE' + String(existingFees.length + 1).padStart(3, '0'),
							studentId: student.id,
							name: student.name,
							class: student.class || '10',
							section: student.section || 'A',
							total: baseAmount,
							paid: paidAmount,
							dueDate: dueDate.toISOString().split('T')[0],
							status: randomStatus,
							lastPayment: paidAmount > 0 ? new Date().toISOString().split('T')[0] : null
						});
					}
				});
				
				// Save the updated fees
				saveFees(existingFees);
				return existingFees;
			} catch (e) {
				console.error('Error loading fees:', e);
				saveFees(DEMO_FEES);
				return DEMO_FEES;
			}
		}

		function saveFees(data) {
			localStorage.setItem(FEES_KEY, JSON.stringify(data));
		}

		// State
		let state = {
			page: 1,
			pageSize: 10,
			search: '',
			filterClass: '',
			filterStatus: '',
			filterMonth: ''
		};

		// DOM Elements
		const feeTableBody = document.getElementById('feeTableBody');
		const searchInput = document.getElementById('searchFee');
		const filterClass = document.getElementById('filterClass');
		const filterStatus = document.getElementById('filterStatus');
		const filterMonth = document.getElementById('filterMonth');
		const feeModal = document.getElementById('feeModal');
		const collectFeeBtn = document.getElementById('collectFeeBtn');
		const closeFeeModal = document.getElementById('closeFeeModal');
		const cancelFeeBtn = document.getElementById('cancelFeeBtn');
		const saveFeeBtn = document.getElementById('saveFeeBtn');

		function updateStats() {
			const fees = loadFees();
			const total = fees.reduce((sum, f) => sum + f.total, 0);
			const collected = fees.reduce((sum, f) => sum + f.paid, 0);
			const pending = fees.filter(f => f.status === 'partial' || f.status === 'unpaid').reduce((sum, f) => sum + (f.total - f.paid), 0);
			const overdue = fees.filter(f => f.status === 'overdue').reduce((sum, f) => sum + (f.total - f.paid), 0);

			document.getElementById('totalFees').textContent = formatCurrency(total);
			document.getElementById('collectedFees').textContent = formatCurrency(collected);
			document.getElementById('pendingFees').textContent = formatCurrency(pending);
			document.getElementById('overdueFees').textContent = formatCurrency(overdue);
		}

		function renderFees() {
			let fees = loadFees();

			// Apply filters
			if (state.search) {
				const q = state.search.toLowerCase();
				fees = fees.filter(f => 
					f.name.toLowerCase().includes(q) || 
					f.studentId.toLowerCase().includes(q) ||
					f.class.includes(q)
				);
			}
			if (state.filterClass) {
				fees = fees.filter(f => f.class === state.filterClass);
			}
			if (state.filterStatus) {
				fees = fees.filter(f => f.status === state.filterStatus);
			}

			// Pagination
			const total = fees.length;
			const totalPages = Math.ceil(total / state.pageSize);
			if (state.page > totalPages) state.page = Math.max(1, totalPages);
			const start = (state.page - 1) * state.pageSize;
			const pageFees = fees.slice(start, start + state.pageSize);

			// Update record count
			document.getElementById('recordCount').textContent = `(${total} records)`;
			document.getElementById('showingFrom').textContent = total > 0 ? start + 1 : 0;
			document.getElementById('showingTo').textContent = Math.min(start + state.pageSize, total);
			document.getElementById('totalRecords').textContent = total;
			document.getElementById('prevPage').disabled = state.page <= 1;
			document.getElementById('nextPage').disabled = state.page >= totalPages;

			// Render table
			feeTableBody.innerHTML = pageFees.map(fee => {
				const balance = fee.total - fee.paid;
				const progress = Math.round((fee.paid / fee.total) * 100);
				const progressClass = progress >= 100 ? 'full' : progress >= 50 ? 'partial' : 'low';
				const avatarColor = getAvatarColor(fee.name);
				const initials = getInitials(fee.name);
				
				const statusOptions = `
					<select class="status-select" data-id="${fee.id}" data-field="status" style="padding: 6px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; background: ${fee.status === 'paid' ? '#dcfce7' : fee.status === 'partial' ? '#fef3c7' : fee.status === 'overdue' ? '#fee2e2' : '#fee2e2'}; color: ${fee.status === 'paid' ? '#16a34a' : fee.status === 'partial' ? '#d97706' : '#dc2626'};">
						<option value="paid" ${fee.status === 'paid' ? 'selected' : ''}>‚úÖ Paid</option>
						<option value="partial" ${fee.status === 'partial' ? 'selected' : ''}>‚è≥ Partial</option>
						<option value="unpaid" ${fee.status === 'unpaid' ? 'selected' : ''}>‚ùå Unpaid</option>
						<option value="overdue" ${fee.status === 'overdue' ? 'selected' : ''}>‚ö†Ô∏è Overdue</option>
					</select>
				`;

				return `
					<tr data-fee-id="${fee.id}">
						<td>
							<div class="student-info">
								<div class="student-avatar" style="background: ${avatarColor};">${initials}</div>
								<div>
									<div class="student-name editable-name" data-id="${fee.id}" data-field="name" title="Click to edit">${fee.name}</div>
									<div class="student-id">${fee.studentId}</div>
								</div>
		</div>
						</td>
						<td>
							<span class="editable-cell" data-id="${fee.id}" data-field="class" title="Click to edit"><strong>${fee.class}</strong></span>-<span class="editable-cell" data-id="${fee.id}" data-field="section" title="Click to edit">${fee.section}</span>
						</td>
						<td>
							<span class="editable-cell amount total" data-id="${fee.id}" data-field="total" data-type="number" title="Click to edit">${formatCurrency(fee.total)}</span>
						</td>
						<td>
							<span class="editable-cell amount paid" data-id="${fee.id}" data-field="paid" data-type="number" title="Click to edit">${formatCurrency(fee.paid)}</span>
						</td>
						<td>
							<span class="amount balance" style="color: ${balance > 0 ? '#dc2626' : '#16a34a'};">${formatCurrency(balance)}</span>
						</td>
						<td>
							<div style="min-width: 100px;">
								<div style="display: flex; justify-content: space-between; font-size: 11px; color: #64748b; margin-bottom: 4px;">
									<span>${progress}%</span>
			</div>
								<div class="payment-progress">
									<div class="payment-progress-bar ${progressClass}" style="width: ${progress}%;"></div>
		</div>
	</div>
						</td>
						<td>
							<span class="editable-cell" data-id="${fee.id}" data-field="dueDate" data-type="date" title="Click to edit">${new Date(fee.dueDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
						</td>
						<td>${statusOptions}</td>
						<td>
							<div style="display: flex; gap: 6px;">
								<button class="action-btn view" title="View Details" data-id="${fee.id}"><i class="fas fa-eye"></i></button>
								${fee.status !== 'paid' ? `<button class="action-btn pay" title="Collect Payment" data-id="${fee.id}" data-action="pay"><i class="fas fa-rupee-sign"></i></button>` : ''}
								<button class="action-btn receipt" title="Print Receipt" data-id="${fee.id}"><i class="fas fa-receipt"></i></button>
								${fee.status !== 'paid' ? `<button class="action-btn remind" title="Send Reminder" data-id="${fee.id}"><i class="fas fa-bell"></i></button>` : ''}
							</div>
						</td>
					</tr>
				`;
			}).join('');

			updateStats();
		}

		function openModal(feeId = null) {
			document.getElementById('editFeeId').value = feeId || '';
			document.getElementById('feeModalTitle').textContent = feeId ? 'Update Payment' : 'Collect Fee';
			
			// Load students for dropdown
			const students = JSON.parse(localStorage.getItem(STUDENTS_KEY) || '[]');
			const studentSelect = document.getElementById('feeStudent');
			studentSelect.innerHTML = '<option value="">Choose a student...</option>' + 
				students.map(s => `<option value="${s.id}">${s.name} (${s.id}) - Class ${s.class}</option>`).join('');
			
			if (feeId) {
				const fees = loadFees();
				const fee = fees.find(f => f.id === feeId);
				if (fee) {
					studentSelect.value = fee.studentId;
					document.getElementById('feeTotalAmount').value = fee.total;
					document.getElementById('feePayingAmount').value = fee.total - fee.paid;
				}
			} else {
				document.getElementById('feeTotalAmount').value = '';
				document.getElementById('feePayingAmount').value = '';
			}
			
			feeModal.classList.add('show');
		}

		function closeModal() {
			feeModal.classList.remove('show');
		}

		function notify(msg, type = 'success') {
			if (window.parent && typeof window.parent.showNotification === 'function') {
				window.parent.showNotification(msg, type);
			} else {
				alert(msg);
			}
		}

		// Event Listeners
		searchInput.addEventListener('input', (e) => {
			state.search = e.target.value;
			state.page = 1;
			renderFees();
		});

		filterClass.addEventListener('change', (e) => {
			state.filterClass = e.target.value;
			state.page = 1;
			renderFees();
		});

		filterStatus.addEventListener('change', (e) => {
			state.filterStatus = e.target.value;
			state.page = 1;
			renderFees();
		});

		document.getElementById('prevPage').addEventListener('click', () => {
			if (state.page > 1) { state.page--; renderFees(); }
		});

		document.getElementById('nextPage').addEventListener('click', () => {
			state.page++;
			renderFees();
		});

		collectFeeBtn.addEventListener('click', () => openModal());
		closeFeeModal.addEventListener('click', closeModal);
		cancelFeeBtn.addEventListener('click', closeModal);
		window.addEventListener('click', (e) => { if (e.target === feeModal) closeModal(); });

		saveFeeBtn.addEventListener('click', () => {
			const payingAmount = parseInt(document.getElementById('feePayingAmount').value) || 0;
			const editId = document.getElementById('editFeeId').value;
			
			if (editId) {
				const fees = loadFees();
				const idx = fees.findIndex(f => f.id === editId);
				if (idx > -1) {
					fees[idx].paid += payingAmount;
					if (fees[idx].paid >= fees[idx].total) {
						fees[idx].status = 'paid';
					} else {
						fees[idx].status = 'partial';
					}
					fees[idx].lastPayment = new Date().toISOString().split('T')[0];
					saveFees(fees);
					notify('Payment collected successfully!', 'success');
				}
			} else {
				notify('Please select a student first', 'error');
				return;
			}
			
			closeModal();
			renderFees();
		});

		// Handle editable cells click
		feeTableBody.addEventListener('click', (e) => {
			const btn = e.target.closest('button[data-id]');
			const editableCell = e.target.closest('.editable-cell, .editable-name');
			
			// Handle buttons
			if (btn) {
				const id = btn.dataset.id;
				if (btn.dataset.action === 'pay') {
					openModal(id);
				} else if (btn.classList.contains('remind')) {
					notify('Payment reminder sent!', 'success');
				} else if (btn.classList.contains('receipt')) {
					notify('Receipt generated!', 'success');
				}
				return;
			}
			
			// Inline editing for editable cells
			if (editableCell && !editableCell.querySelector('input')) {
				const feeId = editableCell.dataset.id;
				const field = editableCell.dataset.field;
				const type = editableCell.dataset.type || 'text';
				const fees = loadFees();
				const feeIdx = fees.findIndex(f => f.id === feeId);
				
				if (feeIdx < 0) return;
				
				const originalHTML = editableCell.innerHTML;
				const originalValue = fees[feeIdx][field];
				
				let input;
				if (type === 'date') {
					input = document.createElement('input');
					input.type = 'date';
					input.value = originalValue;
				} else if (type === 'number') {
					input = document.createElement('input');
					input.type = 'number';
					input.value = typeof originalValue === 'number' ? originalValue : parseInt(originalValue.replace(/[‚Çπ,]/g, '')) || 0;
				} else {
					input = document.createElement('input');
					input.type = 'text';
					input.value = originalValue;
				}
				
				input.style.cssText = 'width: 100%; padding: 8px 12px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 14px; font-weight: 600; background: white; box-shadow: 0 2px 8px rgba(59,130,246,0.2);';
				editableCell.innerHTML = '';
				editableCell.appendChild(input);
				input.focus();
				input.select();
				
				const saveEdit = () => {
					let newValue = input.value.trim();
					
					if (type === 'number') {
						newValue = parseInt(newValue) || 0;
						fees[feeIdx][field] = newValue;
						
						// Recalculate status based on paid amount
						if (field === 'paid' || field === 'total') {
							const paid = fees[feeIdx].paid;
							const total = fees[feeIdx].total;
							if (paid >= total) {
								fees[feeIdx].status = 'paid';
							} else if (paid > 0) {
								fees[feeIdx].status = 'partial';
							} else {
								const dueDate = new Date(fees[feeIdx].dueDate);
								fees[feeIdx].status = dueDate < new Date() ? 'overdue' : 'unpaid';
							}
						}
					} else if (type === 'date') {
						fees[feeIdx][field] = newValue;
					} else {
						fees[feeIdx][field] = newValue || originalValue;
					}
					
					saveFees(fees);
					renderFees();
					updateStats();
					notify('‚úÖ Updated successfully!', 'success');
				};
				
				input.addEventListener('blur', saveEdit);
				input.addEventListener('keydown', (ev) => {
					if (ev.key === 'Enter') input.blur();
					if (ev.key === 'Escape') { renderFees(); }
				});
			}
		});

		// Handle status dropdown change
		feeTableBody.addEventListener('change', (e) => {
			if (e.target.classList.contains('status-select')) {
				const feeId = e.target.dataset.id;
				const newStatus = e.target.value;
				const fees = loadFees();
				const feeIdx = fees.findIndex(f => f.id === feeId);
				
				if (feeIdx >= 0) {
					fees[feeIdx].status = newStatus;
					
					// Auto-update paid amount based on status
					if (newStatus === 'paid') {
						fees[feeIdx].paid = fees[feeIdx].total;
						fees[feeIdx].lastPayment = new Date().toISOString().split('T')[0];
					}
					
					saveFees(fees);
					renderFees();
					updateStats();
					notify('‚úÖ Status updated!', 'success');
				}
			}
		});

		document.getElementById('sendReminders').addEventListener('click', () => {
			notify('Payment reminders sent to all pending students!', 'success');
		});

		document.getElementById('exportBtn').addEventListener('click', () => {
			const fees = loadFees();
			const csv = [
				['Student ID', 'Name', 'Class', 'Total', 'Paid', 'Balance', 'Status', 'Due Date'].join(','),
				...fees.map(f => [f.studentId, f.name, f.class + '-' + f.section, f.total, f.paid, f.total - f.paid, f.status, f.dueDate].join(','))
			].join('\n');
			const blob = new Blob([csv], { type: 'text/csv' });
			const a = document.createElement('a');
			a.href = URL.createObjectURL(blob);
			a.download = 'fee_records.csv';
			a.click();
		});

		// Sync Students Button - Force sync with all students
		document.getElementById('syncStudentsBtn').addEventListener('click', () => {
			const studentsData = localStorage.getItem(STUDENTS_KEY);
			const allStudents = studentsData ? JSON.parse(studentsData) : [];
			
			if (allStudents.length === 0) {
				notify('No students found! Add students first.', 'error');
				return;
			}
			
			// Clear existing fees and regenerate from all students
			let newFees = [];
			
			allStudents.forEach((student, idx) => {
				const classNum = parseInt(student.class) || 10;
				const baseAmount = 35000 + (classNum * 1000);
				const statuses = ['paid', 'partial', 'unpaid', 'overdue'];
				const randomStatus = statuses[idx % 4]; // Cycle through statuses
				const paidAmount = randomStatus === 'paid' ? baseAmount : 
								   randomStatus === 'partial' ? Math.floor(baseAmount * 0.5) :
								   0;
				
				const dueDate = new Date();
				dueDate.setDate(dueDate.getDate() + (idx % 30) - 15);
				
				newFees.push({
					id: 'FEE' + String(idx + 1).padStart(3, '0'),
					studentId: student.id,
					name: student.name,
					class: student.class || '10',
					section: student.section || 'A',
					total: baseAmount,
					paid: paidAmount,
					dueDate: dueDate.toISOString().split('T')[0],
					status: randomStatus,
					lastPayment: paidAmount > 0 ? new Date().toISOString().split('T')[0] : null
				});
			});
			
			saveFees(newFees);
			renderFees();
			updateStats();
			notify(`‚úÖ Synced! ${newFees.length} student fee records loaded.`, 'success');
		});

		// Initialize
		document.addEventListener('DOMContentLoaded', renderFees);
	</script>
</body>
</html>
