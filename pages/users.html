<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>User Management</title>
	<link rel="stylesheet" href="../style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		* { box-sizing: border-box; margin: 0; padding: 0; }
		body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 24px; }

		.page-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 24px;
			flex-wrap: wrap;
			gap: 16px;
		}
		.page-title-section h1 { font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
		.page-title-section p { font-size: 14px; color: #64748b; }
		.header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
		.btn {
			padding: 12px 20px;
			border-radius: 10px;
			font-weight: 600;
			font-size: 14px;
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			transition: all 0.2s;
			border: none;
		}
		.btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
		.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
		.btn-secondary { background: white; border: 2px solid #e2e8f0; color: #64748b; }
		.btn-secondary:hover { border-color: #3b82f6; color: #3b82f6; }

		.stats-row {
			display: grid;
			grid-template-columns: repeat(5, 1fr);
			gap: 20px;
			margin-bottom: 24px;
		}
		.stat-mini {
			background: white;
			border-radius: 16px;
			padding: 20px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			text-align: center;
		}
		.stat-mini-value {
			font-size: 32px;
			font-weight: 700;
			color: #1e293b;
			margin-bottom: 4px;
		}
		.stat-mini-label {
			font-size: 13px;
			color: #64748b;
		}
		.stat-total .stat-mini-value { color: #3b82f6; }
		.stat-students .stat-mini-value { color: #22c55e; }
		.stat-admins .stat-mini-value { color: #8b5cf6; }
		.stat-teachers .stat-mini-value { color: #f59e0b; }
		.stat-staff .stat-mini-value { color: #64748b; }

		.table-card {
			background: white;
			border-radius: 16px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
			overflow: hidden;
		}
		.table-filters {
			background: #f8fafc;
			padding: 12px 14px;
			border-bottom: 2px solid #e2e8f0;
			display: grid;
			grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
			gap: 8px;
			align-items: center;
		}
		.filter-cell {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}
		.table-filter-input, .table-filter-select {
			width: 100%;
			padding: 8px 12px;
			border: 1px solid #e2e8f0;
			border-radius: 8px;
			font-size: 12px;
			background: white;
		}
		.table-filter-input:focus, .table-filter-select:focus {
			outline: none;
			border-color: #3b82f6;
		}
		.filter-count {
			font-size: 10px;
			color: #64748b;
			text-align: center;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
		}
		.data-table thead {
			background: linear-gradient(135deg, #1e3a5f, #2d4a6f);
		}
		.data-table th {
			padding: 16px 12px;
			text-align: left;
			font-weight: 600;
			font-size: 12px;
			color: white;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		.data-table tbody tr {
			border-bottom: 1px solid #f1f5f9;
			transition: all 0.2s;
		}
		.data-table tbody tr:hover {
			background: #f8fafc;
		}
		.data-table td {
			padding: 12px;
			font-size: 14px;
			color: #334155;
			vertical-align: middle;
		}

		.user-avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
			font-size: 14px;
			color: white;
			margin-right: 8px;
		}
		.role-badge, .status-badge {
			padding: 4px 12px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: 600;
			text-transform: uppercase;
			display: inline-block;
		}
		.role-badge.superadmin { background: #fee2e2; color: #991b1b; }
		.role-badge.admin { background: #dbeafe; color: #1e40af; }
		.role-badge.teacher { background: #fef3c7; color: #92400e; }
		.role-badge.staff { background: #e5e7eb; color: #374151; }
		.status-badge.active { background: #d1fae5; color: #065f46; }
		.status-badge.inactive { background: #fee2e2; color: #991b1b; }

		.action-btn-group {
			display: flex;
			gap: 6px;
			justify-content: center;
		}
		.action-btn {
			width: 32px;
			height: 32px;
			border-radius: 8px;
			border: none;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
			color: white;
			font-size: 12px;
		}
		.action-btn.edit { background: linear-gradient(135deg, #3b82f6, #2563eb); }
		.action-btn.delete { background: linear-gradient(135deg, #ef4444, #dc2626); }
		.action-btn.view { background: linear-gradient(135deg, #10b981, #059669); }
		.action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

		/* Modal Styles */
		.modal-overlay {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.6);
			backdrop-filter: blur(4px);
			z-index: 10000;
			align-items: center;
			justify-content: center;
			padding: 20px;
			overflow-y: auto;
		}
		.modal-overlay.active {
			display: flex;
		}
		.modal-content {
			background: white;
			border-radius: 20px;
			width: 90%;
			max-width: 900px;
			max-height: 90vh;
			display: flex;
			flex-direction: column;
			box-shadow: 0 20px 60px rgba(0,0,0,0.3);
			overflow: hidden;
		}
		.modal-header {
			padding: 20px 24px;
			border-bottom: 1px solid #e2e8f0;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.modal-title {
			font-size: 20px;
			font-weight: 700;
			color: #1e293b;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.modal-close {
			width: 36px;
			height: 36px;
			border-radius: 8px;
			border: none;
			background: #f1f5f9;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			color: #64748b;
			transition: all 0.2s;
		}
		.modal-close:hover {
			background: #e2e8f0;
			color: #1e293b;
		}
		.modal-body {
			padding: 24px;
			overflow-y: auto;
			flex: 1;
		}
		.modal-footer {
			padding: 16px 24px;
			border-top: 1px solid #e2e8f0;
			display: flex;
			justify-content: flex-end;
			gap: 12px;
		}

		/* Import additional modal styles from settings.html would be here */
		/* For brevity, I'm including essential styles only */
		.modal-tabs {
			display: flex;
			border-bottom: 2px solid #e2e8f0;
			padding: 0 24px;
			gap: 4px;
			background: #ffffff;
		}
		.modal-tab {
			border: none;
			background: transparent;
			padding: 12px 20px;
			font-size: 13px;
			font-weight: 600;
			color: #64748b;
			cursor: pointer;
			border-bottom: 3px solid transparent;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: all 0.2s;
		}
		.modal-tab.active {
			color: #1e3a5f;
			border-bottom-color: #1e3a5f;
		}
		.tab-section {
			display: none;
		}
		.tab-section.active {
			display: block;
		}

		.form-group {
			margin-bottom: 16px;
		}
		.form-label {
			display: block;
			margin-bottom: 6px;
			font-size: 13px;
			font-weight: 600;
			color: #1e293b;
		}
		.form-input, .form-select {
			width: 100%;
			padding: 10px 14px;
			border: 2px solid #e2e8f0;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.2s;
		}
		.form-input:focus, .form-select:focus {
			outline: none;
			border-color: #3b82f6;
		}

		@media (max-width: 768px) {
			.stats-row {
				grid-template-columns: repeat(2, 1fr);
			}
			.table-filters {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>
<body>
	<div class="page-header">
		<div class="page-title-section">
			<h1><i class="fas fa-users-cog"></i> User Management</h1>
			<p>Manage system users, roles, and permissions</p>
		</div>
		<div class="header-actions">
			<button class="btn btn-primary" id="addUserBtn">
				<i class="fas fa-plus"></i> Add User
			</button>
		</div>
	</div>

	<!-- Stats Row -->
	<div class="stats-row">
		<div class="stat-mini stat-total">
			<div class="stat-mini-value" id="totalUsersCount">0</div>
			<div class="stat-mini-label">Total Users</div>
		</div>
		<div class="stat-mini stat-students">
			<div class="stat-mini-value" id="studentsCount">0</div>
			<div class="stat-mini-label">Students</div>
		</div>
		<div class="stat-mini stat-admins">
			<div class="stat-mini-value" id="adminCount">0</div>
			<div class="stat-mini-label">Admins</div>
		</div>
		<div class="stat-mini stat-teachers">
			<div class="stat-mini-value" id="teacherCount">0</div>
			<div class="stat-mini-label">Teachers</div>
		</div>
		<div class="stat-mini stat-staff">
			<div class="stat-mini-value" id="staffCount">0</div>
			<div class="stat-mini-label">Staff</div>
		</div>
	</div>

	<!-- Table Card -->
	<div class="table-card">
		<!-- Filter Row -->
		<div class="table-filters">
			<div class="filter-cell">
				<input type="text" id="filterUserId" placeholder="Filter User ID" class="table-filter-input">
				<div class="filter-count" id="countUserId">-</div>
			</div>
			<div class="filter-cell">
				<input type="text" id="filterUsername" placeholder="Filter Username" class="table-filter-input">
				<div class="filter-count" id="countUsername">-</div>
			</div>
			<div class="filter-cell">
				<input type="text" id="filterName" placeholder="Filter Name" class="table-filter-input">
				<div class="filter-count" id="countName">-</div>
			</div>
			<div class="filter-cell">
				<input type="text" id="filterEmail" placeholder="Filter Email" class="table-filter-input">
				<div class="filter-count" id="countEmail">-</div>
			</div>
			<div class="filter-cell">
				<select id="filterRole" class="table-filter-select">
					<option value="">All Roles</option>
					<option value="SuperAdmin">Super Admin</option>
					<option value="Admin">Admin</option>
					<option value="Teacher">Teacher</option>
					<option value="Staff">Staff</option>
					<option value="Student">Student</option>
				</select>
				<div class="filter-count" id="countRole">-</div>
			</div>
			<div class="filter-cell">
				<select id="filterStatus" class="table-filter-select">
					<option value="">All Status</option>
					<option value="Active">Active</option>
					<option value="Inactive">Inactive</option>
				</select>
				<div class="filter-count" id="countStatus">-</div>
			</div>
			<div class="filter-cell">
				<input type="text" id="filterLastLogin" placeholder="Filter Last Login" class="table-filter-input">
				<div class="filter-count" id="countLastLogin">-</div>
			</div>
			<div class="filter-cell" style="display: flex; align-items: center; justify-content: center;">
				<button id="clearFilters" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">Clear</button>
			</div>
		</div>

		<!-- Users Table -->
		<table class="data-table" id="usersTable">
			<thead>
				<tr>
					<th>User ID</th>
					<th>Username</th>
					<th>Name</th>
					<th>Email</th>
					<th>Role</th>
					<th>Status</th>
					<th>Last Login</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody id="usersTableBody"></tbody>
		</table>
	</div>

	<!-- Add User Modal - Simplified version -->
	<div class="modal-overlay" id="userModal">
		<div class="modal-content">
			<div class="modal-header">
				<div class="modal-title" id="userModalTitle">
					<i class="fas fa-user-plus"></i>
					<span>Add New User</span>
				</div>
				<button class="modal-close" id="closeUserModal"><i class="fas fa-times"></i></button>
			</div>
			<div class="modal-tabs">
				<button class="modal-tab active" data-tab="details">
					<i class="fas fa-user"></i>
					<span>User Details</span>
				</button>
				<button class="modal-tab" data-tab="modules">
					<i class="fas fa-th-large"></i>
					<span>Module Access</span>
				</button>
				<button class="modal-tab" data-tab="permissions">
					<i class="fas fa-shield-alt"></i>
					<span>Permissions</span>
				</button>
			</div>
			<div class="modal-body">
				<!-- Tab 1: User Details -->
				<div class="tab-section active" id="tabDetails">
					<div class="form-group">
						<label class="form-label">Full Name</label>
						<input type="text" class="form-input" id="userName" placeholder="Enter full name">
					</div>
					<div class="form-group">
						<label class="form-label">Username</label>
						<input type="text" class="form-input" id="userUsername" placeholder="Login username">
					</div>
					<div class="form-group">
						<label class="form-label">Email Address</label>
						<input type="email" class="form-input" id="userEmail" placeholder="Enter email">
					</div>
					<div class="form-group">
						<label class="form-label">Role</label>
						<select class="form-select" id="userRole">
							<option value="SuperAdmin">Super Admin</option>
							<option value="Admin">Admin</option>
							<option value="Teacher">Teacher</option>
							<option value="Staff">Staff</option>
						</select>
					</div>
					<div class="form-group">
						<label class="form-label">Password</label>
						<input type="password" class="form-input" id="userPassword" placeholder="Enter password (min 6 characters)">
					</div>
					<div class="form-group">
						<label class="form-label">Status</label>
						<select class="form-select" id="userStatus">
							<option value="Active">Active</option>
							<option value="Inactive">Inactive</option>
						</select>
					</div>
				</div>

				<!-- Tab 2: Module Access -->
				<div class="tab-section" id="tabModules">
					<div id="moduleAccessGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="dashboard">
							<span>Dashboard</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="students">
							<span>Students</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="teachers">
							<span>Teachers</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="attendance">
							<span>Attendance</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="exams">
							<span>Exams & Grades</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="timetable">
							<span>Timetable</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="fees">
							<span>Fees</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="library">
							<span>Library</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="transport">
							<span>Transport</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="hostel">
							<span>Hostel</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="reports">
							<span>Reports</span>
						</label>
						<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
							<input type="checkbox" class="module-toggle" value="settings">
							<span>Settings</span>
						</label>
					</div>
				</div>

				<!-- Tab 3: Permissions -->
				<div class="tab-section" id="tabPermissions">
					<div id="permissionTableBody" style="overflow-x: auto;">
						<table style="width: 100%; border-collapse: collapse;">
							<thead>
								<tr style="background: #f8fafc;">
									<th style="padding: 12px; text-align: left;">Module</th>
									<th style="padding: 12px; text-align: center;">View</th>
									<th style="padding: 12px; text-align: center;">Edit</th>
									<th style="padding: 12px; text-align: center;">Delete</th>
								</tr>
							</thead>
							<tbody id="permissionTableBody"></tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" id="cancelUserBtn">Cancel</button>
				<button class="btn btn-primary" id="saveUserBtn">Save User</button>
			</div>
		</div>
	</div>

	<script>
		// ==================== TOAST NOTIFICATION ====================
		function notify(msg, type = 'success') {
			document.querySelectorAll('.toast').forEach(t => t.remove());
			const toast = document.createElement('div');
			const bg = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#374151';
			const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
			toast.style.cssText = `position:fixed;bottom:30px;right:30px;padding:16px 24px;background:${bg};color:white;border-radius:12px;font-weight:600;font-size:14px;box-shadow:0 10px 40px rgba(0,0,0,0.25);z-index:10000;display:flex;align-items:center;gap:10px;animation:slideIn 0.4s ease;font-family:'Segoe UI',sans-serif;`;
			toast.innerHTML = `<i class="fas fa-${icon}"></i> ${msg}`;
			toast.className = 'toast';
			document.body.appendChild(toast);
			if (!document.getElementById('toastStyle')) {
				const s = document.createElement('style');
				s.id = 'toastStyle';
				s.textContent = `@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}`;
				document.head.appendChild(s);
			}
			setTimeout(() => { toast.style.transition = 'all 0.3s'; toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
		}

		// ==================== DATA FUNCTIONS ====================
		const load = key => { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) { return []; } };
		const save = (key, data) => localStorage.setItem(key, JSON.stringify(data));
		const loadUsers = () => load('edu_users');
		const saveUsers = data => save('edu_users', data);

		// Get current user role
		let currentRoleKey = 'superadmin';
		try {
			const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
			currentRoleKey = (currentUser.role || 'superadmin').toLowerCase();
		} catch(e) {}

		// ==================== MODULE DEFINITIONS ====================
		const MODULE_DEFINITIONS = [
			{ key: 'dashboard', label: 'Dashboard' },
			{ key: 'students', label: 'Students' },
			{ key: 'teachers', label: 'Teachers' },
			{ key: 'attendance', label: 'Attendance' },
			{ key: 'exams', label: 'Exams & Grades' },
			{ key: 'timetable', label: 'Timetable' },
			{ key: 'fees', label: 'Fees' },
			{ key: 'library', label: 'Library' },
			{ key: 'transport', label: 'Transport' },
			{ key: 'hostel', label: 'Hostel' },
			{ key: 'reports', label: 'Reports & Analytics' },
			{ key: 'settings', label: 'Settings' }
		];

		const ROLE_DEFAULT_PERMISSIONS = {
			SuperAdmin: MODULE_DEFINITIONS.reduce((acc, m) => {
				acc[m.key] = { view: true, edit: true, delete: true };
				return acc;
			}, {}),
			Admin: {
				dashboard:  { view: true, edit: false, delete: false },
				students:   { view: true, edit: true,  delete: true },
				teachers:   { view: true, edit: true,  delete: false },
				attendance: { view: true, edit: true,  delete: false },
				exams:      { view: true, edit: true,  delete: false },
				timetable:  { view: true, edit: true,  delete: false },
				fees:       { view: true, edit: true,  delete: false },
				library:    { view: true, edit: true,  delete: false },
				transport:  { view: true, edit: true,  delete: false },
				hostel:     { view: true, edit: true,  delete: false },
				reports:    { view: true, edit: false, delete: false },
				settings:   { view: true, edit: true,  delete: false }
			},
			Teacher: {
				dashboard:  { view: true, edit: false, delete: false },
				students:   { view: true, edit: false, delete: false },
				attendance: { view: true, edit: true,  delete: false },
				exams:      { view: true, edit: true,  delete: false },
				timetable:  { view: true, edit: false, delete: false },
				reports:    { view: true, edit: false, delete: false }
			},
			Staff: {
				dashboard: { view: true, edit: false, delete: false },
				students:  { view: true, edit: true,  delete: false },
				fees:      { view: true, edit: true,  delete: false },
				library:   { view: true, edit: false, delete: false },
				reports:   { view: true, edit: false, delete: false }
			}
		};

		// ==================== INITIALIZE DEMO DATA ====================
		function initDemoData() {
			if (loadUsers().length === 0) {
				const demoUsers = [
					{
						id: 'USR000',
						name: 'Super Admin',
						username: 'superadmin',
						email: 'superadmin@edumanage.edu',
						role: 'SuperAdmin',
						status: 'Active',
						password: 'super@123',
						lastLogin: 'â€“',
						permissions: ROLE_DEFAULT_PERMISSIONS['SuperAdmin']
					},
					{
						id: 'USR001',
						name: 'School Admin',
						username: 'admin',
						email: 'admin@edumanage.edu',
						role: 'Admin',
						status: 'Active',
						password: 'admin123',
						lastLogin: '2025-11-29 10:30',
						permissions: ROLE_DEFAULT_PERMISSIONS['Admin']
					},
					{
						id: 'USR002',
						name: 'Priya Sharma',
						username: 'teacher1',
						email: 'priya@edumanage.edu',
						role: 'Teacher',
						status: 'Active',
						password: 'teacher123',
						lastLogin: '2025-11-28 09:15',
						permissions: ROLE_DEFAULT_PERMISSIONS['Teacher']
					}
				];
				saveUsers(demoUsers);
			}
		}

		// ==================== RENDER USERS ====================
		let allUsersData = [];
		let filteredUsersData = [];
		let editingUserId = null;

		function renderUsers(filteredUsers = null) {
			const users = filteredUsers || loadUsers();
			allUsersData = loadUsers();
			filteredUsersData = users;
			
			const admins = users.filter(u => u.role === 'Admin' || u.role === 'SuperAdmin').length;
			const teachers = users.filter(u => u.role === 'Teacher').length;
			const staff = users.filter(u => u.role === 'Staff').length;
			const studentsData = load('edu_students');
			const studentsCount = Math.max(users.filter(u => u.role === 'Student').length, studentsData.length);

			document.getElementById('totalUsersCount').textContent = users.length;
			document.getElementById('studentsCount').textContent = studentsCount;
			document.getElementById('adminCount').textContent = admins;
			document.getElementById('teacherCount').textContent = teachers;
			document.getElementById('staffCount').textContent = staff;

			if (users.length === 0) {
				document.getElementById('usersTableBody').innerHTML = `
					<tr>
						<td colspan="8" style="text-align:center;padding:60px 20px;">
							<div style="display:flex;flex-direction:column;align-items:center;gap:16px;">
								<div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);display:flex;align-items:center;justify-content:center;">
									<i class="fas fa-users" style="font-size:32px;color:#94a3b8;"></i>
								</div>
								<div>
									<h3 style="margin:0;color:#475569;font-size:18px;font-weight:700;">No Users Found</h3>
									<p style="margin:8px 0 0;color:#94a3b8;font-size:14px;">Click "Add User" to create your first user</p>
								</div>
							</div>
						</td>
					</tr>
				`;
				return;
			}

			document.getElementById('usersTableBody').innerHTML = users.map(u => {
				let role = u.role || 'Staff';
				let status = u.status || 'Active';
				status = (status === 'Active' || status === 'active') ? 'Active' : 'Inactive';
				const initials = u.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
				const roleLower = role.toLowerCase();
				const statusLower = status.toLowerCase();
				
				return `
					<tr>
						<td>
							<div style="display:flex;align-items:center;">
								<div class="user-avatar" style="background:linear-gradient(135deg,#667eea,#764ba2);">${initials}</div>
								<span style="font-weight:600;">${u.id}</span>
							</div>
						</td>
						<td>${u.username || '-'}</td>
						<td>${u.name}</td>
						<td>${u.email}</td>
						<td><span class="role-badge ${roleLower}">${role}</span></td>
						<td><span class="status-badge ${statusLower}">${status}</span></td>
						<td>${u.lastLogin || '-'}</td>
						<td>
							<div class="action-btn-group">
								${role === 'SuperAdmin' ? '' : `
									<button class="action-btn view" title="${status === 'Active' ? 'Disable' : 'Activate'}" onclick="toggleUserStatus('${u.id}')">
										<i class="fas fa-power-off"></i>
									</button>
								`}
								<button class="action-btn edit" onclick="editUser('${u.id}')" title="Edit">
									<i class="fas fa-edit"></i>
								</button>
								${role === 'SuperAdmin' ? '' : `
									<button class="action-btn delete" onclick="deleteUser('${u.id}')" title="Delete">
										<i class="fas fa-trash"></i>
									</button>
								`}
							</div>
						</td>
					</tr>
				`;
			}).join('');
		}

		// ==================== PERMISSIONS ====================
		let currentEnabledModules = [];

		function renderPermissionTable(currentPerms = {}, roleForDefaults = 'Admin') {
			const body = document.getElementById('permissionTableBody');
			if (!body) return;

			const toggles = Array.from(document.querySelectorAll('.module-toggle'));
			const selectedFromUI = toggles.filter(cb => cb.checked).map(cb => cb.value);
			currentEnabledModules = selectedFromUI;

			const roleDefaults = ROLE_DEFAULT_PERMISSIONS[roleForDefaults] || {};
			body.innerHTML = MODULE_DEFINITIONS
				.filter(m => currentEnabledModules.includes(m.key))
				.map(m => {
					const base = currentPerms[m.key] || roleDefaults[m.key] || { view: false, edit: false, delete: false };
					return `
						<tr>
							<td style="padding:12px;">${m.label}</td>
							<td style="text-align:center;padding:12px;"><input type="checkbox" class="perm-view" ${base.view ? 'checked' : ''}></td>
							<td style="text-align:center;padding:12px;"><input type="checkbox" class="perm-edit" ${base.edit ? 'checked' : ''}></td>
							<td style="text-align:center;padding:12px;"><input type="checkbox" class="perm-delete" ${base.delete ? 'checked' : ''}></td>
						</tr>
					`;
				}).join('');
		}

		function collectPermissionsFromUI() {
			const body = document.getElementById('permissionTableBody');
			const perms = {};
			if (!body) return perms;
			body.querySelectorAll('tr').forEach((row, idx) => {
				const moduleKey = currentEnabledModules[idx];
				if (!moduleKey) return;
				const view = row.querySelector('.perm-view')?.checked || false;
				const edit = row.querySelector('.perm-edit')?.checked || false;
				const del = row.querySelector('.perm-delete')?.checked || false;
				if (view || edit || del) {
					perms[moduleKey] = { view, edit, delete: del };
				}
			});
			return perms;
		}

		// ==================== MODAL TABS ====================
		document.querySelectorAll('.modal-tab').forEach(tab => {
			tab.addEventListener('click', () => {
				document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
				document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
				tab.classList.add('active');
				const tabId = tab.dataset.tab;
				document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
				
				if (tabId === 'permissions') {
					const role = document.getElementById('userRole').value;
					const currentPerms = editingUserId ? (loadUsers().find(u => u.id === editingUserId)?.permissions || {}) : {};
					renderPermissionTable(currentPerms, role);
				}
			});
		});

		// Update permissions when modules change
		document.querySelectorAll('.module-toggle').forEach(toggle => {
			toggle.addEventListener('change', () => {
				if (document.querySelector('.modal-tab[data-tab="permissions"]').classList.contains('active')) {
					const role = document.getElementById('userRole').value;
					const currentPerms = editingUserId ? (loadUsers().find(u => u.id === editingUserId)?.permissions || {}) : {};
					renderPermissionTable(currentPerms, role);
				}
			});
		});

		// Update permissions when role changes
		document.getElementById('userRole').addEventListener('change', () => {
			if (document.querySelector('.modal-tab[data-tab="permissions"]').classList.contains('active')) {
				const role = document.getElementById('userRole').value;
				const currentPerms = editingUserId ? (loadUsers().find(u => u.id === editingUserId)?.permissions || {}) : {};
				renderPermissionTable(currentPerms, role);
			}
		});

		// ==================== MODAL CONTROLS ====================
		document.getElementById('addUserBtn').addEventListener('click', () => {
			editingUserId = null;
			document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus"></i><span>Add New User</span>';
			document.getElementById('userName').value = '';
			document.getElementById('userUsername').value = '';
			document.getElementById('userEmail').value = '';
			document.getElementById('userRole').value = 'Admin';
			document.getElementById('userPassword').value = '';
			document.getElementById('userStatus').value = 'Active';
			document.querySelectorAll('.module-toggle').forEach(cb => cb.checked = false);
			document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
			document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
			document.querySelector('.modal-tab[data-tab="details"]').classList.add('active');
			document.getElementById('tabDetails').classList.add('active');
			document.getElementById('userModal').classList.add('active');
		});

		document.getElementById('closeUserModal').addEventListener('click', () => {
			document.getElementById('userModal').classList.remove('active');
		});

		document.getElementById('cancelUserBtn').addEventListener('click', () => {
			document.getElementById('userModal').classList.remove('active');
		});

		window.editUser = function(id) {
			const users = loadUsers();
			const user = users.find(u => u.id === id);
			if (user) {
				if (currentRoleKey !== 'superadmin') {
					notify('Only Super Admin can edit users.', 'error');
					return;
				}
				editingUserId = id;
				document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-edit"></i><span>Edit User</span>';
				document.getElementById('userName').value = user.name;
				document.getElementById('userUsername').value = user.username || '';
				document.getElementById('userEmail').value = user.email;
				document.getElementById('userRole').value = user.role;
				document.getElementById('userStatus').value = user.status;
				document.getElementById('userPassword').value = '';
				
				// Set module toggles
				const userModules = user.permissions ? Object.keys(user.permissions) : [];
				document.querySelectorAll('.module-toggle').forEach(cb => {
					cb.checked = userModules.includes(cb.value);
				});
				
				// Reset to first tab
				document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
				document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
				document.querySelector('.modal-tab[data-tab="details"]').classList.add('active');
				document.getElementById('tabDetails').classList.add('active');
				
				document.getElementById('userModal').classList.add('active');
			}
		};

		document.getElementById('saveUserBtn').addEventListener('click', () => {
			const name = document.getElementById('userName').value.trim();
			const username = document.getElementById('userUsername').value.trim();
			const email = document.getElementById('userEmail').value.trim();
			const role = document.getElementById('userRole').value;
			const password = document.getElementById('userPassword').value;
			const status = document.getElementById('userStatus').value;

			if (!name || !username || !email) {
				notify('Please fill in name, username and email.', 'error');
				return;
			}
			if (!editingUserId && (!password || password.length < 6)) {
				notify('Password must be at least 6 characters.', 'error');
				return;
			}

			const enabledModules = Array.from(document.querySelectorAll('.module-toggle'))
				.filter(cb => cb.checked)
				.map(cb => cb.value);
			
			if (enabledModules.length === 0) {
				notify('Please select at least one module.', 'error');
				return;
			}

			// Render permissions table to get current state
			if (document.querySelector('.modal-tab[data-tab="permissions"]').classList.contains('active')) {
				const currentPerms = editingUserId ? (loadUsers().find(u => u.id === editingUserId)?.permissions || {}) : {};
				renderPermissionTable(currentPerms, role);
			}
			const permissions = collectPermissionsFromUI();

			if (Object.keys(permissions).length === 0) {
				notify('Please set at least one permission.', 'error');
				return;
			}

			let users = loadUsers();

			if (editingUserId) {
				const idx = users.findIndex(u => u.id === editingUserId);
				if (idx !== -1) {
					users[idx].name = name;
					users[idx].username = username;
					users[idx].email = email;
					users[idx].role = role;
					users[idx].status = status;
					if (password) users[idx].password = password;
					users[idx].permissions = permissions;
					notify('User updated successfully!', 'success');
				}
			} else {
				const newUser = {
					id: 'USR' + String(users.length + 1).padStart(3, '0'),
					name,
					username,
					email,
					role,
					status,
					password,
					permissions,
					lastLogin: '-'
				};
				users.push(newUser);
				notify('User added successfully!', 'success');
			}
			saveUsers(users);
			renderUsers();
			document.getElementById('userModal').classList.remove('active');
		});

		window.toggleUserStatus = function(id) {
			const users = loadUsers();
			const idx = users.findIndex(u => u.id === id);
			if (idx === -1) return;

			const user = users[idx];
			if (user.role === 'SuperAdmin') {
				notify('Super Admin cannot be disabled.', 'error');
				return;
			}

			user.status = user.status === 'Active' ? 'Inactive' : 'Active';
			users[idx] = user;
			saveUsers(users);
			renderUsers();
			notify(`User ${user.status === 'Active' ? 'activated' : 'disabled'} successfully.`, 'success');
		};

		window.deleteUser = function(id) {
			if (currentRoleKey !== 'superadmin') {
				notify('Only Super Admin can delete users.', 'error');
				return;
			}
			if (confirm('Are you sure you want to delete this user?')) {
				let users = loadUsers();
				const userToDelete = users.find(u => u.id === id);
				if (userToDelete && userToDelete.role === 'SuperAdmin') {
					notify('Super Admin account cannot be deleted.', 'error');
					return;
				}
				users = users.filter(u => u.id !== id);
				saveUsers(users);
				renderUsers();
				notify('User deleted successfully!', 'success');
			}
		};

		// ==================== FILTERS ====================
		function updateFilterCounts(users, userIdFilter, usernameFilter, nameFilter, emailFilter, roleFilter, statusFilter, lastLoginFilter) {
			const allUsers = loadUsers();
			
			const countUserId = allUsers.filter(u => !userIdFilter || u.id.toLowerCase().includes(userIdFilter.toLowerCase())).length;
			const countUsername = allUsers.filter(u => !usernameFilter || (u.username && u.username.toLowerCase().includes(usernameFilter.toLowerCase()))).length;
			const countName = allUsers.filter(u => !nameFilter || u.name.toLowerCase().includes(nameFilter.toLowerCase())).length;
			const countEmail = allUsers.filter(u => !emailFilter || u.email.toLowerCase().includes(emailFilter.toLowerCase())).length;
			const countRole = allUsers.filter(u => !roleFilter || u.role === roleFilter).length;
			const countStatus = allUsers.filter(u => !statusFilter || u.status === statusFilter).length;
			const countLastLogin = allUsers.filter(u => !lastLoginFilter || (u.lastLogin && u.lastLogin.toLowerCase().includes(lastLoginFilter.toLowerCase()))).length;
			
			document.getElementById('countUserId').textContent = userIdFilter ? `${countUserId}` : '-';
			document.getElementById('countUsername').textContent = usernameFilter ? `${countUsername}` : '-';
			document.getElementById('countName').textContent = nameFilter ? `${countName}` : '-';
			document.getElementById('countEmail').textContent = emailFilter ? `${countEmail}` : '-';
			document.getElementById('countRole').textContent = roleFilter ? `${countRole}` : '-';
			document.getElementById('countStatus').textContent = statusFilter ? `${countStatus}` : '-';
			document.getElementById('countLastLogin').textContent = lastLoginFilter ? `${countLastLogin}` : '-';
		}

		const filterUserId = document.getElementById('filterUserId');
		const filterUsername = document.getElementById('filterUsername');
		const filterName = document.getElementById('filterName');
		const filterEmail = document.getElementById('filterEmail');
		const filterRole = document.getElementById('filterRole');
		const filterStatus = document.getElementById('filterStatus');
		const filterLastLogin = document.getElementById('filterLastLogin');
		const clearFiltersBtn = document.getElementById('clearFilters');

		const applyFilters = () => {
			const userIdFilter = filterUserId.value.trim();
			const usernameFilter = filterUsername.value.trim();
			const nameFilter = filterName.value.trim();
			const emailFilter = filterEmail.value.trim();
			const roleFilter = filterRole.value;
			const statusFilter = filterStatus.value;
			const lastLoginFilter = filterLastLogin.value.trim();
			
			const allUsers = loadUsers();
			let filtered = allUsers;
			
			if (userIdFilter) filtered = filtered.filter(u => u.id.toLowerCase().includes(userIdFilter.toLowerCase()));
			if (usernameFilter) filtered = filtered.filter(u => u.username && u.username.toLowerCase().includes(usernameFilter.toLowerCase()));
			if (nameFilter) filtered = filtered.filter(u => u.name.toLowerCase().includes(nameFilter.toLowerCase()));
			if (emailFilter) filtered = filtered.filter(u => u.email.toLowerCase().includes(emailFilter.toLowerCase()));
			if (roleFilter) filtered = filtered.filter(u => u.role === roleFilter);
			if (statusFilter) filtered = filtered.filter(u => u.status === statusFilter);
			if (lastLoginFilter) filtered = filtered.filter(u => u.lastLogin && u.lastLogin.toLowerCase().includes(lastLoginFilter.toLowerCase()));
			
			renderUsers(filtered);
			updateFilterCounts(allUsers, userIdFilter, usernameFilter, nameFilter, emailFilter, roleFilter, statusFilter, lastLoginFilter);
		};

		filterUserId.addEventListener('keyup', applyFilters);
		filterUsername.addEventListener('keyup', applyFilters);
		filterName.addEventListener('keyup', applyFilters);
		filterEmail.addEventListener('keyup', applyFilters);
		filterRole.addEventListener('change', applyFilters);
		filterStatus.addEventListener('change', applyFilters);
		filterLastLogin.addEventListener('keyup', applyFilters);

		if (clearFiltersBtn) {
			clearFiltersBtn.addEventListener('click', () => {
				filterUserId.value = '';
				filterUsername.value = '';
				filterName.value = '';
				filterEmail.value = '';
				filterRole.value = '';
				filterStatus.value = '';
				filterLastLogin.value = '';
				applyFilters();
			});
		}

		// ==================== INITIALIZE ====================
		initDemoData();
		renderUsers();
		updateFilterCounts(loadUsers(), '', '', '', '', '', '', '');
	</script>
</body>
</html>

